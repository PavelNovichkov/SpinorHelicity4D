(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    397075,       9318]
NotebookOptionsPosition[    375641,       8941]
NotebookOutlinePosition[    386337,       9148]
CellTagsIndexPosition[    386294,       9145]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell[BoxData[
 RowBox[{"<<", "SpinorHelicity4D`"}]], "Input",
 CellChangeTimes->{{3.846245086690741*^9, 3.8462450960548763`*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"d6fe2690-3bb1-4185-bbe3-4aaa9884d5a0"],

Cell[CellGroupData[{

Cell[BoxData["\<\"===============SpinorHelicity4D================\"\>"], \
"Print",
 CellChangeTimes->{3.8462460808281403`*^9, 3.8466675032347717`*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"b051dbcd-5b56-46f7-85df-1c8aa6229f67"],

Cell[BoxData["\<\"Author: Manuel Accettulli Huber (QMUL)\"\>"], "Print",
 CellChangeTimes->{3.8462460808281403`*^9, 3.84666750323715*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"1c148b9f-52be-4134-8adc-d6d4d634d1da"],

Cell[BoxData["\<\"Please report any bug to:\"\>"], "Print",
 CellChangeTimes->{3.8462460808281403`*^9, 3.8466675032393312`*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"e309b2f9-1fd1-4a78-a9a4-82369b7d1dd9"],

Cell[BoxData["\<\"m.accettullihuber@qmul.ac.uk\"\>"], "Print",
 CellChangeTimes->{3.8462460808281403`*^9, 3.846667503241022*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"170db4b4-8211-4507-89da-7de3a3fdb5ff"],

Cell[BoxData["\<\"Version 1.0 , last update 06/04/2021\"\>"], "Print",
 CellChangeTimes->{3.8462460808281403`*^9, 3.846667503244508*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"831272e8-ac68-47f2-ada4-75bb42c3a29d"],

Cell[BoxData[
 TemplateBox[{
  "\"Click here for full documentation\"", 
   "https://github.com/accettullihuber"},
  "HyperlinkURL"]], "Print",
 CellChangeTimes->{3.8462460808281403`*^9, 3.846667503299131*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"9eb8dea0-c0eb-4338-948f-cf4562a610cd"],

Cell[BoxData["\<\"=============================================\"\>"], "Print",
 CellChangeTimes->{3.8462460808281403`*^9, 3.846667503304658*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"b5f45e9a-a006-4fb5-a6ea-eb2cc8c54c0b"]
}, Open  ]]
}, Open  ]],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
  "First", " ", "group", " ", "together", " ", "all", " ", "the", " ", 
   "spinor", " ", "invariants", " ", "and", " ", "convert", " ", "them", " ", 
   "to", " ", "something", " ", "we", " ", "can", " ", "handle", " ", 
   RowBox[{"easier", ".", " ", "Then"}], " ", "we", " ", "package", " ", 
   "everything", " ", "appropriately"}], "*)"}]], "Input",
 CellChangeTimes->{{3.846245129976778*^9, 3.846245146487133*^9}, {
  3.846245602691909*^9, 
  3.846245643261817*^9}},ExpressionUUID->"02c4f47a-3eb8-4cd8-b56e-\
c8533ab5fc1c"],

Cell[CellGroupData[{

Cell["ToChain Old version, not working with options", "Subsection",
 CellChangeTimes->{{3.8565222663534584`*^9, 
  3.856522278690398*^9}},ExpressionUUID->"edf98337-ab27-47ed-b5f8-\
8f4cdbbd88f4"],

Cell[CellGroupData[{

Cell["toChainOld, fastest version but random chains", "Subsubsection",ExpressionUUID->"1671c2bc-3b8a-40cc-8ee2-4861c0d72a17"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"Old", " ", "version", " ", "of", " ", 
    RowBox[{"ToChain", ".", " ", "The"}], " ", "resulting", " ", "chain", " ",
     "might", " ", "not", " ", "be", " ", "minimal", " ", "or", " ", "of", 
    " ", "the", " ", "best", " ", "possible", " ", "form", " ", "but", " ", 
    "it", " ", "is", " ", "still", " ", "a", " ", "perfectly", " ", "viable", 
    " ", 
    RowBox[{"chain", ".", " ", "We"}], " ", "keep", " ", "this", " ", "as", 
    " ", "the", " ", "fastest", " ", 
    RowBox[{"version", "."}]}], "*)"}], "\n", "\n", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "toChainOld", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{"MinimalChains", "->", "True"}], "}"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"toChainOld", "[", 
      RowBox[{"exp_", ",", 
       RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "locexp", "}"}], ",", "\n", "\n", 
       RowBox[{
        RowBox[{"Block", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
           "ChainPow", ",", "SpinorAngleBracket", ",", "SpinorSquareBracket", 
            ",", "Chain"}], "}"}], ",", "\n", "\n", 
          RowBox[{"(*", 
           RowBox[{"ChainPow", " ", 
            RowBox[{"properties", ":"}]}], "*)"}], "\n", "\n", 
          RowBox[{"(*", "Basics", "*)"}], "\n", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"ChainPow", "[", "x__", "]"}], "[", "0", "]"}], ":=", 
            "1"}], ";", "\n", "\n", 
           RowBox[{"(*", 
            RowBox[{"SquareAngle", " ", "as", " ", "AngleSquare"}], "*)"}], 
           "\n", 
           RowBox[{
            RowBox[{
             RowBox[{"ChainPow", "[", 
              RowBox[{"$square", ",", "x_", ",", 
               RowBox[{"{", "y__", "}"}], ",", "z_", ",", "$angle"}], "]"}], 
             "[", "n_", "]"}], ":=", 
            RowBox[{
             RowBox[{"ChainPow", "[", 
              RowBox[{"$angle", ",", "z", ",", 
               RowBox[{"Reverse", "[", 
                RowBox[{"{", "y", "}"}], "]"}], ",", "x", ",", "$square"}], 
              "]"}], "[", "n", "]"}]}], ";", "\n", "\n", 
           RowBox[{"(*", 
            RowBox[{
            "The", " ", "actual", " ", "contraction", " ", "properties"}], 
            "*)"}], "\n", "\n", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
              RowBox[{" ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"x", "..."}], "y"}]}], "\[RightAngleBracket]"}], "[", 
              RowBox[{
               RowBox[{"y", "..."}], "z"}]}], ")"}], " ", "*)"}], "\n", 
           RowBox[{"ChainPow", " ", "/:", " ", 
            RowBox[{"Times", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"type1_", ",", "x_", ",", 
                 RowBox[{"{", "k___", "}"}], ",", "y_", ",", "$angle"}], 
                "]"}], "[", 
               RowBox[{"n_", "?", "Positive"}], "]"}], ",", 
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"$square", ",", "y_", ",", 
                 RowBox[{"{", "q___", "}"}], ",", "z_", ",", "type2_"}], 
                "]"}], "[", 
               RowBox[{"m_", "?", "Positive"}], "]"}]}], "]"}], ":=", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"n", ">=", "m"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{"k", ",", "y", ",", "q"}], "}"}], ",", "z", ",", 
                  "type2"}], "]"}], "[", "m", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", "k", "}"}], ",", "y", ",", "$angle"}], "]"}], 
                "[", 
                RowBox[{"n", "-", "m"}], "]"}]}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{"k", ",", "y", ",", "q"}], "}"}], ",", "z", ",", 
                  "type2"}], "]"}], "[", "n", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"$square", ",", "y", ",", 
                  RowBox[{"{", "q", "}"}], ",", "z", ",", "type2"}], "]"}], 
                "[", 
                RowBox[{"m", "-", "n"}], "]"}]}]}], "\n", "]"}]}], ";", "\n", 
           "\n", 
           RowBox[{"ChainPow", " ", "/:", " ", 
            RowBox[{"Times", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"type1_", ",", "x_", ",", 
                 RowBox[{"{", "k___", "}"}], ",", "y_", ",", "$angle"}], 
                "]"}], "[", 
               RowBox[{"n_", "?", "Negative"}], "]"}], ",", 
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"$square", ",", "y_", ",", 
                 RowBox[{"{", "q___", "}"}], ",", "z_", ",", "type2_"}], 
                "]"}], "[", 
               RowBox[{"m_", "?", "Negative"}], "]"}]}], "]"}], ":=", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"n", "<=", "m"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{"k", ",", "y", ",", "q"}], "}"}], ",", "z", ",", 
                  "type2"}], "]"}], "[", "m", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", "k", "}"}], ",", "y", ",", "$angle"}], "]"}], 
                "[", 
                RowBox[{"n", "-", "m"}], "]"}]}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{"k", ",", "y", ",", "q"}], "}"}], ",", "z", ",", 
                  "type2"}], "]"}], "[", "n", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"$square", ",", "y", ",", 
                  RowBox[{"{", "q", "}"}], ",", "z", ",", "type2"}], "]"}], 
                "[", 
                RowBox[{"m", "-", "n"}], "]"}]}]}], "\n", "]"}]}], ";", "\n", 
           "\n", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"\[LeftAngleBracket]", 
                RowBox[{
                 RowBox[{"y", "..."}], "x"}]}], ")"}], "[", 
              RowBox[{
               RowBox[{"y", "..."}], "z"}]}], ")"}], " ", "*)"}], "\n", 
           RowBox[{"ChainPow", " ", "/:", " ", 
            RowBox[{"Times", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"$angle", ",", "y_", ",", 
                 RowBox[{"{", "k___", "}"}], ",", "x_", ",", "type1_"}], 
                "]"}], "[", 
               RowBox[{"n_", "?", "Positive"}], "]"}], ",", 
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"$square", ",", "y_", ",", 
                 RowBox[{"{", "q___", "}"}], ",", "z_", ",", "type2_"}], 
                "]"}], "[", 
               RowBox[{"m_", "?", "Positive"}], "]"}]}], "]"}], ":=", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"n", ">=", "m"}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", "1"}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{"m", "*", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "k", "}"}], "]"}], "+", "1"}], ")"}]}], 
                 ")"}]}], "*", 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "[", 
                    RowBox[{"{", "k", "}"}], "]"}]}], ",", "y", ",", "q"}], 
                   "}"}], ",", "z", ",", "type2"}], "]"}], "[", "m", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"$angle", ",", "y", ",", 
                  RowBox[{"{", "k", "}"}], ",", "x", ",", "type1"}], "]"}], 
                "[", 
                RowBox[{"n", "-", "m"}], "]"}]}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", "1"}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{"n", "*", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "k", "}"}], "]"}], "+", "1"}], ")"}]}], 
                 ")"}]}], "*", 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "[", 
                    RowBox[{"{", "k", "}"}], "]"}]}], ",", "y", ",", "q"}], 
                   "}"}], ",", "z", ",", "type2"}], "]"}], "[", "n", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"$square", ",", "y", ",", 
                  RowBox[{"{", "q", "}"}], ",", "z", ",", "type2"}], "]"}], 
                "[", 
                RowBox[{"m", "-", "n"}], "]"}]}]}], "\n", "]"}]}], ";", "\n", 
           "\n", 
           RowBox[{"ChainPow", " ", "/:", " ", 
            RowBox[{"Times", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"$angle", ",", "y_", ",", 
                 RowBox[{"{", "k___", "}"}], ",", "x_", ",", "type1_"}], 
                "]"}], "[", 
               RowBox[{"n_", "?", "Negative"}], "]"}], ",", 
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"$square", ",", "y_", ",", 
                 RowBox[{"{", "q___", "}"}], ",", "z_", ",", "type2_"}], 
                "]"}], "[", 
               RowBox[{"m_", "?", "Negative"}], "]"}]}], "]"}], ":=", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"n", "<=", "m"}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", "1"}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{"m", "*", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "k", "}"}], "]"}], "+", "1"}], ")"}]}], 
                 ")"}]}], "*", 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "[", 
                    RowBox[{"{", "k", "}"}], "]"}]}], ",", "y", ",", "q"}], 
                   "}"}], ",", "z", ",", "type2"}], "]"}], "[", "m", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"$angle", ",", "y", ",", 
                  RowBox[{"{", "k", "}"}], ",", "x", ",", "type1"}], "]"}], 
                "[", 
                RowBox[{"n", "-", "m"}], "]"}]}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", "1"}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{"n", "*", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "k", "}"}], "]"}], "+", "1"}], ")"}]}], 
                 ")"}]}], "*", 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "[", 
                    RowBox[{"{", "k", "}"}], "]"}]}], ",", "y", ",", "q"}], 
                   "}"}], ",", "z", ",", "type2"}], "]"}], "[", "n", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"$square", ",", "y", ",", 
                  RowBox[{"{", "q", "}"}], ",", "z", ",", "type2"}], "]"}], 
                "[", 
                RowBox[{"m", "-", "n"}], "]"}]}]}], "\n", "]"}]}], ";", "\n", 
           "\n", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"x", "..."}], "y"}]}], "\[RightAngleBracket]"}], "[", 
              RowBox[{
               RowBox[{"y", "..."}], "z"}]}], ")"}], "*)"}], "\n", 
           RowBox[{"ChainPow", " ", "/:", " ", 
            RowBox[{"Times", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"type1_", ",", "x_", ",", 
                 RowBox[{"{", "k___", "}"}], ",", "y_", ",", "$angle"}], 
                "]"}], "[", 
               RowBox[{"n_", "?", "Positive"}], "]"}], ",", 
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"type2_", ",", "z_", ",", 
                 RowBox[{"{", "q___", "}"}], ",", "y_", ",", "$square"}], 
                "]"}], "[", 
               RowBox[{"m_", "?", "Positive"}], "]"}]}], "]"}], ":=", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"n", ">=", "m"}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", "1"}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{"m", "*", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "q", "}"}], "]"}], "+", "1"}], ")"}]}], 
                 ")"}]}], "*", 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{"k", ",", "y", ",", 
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "[", 
                    RowBox[{"{", "q", "}"}], "]"}]}]}], "}"}], ",", "z", ",", 
                  "type2"}], "]"}], "[", "m", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", "k", "}"}], ",", "y", ",", "$angle"}], "]"}], 
                "[", 
                RowBox[{"n", "-", "m"}], "]"}]}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", "1"}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{"n", "*", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "q", "}"}], "]"}], "+", "1"}], ")"}]}], 
                 ")"}]}], "*", 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{"k", ",", "y", ",", 
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "[", 
                    RowBox[{"{", "q", "}"}], "]"}]}]}], "}"}], ",", "z", ",", 
                  "type2"}], "]"}], "[", "n", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type2", ",", "z", ",", 
                  RowBox[{"{", "q", "}"}], ",", "y", ",", "$square"}], "]"}], 
                "[", 
                RowBox[{"m", "-", "n"}], "]"}]}]}], "\n", "]"}]}], ";", "\n", 
           "\n", 
           RowBox[{"ChainPow", " ", "/:", " ", 
            RowBox[{"Times", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"type1_", ",", "x_", ",", 
                 RowBox[{"{", "k___", "}"}], ",", "y_", ",", "$angle"}], 
                "]"}], "[", 
               RowBox[{"n_", "?", "Negative"}], "]"}], ",", 
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"type2_", ",", "z_", ",", 
                 RowBox[{"{", "q___", "}"}], ",", "y_", ",", "$square"}], 
                "]"}], "[", 
               RowBox[{"m_", "?", "Negative"}], "]"}]}], "]"}], ":=", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"n", "<=", "m"}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", "1"}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{"m", "*", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "q", "}"}], "]"}], "+", "1"}], ")"}]}], 
                 ")"}]}], "*", 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{"k", ",", "y", ",", 
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "[", 
                    RowBox[{"{", "q", "}"}], "]"}]}]}], "}"}], ",", "z", ",", 
                  "type2"}], "]"}], "[", "m", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", "k", "}"}], ",", "y", ",", "$angle"}], "]"}], 
                "[", 
                RowBox[{"n", "-", "m"}], "]"}]}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", "1"}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{"n", "*", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "q", "}"}], "]"}], "+", "1"}], ")"}]}], 
                 ")"}]}], "*", 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type1", ",", "x", ",", 
                  RowBox[{"{", 
                   RowBox[{"k", ",", "y", ",", 
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "[", 
                    RowBox[{"{", "q", "}"}], "]"}]}]}], "}"}], ",", "z", ",", 
                  "type2"}], "]"}], "[", "n", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type2", ",", "z", ",", 
                  RowBox[{"{", "q", "}"}], ",", "y", ",", "$square"}], "]"}], 
                "[", 
                RowBox[{"m", "-", "n"}], "]"}]}]}], "\n", "]"}]}], ";", "\n", 
           "\n", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
              RowBox[{" ", 
               RowBox[{"\[LeftAngleBracket]", 
                RowBox[{
                 RowBox[{"y", "..."}], "x"}]}], ")"}], 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"z", "..."}], "y"}]}]}], "]"}], " ", "*)"}], "\n", 
           RowBox[{"ChainPow", " ", "/:", " ", 
            RowBox[{"Times", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"$angle", ",", "y_", ",", 
                 RowBox[{"{", "k___", "}"}], ",", "x_", ",", "type1_"}], 
                "]"}], "[", 
               RowBox[{"n_", "?", "Positive"}], "]"}], ",", 
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"type2_", ",", "z_", ",", 
                 RowBox[{"{", "q___", "}"}], ",", "y_", ",", "$square"}], 
                "]"}], "[", 
               RowBox[{"m_", "?", "Positive"}], "]"}]}], "]"}], ":=", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"n", ">=", "m"}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type2", ",", "z", ",", 
                  RowBox[{"{", 
                   RowBox[{"q", ",", "y", ",", "k"}], "}"}], ",", "x", ",", 
                  "type1"}], "]"}], "[", "m", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"$angle", ",", "y", ",", 
                  RowBox[{"{", "k", "}"}], ",", "x", ",", "type1"}], "]"}], 
                "[", 
                RowBox[{"n", "-", "m"}], "]"}]}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type2", ",", "z", ",", 
                  RowBox[{"{", 
                   RowBox[{"q", ",", "y", ",", "k"}], "}"}], ",", "x", ",", 
                  "type1"}], "]"}], "[", "n", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type2", ",", "z", ",", 
                  RowBox[{"{", "q", "}"}], ",", "y", ",", "$square"}], "]"}], 
                "[", 
                RowBox[{"m", "-", "n"}], "]"}]}]}], "\n", "]"}]}], ";", "\n", 
           "\n", 
           RowBox[{"ChainPow", " ", "/:", " ", 
            RowBox[{"Times", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"$angle", ",", "y_", ",", 
                 RowBox[{"{", "k___", "}"}], ",", "x_", ",", "type1_"}], 
                "]"}], "[", 
               RowBox[{"n_", "?", "Negative"}], "]"}], ",", 
              RowBox[{
               RowBox[{"ChainPow", "[", 
                RowBox[{"type2_", ",", "z_", ",", 
                 RowBox[{"{", "q___", "}"}], ",", "y_", ",", "$square"}], 
                "]"}], "[", 
               RowBox[{"m_", "?", "Negative"}], "]"}]}], "]"}], ":=", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"n", "<=", "m"}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type2", ",", "z", ",", 
                  RowBox[{"{", 
                   RowBox[{"q", ",", "y", ",", "k"}], "}"}], ",", "x", ",", 
                  "type1"}], "]"}], "[", "m", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"$angle", ",", "y", ",", 
                  RowBox[{"{", "k", "}"}], ",", "x", ",", "type1"}], "]"}], 
                "[", 
                RowBox[{"n", "-", "m"}], "]"}]}], ",", "\n", 
              RowBox[{
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type2", ",", "z", ",", 
                  RowBox[{"{", 
                   RowBox[{"q", ",", "y", ",", "k"}], "}"}], ",", "x", ",", 
                  "type1"}], "]"}], "[", "n", "]"}], 
               RowBox[{
                RowBox[{"ChainPow", "[", 
                 RowBox[{"type2", ",", "z", ",", 
                  RowBox[{"{", "q", "}"}], ",", "y", ",", "$square"}], "]"}], 
                "[", 
                RowBox[{"m", "-", "n"}], "]"}]}]}], "\n", "]"}]}], ";", "\n", 
           "\n", 
           RowBox[{"(*", 
            RowBox[{
            "Applying", " ", "the", " ", "properties", " ", "to", " ", "the", 
             " ", "expression"}], "*)"}], "\n", 
           RowBox[{"(*", 
            RowBox[{
            "Convert", " ", "angle", " ", "and", " ", "square", " ", 
             "brackets", " ", "to", " ", "Chains", " ", "and", " ", "Chains", 
             " ", "to", " ", "ChainPow"}], "*)"}], "\n", 
           RowBox[{
            RowBox[{"SpinorAngleBracket", "[", 
             RowBox[{"x_", ",", "y_"}], "]"}], ":=", 
            RowBox[{"Chain", "[", 
             RowBox[{"$angle", ",", "x", ",", 
              RowBox[{"{", "}"}], ",", "y", ",", "$angle"}], "]"}]}], ";", 
           "\n", 
           RowBox[{
            RowBox[{"SpinorSquareBracket", "[", 
             RowBox[{"x_", ",", "y_"}], "]"}], ":=", 
            RowBox[{"Chain", "[", 
             RowBox[{"$square", ",", "x", ",", 
              RowBox[{"{", "}"}], ",", "y", ",", "$square"}], "]"}]}], ";", 
           "\n", 
           RowBox[{"ChainPow", " ", "/:", " ", 
            RowBox[{"Power", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ChainPow", "[", "x__", "]"}], "[", "p_", "]"}], ",", 
              "n_"}], "]"}], ":=", 
            RowBox[{
             RowBox[{"ChainPow", "[", "x", "]"}], "[", 
             RowBox[{"p", "*", "n"}], "]"}]}], ";", "\n", 
           RowBox[{
            RowBox[{"Chain", "[", "x__", "]"}], ":=", 
            RowBox[{
             RowBox[{"ChainPow", "[", "x", "]"}], "[", "1", "]"}]}], ";", 
           "\n", "\n", 
           RowBox[{"locexp", "=", "exp"}], ";", "\n", "\n", 
           RowBox[{"(*", 
            RowBox[{
            "Expand", " ", "part", " ", "of", " ", "the", " ", "expression", 
             " ", "containing", " ", "ChainPow", " ", "in", " ", "order", " ",
              "for", " ", "the", " ", "contractions", " ", "to", " ", 
             "happen"}], "*)"}], "\n", 
           RowBox[{"locexp", "=", 
            RowBox[{"Expand", "[", 
             RowBox[{"locexp", ",", "ChainPow"}], "]"}]}], ";"}]}], "\n", 
         "]"}], ";", "\n", "\n", 
        RowBox[{"Block", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"ChainPow", ",", "Chain"}], "}"}], ",", "\n", "\n", 
          RowBox[{"(*", 
           RowBox[{
           "Convert", " ", "back", " ", "to", " ", "angle", " ", "and", " ", 
            "square", " ", "brackets"}], "*)"}], "\n", 
          RowBox[{
           RowBox[{
            RowBox[{"Chain", "[", 
             RowBox[{"$angle", ",", "x_", ",", 
              RowBox[{"{", "}"}], ",", "y_", ",", "$angle"}], "]"}], ":=", 
            RowBox[{"SpinorAngleBracket", "[", 
             RowBox[{"x", ",", "y"}], "]"}]}], ";", "\n", 
           RowBox[{
            RowBox[{"Chain", "[", 
             RowBox[{"$square", ",", "x_", ",", 
              RowBox[{"{", "}"}], ",", "y_", ",", "$square"}], "]"}], ":=", 
            RowBox[{"SpinorSquareBracket", "[", 
             RowBox[{"x", ",", "y"}], "]"}]}], ";", "\n", 
           RowBox[{
            RowBox[{
             RowBox[{"ChainPow", "[", "x__", "]"}], "[", "n_", "]"}], ":=", 
            RowBox[{"Power", "[", 
             RowBox[{
              RowBox[{"Chain", "[", "x", "]"}], ",", "n"}], "]"}]}], ";", 
           "\n", 
           RowBox[{"locexp", "=", "locexp"}], ";"}]}], "\n", "]"}], ";", "\n",
         "\n", 
        RowBox[{"(*", 
         RowBox[{
         "Reduce", " ", "the", " ", "chains", " ", "to", " ", "minimal", " ", 
          "form", " ", "if", " ", "required"}], "*)"}], "\n", "\n", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"TrueQ", "[", 
           RowBox[{"OptionValue", "[", "MinimalChains", "]"}], "]"}], ",", 
          "\n", 
          RowBox[{
           RowBox[{"Block", "[", 
            RowBox[{
             RowBox[{"{", "Chain", "}"}], ",", "\n", 
             RowBox[{"(*", 
              RowBox[{
              "Splitting", " ", "chains", " ", "into", " ", "smaller", " ", 
               "chains"}], "*)"}], "\n", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"Chain", "[", 
                 RowBox[{"$angle", ",", "x_", ",", 
                  RowBox[{"{", 
                   RowBox[{"y___", ",", "x_", ",", "z___"}], "}"}], ",", "k_",
                   ",", "type2_"}], "]"}], "/;", 
                RowBox[{"OddQ", "[", 
                 RowBox[{"Length", "[", 
                  RowBox[{"{", "y", "}"}], "]"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Chain", "[", 
                 RowBox[{"$angle", ",", "x", ",", 
                  RowBox[{"{", "y", "}"}], ",", "x", ",", "$square"}], "]"}], 
                "*", 
                RowBox[{"Chain", "[", 
                 RowBox[{"$angle", ",", "x", ",", 
                  RowBox[{"{", "z", "}"}], ",", "k", ",", "type2"}], 
                 "]"}]}]}], ";", "\n", "\t", 
              RowBox[{
               RowBox[{
                RowBox[{"Chain", "[", 
                 RowBox[{"$square", ",", "x_", ",", 
                  RowBox[{"{", 
                   RowBox[{"y___", ",", "x_", ",", "z___"}], "}"}], ",", "k_",
                   ",", "type2_"}], "]"}], "/;", 
                RowBox[{"OddQ", "[", 
                 RowBox[{"Length", "[", 
                  RowBox[{"{", "y", "}"}], "]"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Chain", "[", 
                 RowBox[{"$square", ",", "x", ",", 
                  RowBox[{"{", "y", "}"}], ",", "x", ",", "$angle"}], "]"}], 
                "*", 
                RowBox[{"Chain", "[", 
                 RowBox[{"$square", ",", "x", ",", 
                  RowBox[{"{", "z", "}"}], ",", "k", ",", "type2"}], 
                 "]"}]}]}], ";", "\n", "\t", 
              RowBox[{
               RowBox[{
                RowBox[{"Chain", "[", 
                 RowBox[{"type1_", ",", "k_", ",", 
                  RowBox[{"{", 
                   RowBox[{"y___", ",", "x_", ",", "z___"}], "}"}], ",", "x_",
                   ",", "$angle"}], "]"}], "/;", 
                RowBox[{"OddQ", "[", 
                 RowBox[{"Length", "[", 
                  RowBox[{"{", "z", "}"}], "]"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Chain", "[", 
                 RowBox[{"type1", ",", "k", ",", 
                  RowBox[{"{", "y", "}"}], ",", "x", ",", "$angle"}], "]"}], 
                "*", 
                RowBox[{"Chain", "[", 
                 RowBox[{"$square", ",", "x", ",", 
                  RowBox[{"{", "z", "}"}], ",", "x", ",", "$angle"}], 
                 "]"}]}]}], ";", "\n", "\t", 
              RowBox[{
               RowBox[{
                RowBox[{"Chain", "[", 
                 RowBox[{"type1_", ",", "k_", ",", 
                  RowBox[{"{", 
                   RowBox[{"y___", ",", "x_", ",", "z___"}], "}"}], ",", "x_",
                   ",", "$square"}], "]"}], "/;", 
                RowBox[{"OddQ", "[", 
                 RowBox[{"Length", "[", 
                  RowBox[{"{", "z", "}"}], "]"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Chain", "[", 
                 RowBox[{"type1", ",", "k", ",", 
                  RowBox[{"{", "y", "}"}], ",", "x", ",", "$square"}], "]"}], 
                "*", 
                RowBox[{"Chain", "[", 
                 RowBox[{"$angle", ",", "x", ",", 
                  RowBox[{"{", "z", "}"}], ",", "x", ",", "$square"}], 
                 "]"}]}]}], ";", "\n", "\n", 
              RowBox[{"(*", 
               RowBox[{
               "Converting", " ", "emty", " ", "chains", " ", "into", " ", 
                "brackets"}], "*)"}], "\n", 
              RowBox[{
               RowBox[{"Chain", "[", 
                RowBox[{"$angle", ",", "x_", ",", 
                 RowBox[{"{", "}"}], ",", "y_", ",", "$angle"}], "]"}], ":=", 
               RowBox[{"SpinorAngleBracket", "[", 
                RowBox[{"x", ",", "y"}], "]"}]}], ";", "\n", 
              RowBox[{
               RowBox[{"Chain", "[", 
                RowBox[{"$square", ",", "x_", ",", 
                 RowBox[{"{", "}"}], ",", "y_", ",", "$square"}], "]"}], ":=", 
               RowBox[{"SpinorAngleBracket", "[", 
                RowBox[{"x", ",", "y"}], "]"}]}], ";", "\n", "\n", 
              RowBox[{"locexp", "=", "locexp"}], ";"}]}], "\n", "]"}], 
           ";"}]}], "\n", "\n", "]"}], ";", "\n", "\n", 
        RowBox[{"Return", "[", "locexp", "]"}], ";"}]}], "\n", "]"}]}], 
    ";"}]}]}]], "Code",ExpressionUUID->"97374bfc-e53b-4f4a-b255-9672d8b15c35"]
}, Closed]],

Cell[CellGroupData[{

Cell["Auxiliary for toChainNew", "Subsubsection",ExpressionUUID->"59329f6d-75d4-4f84-93c9-ac1a75c7a431"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
  "This", " ", "is", " ", "the", " ", "new", " ", "version", " ", "of", " ", 
   "ToChain", " ", "which", " ", "allows", " ", "to", " ", "select"}], " ", 
  "*)"}]], "Code",ExpressionUUID->"e58a951a-3e30-482e-9134-44521eb7f750"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "Auxiliary", " ", "function", " ", "to", " ", "test", " ", "for", " ", 
     "duplicates", " ", "in", " ", "a", " ", "list"}], ",", " ", 
    RowBox[{
    "returns", " ", "False", " ", "if", " ", "there", " ", "are", " ", "no", 
     " ", "duplicates"}]}], "*)"}], "\n", "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"duplicatesQ", " ", "=", " ", 
     RowBox[{
      RowBox[{"0", " ", "===", 
       RowBox[{"Signature", "@", "#"}]}], "&"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "Auxiliary", " ", "function", " ", "for", " ", "testing", " ", "if", " ",
       "a", " ", "contraction", " ", "is", " ", "possible"}], ",", " ", 
     RowBox[{
      RowBox[{"i", ".", "e", ".", " ", "if"}], " ", "every", " ", "bracket", 
      " ", "appears", " ", "at", " ", "most", " ", "once"}]}], "*)"}], "\n", 
   "\n", 
   RowBox[{
    RowBox[{"feasibilitytest", " ", "=", 
     RowBox[{
      RowBox[{"Or", "@@", " ", 
       RowBox[{"duplicatesQ", "/@", 
        RowBox[{"Transpose", "@", 
         RowBox[{"(", 
          RowBox[{"First", "/@", 
           RowBox[{"Transpose", "/@", "#"}]}], ")"}]}]}]}], "&"}]}], 
    ";"}]}]}]], "Code",ExpressionUUID->"c8b00316-3d52-4b53-a95e-d5d1ddf5a4a2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "Ordering", " ", "function", " ", "for", " ", "the", " ", "lists", " ", 
     "of", " ", "contractions"}], ",", " ", 
    RowBox[{
    "to", " ", "bring", " ", "them", " ", "in", " ", "sequntial", " ", 
     "order", " ", "ready", " ", "to", " ", "be", " ", "chained"}]}], "*)"}], 
  "\n", 
  RowBox[{"(*", 
   RowBox[{
   "We", " ", "assume", " ", "everything", " ", "to", " ", "be", " ", 
    "already", " ", "paired", " ", "up", " ", "by", " ", "contracted", " ", 
    "angle", " ", 
    RowBox[{"brackets", ".", " ", "Further"}], " ", "connect", " ", "by", " ",
     "contracted", " ", "angles"}], "*)"}], "\n", "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"chorder", " ", "/:", " ", 
     RowBox[{"List", "[", 
      RowBox[{"x1___", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1_", ",", "j1_"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i2_", ",", "j2_"}], "}"}]}], "}"}], ",", "y1___"}], 
        "]"}], ",", "x2___", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1_", ",", "j3_"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i4_", ",", "j4_"}], "}"}]}], "}"}], ",", "y2___"}], 
        "]"}], ",", "x3___"}], "]"}], ":=", 
     RowBox[{"List", "[", 
      RowBox[{"x1", ",", "x2", ",", "x3", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{
         RowBox[{"Sequence", "@@", 
          RowBox[{"Reverse", "[", 
           RowBox[{"{", "y2", "}"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1", ",", "j3"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i4", ",", "j4"}], "}"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1", ",", "j1"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i2", ",", "j2"}], "}"}]}], "}"}], ",", "y1"}], "]"}]}], 
      "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"chorder", " ", "/:", " ", 
     RowBox[{"List", "[", 
      RowBox[{"x1___", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{"y1___", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1_", ",", "j1_"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i2_", ",", "j2_"}], "}"}]}], "}"}]}], "]"}], ",", 
       "x2___", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1_", ",", "j3_"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i4_", ",", "j4_"}], "}"}]}], "}"}], ",", "y2___"}], 
        "]"}], ",", "x3___"}], "]"}], ":=", 
     RowBox[{"List", "[", 
      RowBox[{"x1", ",", "x2", ",", "x3", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{"y1", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1", ",", "j1"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i2", ",", "j2"}], "}"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1", ",", "j3"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i4", ",", "j4"}], "}"}]}], "}"}], ",", "y2"}], "]"}]}], 
      "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"chorder", " ", "/:", " ", 
     RowBox[{"List", "[", 
      RowBox[{"x1___", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1_", ",", "j3_"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i4_", ",", "j4_"}], "}"}]}], "}"}], ",", "y2___"}], 
        "]"}], ",", "x2___", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{"y1___", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1_", ",", "j1_"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i2_", ",", "j2_"}], "}"}]}], "}"}]}], "]"}], ",", 
       "x3___"}], "]"}], ":=", 
     RowBox[{"List", "[", 
      RowBox[{"x1", ",", "x2", ",", "x3", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{"y1", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1", ",", "j1"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i2", ",", "j2"}], "}"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1", ",", "j3"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i4", ",", "j4"}], "}"}]}], "}"}], ",", "y2"}], "]"}]}], 
      "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"chorder", " ", "/:", " ", 
     RowBox[{"List", "[", 
      RowBox[{"x1___", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{"y1___", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1_", ",", "j1_"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i2_", ",", "j2_"}], "}"}]}], "}"}]}], "]"}], ",", 
       "x2___", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{"y2___", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1_", ",", "j3_"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i4_", ",", "j4_"}], "}"}]}], "}"}]}], "]"}], ",", 
       "x3___"}], "]"}], ":=", 
     RowBox[{"List", "[", 
      RowBox[{"x1", ",", "x2", ",", "x3", ",", 
       RowBox[{"chorder", "[", 
        RowBox[{"y1", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1", ",", "j1"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i2", ",", "j2"}], "}"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i1", ",", "j3"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i4", ",", "j4"}], "}"}]}], "}"}], ",", 
         RowBox[{"Sequence", "@@", 
          RowBox[{"Reverse", "[", 
           RowBox[{"{", "y2", "}"}], "]"}]}]}], "]"}]}], "]"}]}], 
    ";"}]}]}]], "Code",ExpressionUUID->"4f0cc8e6-0b1d-4541-837f-6f9548ca20be"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "This", " ", "function", " ", "converts", " ", "lists", " ", "of", " ", 
    "brackets", " ", "into", " ", "a", " ", 
    RowBox[{"chain", ".", " ", "Needs"}], " ", "to", " ", "be", " ", 
    "embedded", " ", "in", " ", "previous", " ", "code"}], "*)"}], "\n", "\n", 
  RowBox[{"(*", 
   RowBox[{
   "We", " ", "assume", " ", "traces", " ", "have", " ", "been", " ", 
    "converted", " ", "from", " ", "even", " ", "to", " ", "odd", " ", 
    "number", " ", "of", " ", "contractions"}], "*)"}], "\n", "\n", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Single", " ", 
     RowBox[{"chain", ".", " ", "I"}], " ", 
     RowBox[{"think", "/", "hope"}], " ", "that", " ", "the", " ", "use", " ",
      "of", " ", "a", " ", "Length", " ", "test", " ", "intesad", " ", "of", 
     " ", "a", " ", "direct", " ", "pattern", " ", "matching", " ", 
     "increses", " ", "speed"}], ",", " ", 
    RowBox[{
    "this", " ", "is", " ", "the", " ", "reason", " ", "why", " ", 
     "introduced", " ", "an", " ", "auxiliary", " ", "function"}]}], "*)"}], 
  "\n", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"ChainBuilder", "[", 
      RowBox[{"exp_List", ",", "ag_List", ",", "sq_List"}], "]"}], "/;", 
     RowBox[{
      RowBox[{"Length", "@", "exp"}], "===", "1"}]}], ":=", 
    RowBox[{"auxChainBuilder", "[", 
     RowBox[{"exp", ",", "ag", ",", "sq"}], "]"}]}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"auxChainBuilder", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"i1_", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"i2_", ",", "1"}], "}"}]}], "}"}], "}"}], ",", "ag_", ",", 
       "sq_"}], "]"}], ":=", 
     RowBox[{"-", 
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", 
        RowBox[{"Last", "@", 
         RowBox[{"ag", "[", 
          RowBox[{"[", "i1", "]"}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"First", "@", 
          RowBox[{"ag", "[", 
           RowBox[{"[", "i1", "]"}], "]"}]}], "}"}], ",", 
        RowBox[{"Last", "@", 
         RowBox[{"sq", "[", 
          RowBox[{"[", "i2", "]"}], "]"}]}], ",", "$square"}], "]"}]}]}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"auxChainBuilder", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"i1_", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"i2_", ",", "2"}], "}"}]}], "}"}], "}"}], ",", "ag_", ",", 
       "sq_"}], "]"}], ":=", 
     RowBox[{"Chain", "[", 
      RowBox[{"$angle", ",", 
       RowBox[{"Last", "@", 
        RowBox[{"ag", "[", 
         RowBox[{"[", "i1", "]"}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"First", "@", 
         RowBox[{"ag", "[", 
          RowBox[{"[", "i1", "]"}], "]"}]}], "}"}], ",", 
       RowBox[{"First", "@", 
        RowBox[{"sq", "[", 
         RowBox[{"[", "i2", "]"}], "]"}]}], ",", "$square"}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"auxChainBuilder", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"i1_", ",", "2"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"i2_", ",", "1"}], "}"}]}], "}"}], "}"}], ",", "ag_", ",", 
       "sq_"}], "]"}], ":=", 
     RowBox[{"Chain", "[", 
      RowBox[{"$angle", ",", 
       RowBox[{"First", "@", 
        RowBox[{"ag", "[", 
         RowBox[{"[", "i1", "]"}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"Last", "@", 
         RowBox[{"ag", "[", 
          RowBox[{"[", "i1", "]"}], "]"}]}], "}"}], ",", 
       RowBox[{"Last", "@", 
        RowBox[{"sq", "[", 
         RowBox[{"[", "i2", "]"}], "]"}]}], ",", "$square"}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"auxChainBuilder", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"i1_", ",", "2"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"i2_", ",", "2"}], "}"}]}], "}"}], "}"}], ",", "ag_", ",", 
       "sq_"}], "]"}], ":=", 
     RowBox[{"-", 
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", 
        RowBox[{"First", "@", 
         RowBox[{"ag", "[", 
          RowBox[{"[", "i1", "]"}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"Last", "@", 
          RowBox[{"ag", "[", 
           RowBox[{"[", "i1", "]"}], "]"}]}], "}"}], ",", 
        RowBox[{"First", "@", 
         RowBox[{"sq", "[", 
          RowBox[{"[", "i2", "]"}], "]"}]}], ",", "$square"}], "]"}]}]}], 
    ";"}], "\n", "\n", 
   RowBox[{"(*", 
    RowBox[{"Even", " ", "angle", " ", "chains"}], "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"ChainBuilder", "[", 
       RowBox[{"exp_List", ",", "ag_List", ",", "sq_List"}], "]"}], "/;", 
      RowBox[{
       RowBox[{"EvenQ", "@", 
        RowBox[{"Length", "@", "exp"}]}], "&&", 
       RowBox[{
        RowBox[{"exp", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2", ",", "1"}], "]"}], "]"}], "===", 
        RowBox[{"exp", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2", ",", "1"}], "]"}], "]"}]}]}]}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"-", "1"}], ")"}], "^", 
       RowBox[{"Count", "[", 
        RowBox[{
         RowBox[{"Last", "/@", 
          RowBox[{"Total", "/@", "exp"}]}], ",", 
         RowBox[{"2", "|", "4"}], ",", "2"}], "]"}]}], "*", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"Chain", "[", 
          RowBox[{"$angle", ",", 
           RowBox[{"First", "@", "#"}], ",", 
           RowBox[{"Rest", "@", 
            RowBox[{"Most", "@", "#"}]}], ",", 
           RowBox[{"Last", "@", "#"}], ",", "$angle"}], "]"}], "&"}], "@", 
        RowBox[{"Flatten", "@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Last", "@", "#"}], "==", "1"}], ",", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"First", "@", "#"}]}], ",", 
                  RowBox[{"First", "@", "#"}]}], "]"}], "&"}], "@", 
               RowBox[{"First", "@", "#"}]}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Last", "@", "#"}], "==", "2"}], ",", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"First", "@", "#"}]}], ",", 
                  RowBox[{"First", "@", "#"}]}], "]"}], "&"}], "/@", 
               RowBox[{"Rest", "@", "#"}]}]}], "}"}], "&"}], "@", 
           RowBox[{"Transpose", "@", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Part", "[", 
                    RowBox[{
                    RowBox[{"List", "@@@", "ag"}], ",", "#"}], "]"}], "&"}], "/@",
                   "#1"}], ",", "#2"}], "}"}], "&"}], "@@", 
              RowBox[{"Transpose", "@", 
               RowBox[{"(", 
                RowBox[{"First", "/@", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Length", "@", "exp"}], ">", "2"}], ",", 
                   RowBox[{"Drop", "[", 
                    RowBox[{"exp", ",", 
                    RowBox[{"{", 
                    RowBox[{"3", ",", 
                    RowBox[{"Length", "[", "exp", "]"}], ",", "2"}], "}"}]}], 
                    "]"}], ",", "exp"}], "]"}]}], ")"}]}]}], ")"}]}]}], 
          ")"}]}]}], ")"}]}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", 
    RowBox[{"Even", " ", "square", " ", "chains"}], "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"ChainBuilder", "[", 
       RowBox[{"exp_List", ",", "ag_List", ",", "sq_List"}], "]"}], "/;", 
      RowBox[{
       RowBox[{"EvenQ", "@", 
        RowBox[{"Length", "@", "exp"}]}], "&&", 
       RowBox[{
        RowBox[{"exp", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2", ",", "1"}], "]"}], "]"}], "!=", 
        RowBox[{"exp", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2", ",", "1"}], "]"}], "]"}]}]}]}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"-", "1"}], ")"}], "^", 
       RowBox[{"Count", "[", 
        RowBox[{
         RowBox[{"Last", "/@", 
          RowBox[{"Total", "/@", "exp"}]}], ",", 
         RowBox[{"2", "|", "4"}], ",", "2"}], "]"}]}], "*", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"Chain", "[", 
          RowBox[{"$square", ",", 
           RowBox[{"First", "@", "#"}], ",", 
           RowBox[{"Rest", "@", 
            RowBox[{"Most", "@", "#"}]}], ",", 
           RowBox[{"Last", "@", "#"}], ",", "$square"}], "]"}], "&"}], "@", 
        RowBox[{"Flatten", "@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Last", "@", "#"}], "==", "1"}], ",", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"First", "@", "#"}]}], ",", 
                  RowBox[{"First", "@", "#"}]}], "]"}], "&"}], "@", 
               RowBox[{"First", "@", "#"}]}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Last", "@", "#"}], "==", "2"}], ",", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"First", "@", "#"}]}], ",", 
                  RowBox[{"First", "@", "#"}]}], "]"}], "&"}], "/@", 
               RowBox[{"Rest", "@", "#"}]}]}], "}"}], "&"}], "@", 
           RowBox[{"Transpose", "@", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Part", "[", 
                    RowBox[{
                    RowBox[{"List", "@@@", "sq"}], ",", "#"}], "]"}], "&"}], "/@",
                   "#1"}], ",", "#2"}], "}"}], "&"}], "@@", 
              RowBox[{"Transpose", "@", 
               RowBox[{"(", 
                RowBox[{"Last", "/@", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Length", "@", "exp"}], ">", "2"}], ",", 
                   RowBox[{"Drop", "[", 
                    RowBox[{"exp", ",", 
                    RowBox[{"{", 
                    RowBox[{"3", ",", 
                    RowBox[{"Length", "[", "exp", "]"}], ",", "2"}], "}"}]}], 
                    "]"}], ",", "exp"}], "]"}]}], ")"}]}]}], ")"}]}]}], 
          ")"}]}]}], ")"}]}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", 
    RowBox[{"Odd", " ", "length", " ", 
     RowBox[{"chains", ".", " ", "Just"}], " ", "like", " ", "in", " ", "the",
      " ", "even", " ", "case", " ", "with", " ", "an", " ", "addition", " ", 
     "of", " ", "a", " ", "final", " ", "bracket"}], "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"ChainBuilder", "[", 
       RowBox[{"exp_List", ",", "ag_List", ",", "sq_List"}], "]"}], "/;", 
      RowBox[{"OddQ", "@", 
       RowBox[{"Length", "@", "exp"}]}]}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"-", "1"}], ")"}], "^", 
       RowBox[{"Count", "[", 
        RowBox[{
         RowBox[{"Last", "/@", 
          RowBox[{"Total", "/@", "exp"}]}], ",", 
         RowBox[{"2", "|", "4"}], ",", "2"}], "]"}]}], "*", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"Chain", "[", 
          RowBox[{"$angle", ",", 
           RowBox[{"First", "@", "#"}], ",", 
           RowBox[{"Rest", "@", "#"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Last", "@", "#"}], "==", "1"}], ",", 
               RowBox[{"sq", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"First", "@", "#"}], ",", "2"}], "]"}], "]"}], ",", 
               RowBox[{"sq", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"First", "@", "#"}], ",", "1"}], "]"}], "]"}]}], 
              "]"}], "&"}], "@", 
            RowBox[{"Last", "@", 
             RowBox[{"Last", "@", "exp"}]}]}], ",", "$square"}], "]"}], "&"}],
         "@", 
        RowBox[{"Flatten", "@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Last", "@", "#"}], "==", "1"}], ",", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"First", "@", "#"}]}], ",", 
                  RowBox[{"First", "@", "#"}]}], "]"}], "&"}], "@", 
               RowBox[{"First", "@", "#"}]}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Last", "@", "#"}], "==", "2"}], ",", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"First", "@", "#"}]}], ",", 
                  RowBox[{"First", "@", "#"}]}], "]"}], "&"}], "/@", 
               RowBox[{"Rest", "@", "#"}]}]}], "}"}], "&"}], "@", 
           RowBox[{"Transpose", "@", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Part", "[", 
                    RowBox[{
                    RowBox[{"List", "@@@", "ag"}], ",", "#"}], "]"}], "&"}], "/@",
                   "#1"}], ",", "#2"}], "}"}], "&"}], "@@", 
              RowBox[{"Transpose", "@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"First", "/@", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "@", "#"}], ">", "2"}], ",", 
                    RowBox[{"Drop", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"3", ",", 
                    RowBox[{"Length", "[", "#", "]"}], ",", "2"}], "}"}]}], 
                    "]"}], ",", "#"}], "]"}]}], "&"}], "@", 
                 RowBox[{"Most", "@", "exp"}]}], ")"}]}]}], ")"}]}]}], 
          ")"}]}]}], ")"}]}]}], ";"}]}]}]], "Code",ExpressionUUID->"07712056-\
91ae-4555-9a62-30f79752c746"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "Function", " ", "which", " ", "given", " ", "a", " ", "list", " ", "of", 
     " ", "brackets", " ", "finda", " ", "all", " ", "possible", " ", 
     "chains", " ", "that", " ", "can", " ", "built", " ", "out", " ", "of", 
     " ", "them"}], ",", " ", 
    RowBox[{
    "returns", " ", "a", " ", "list", " ", "of", " ", "possible", " ", 
     "chains", " ", "and", " ", "free", " ", "uncontracted", " ", 
     "brackets"}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"AllChains", "[", "exp_List", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "ag", ",", "sq", ",", "ch", ",", "connections", ",", "momenta", ",", 
        "candidatecontractions", ",", "chains", ",", "pp", ",", "unique", ",",
         "sign", ",", "localbrackets", ",", "labs", ",", "removed"}], "}"}], 
      ",", "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "Gather", " ", "by", " ", "angle", " ", "and", " ", "square", " ", 
         "head"}], ",", " ", 
        RowBox[{
        "chains", " ", "are", " ", "converted", " ", "into", " ", "angles", 
         " ", "and", " ", "squares", " ", "and", " ", "in", " ", "case", " ", 
         "mixed", " ", "chains", " ", "are", " ", "found", " ", "an", " ", 
         "appropriate", " ", "connection", " ", "is", " ", 
         RowBox[{"added", ".", " ", "We"}], " ", "take", " ", "care", " ", 
         "of", " ", "chains", " ", "later", " ", "on"}]}], "*)"}], "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "Angle", " ", "and", " ", "square", " ", "chains", " ", "are", " ", 
         "no", " ", "problem"}], ",", " ", 
        RowBox[{
        "the", " ", "only", " ", "troublesome", " ", "are", " ", "the", " ", 
         "mixed", " ", "chains"}], ",", " ", 
        RowBox[{"these", " ", "are", " ", "kept", " ", "separate"}]}], "*)"}],
       "\n", 
      RowBox[{
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", "Chain", "}"}], ",", "\n", 
         RowBox[{
          RowBox[{
           RowBox[{"Chain", "[", 
            RowBox[{
            "$angle", ",", "x_", ",", "y_", ",", "z_", ",", "$angle"}], "]"}],
            ":=", 
           RowBox[{"SpinorAngleBracket", "[", 
            RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ";", "\n", 
          RowBox[{
           RowBox[{"Chain", "[", 
            RowBox[{
            "$square", ",", "x_", ",", "y_", ",", "z_", ",", "$square"}], 
            "]"}], ":=", 
           RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ";", "\n", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"ag", ",", "sq", ",", "ch"}], "}"}], "=", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"Flatten", "[", 
                RowBox[{"#", ",", "1"}], "]"}], "&"}], "/@", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Select", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Head", "@", 
                    RowBox[{"First", "@", "#"}]}], "===", 
                    "SpinorAngleBracket"}], "&"}], ")"}]}], "]"}], ",", 
                RowBox[{"Select", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Head", "@", 
                    RowBox[{"First", "@", "#"}]}], "===", 
                    "SpinorSquareBracket"}], "&"}], ")"}]}], "]"}], ",", 
                RowBox[{"Select", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Head", "@", 
                    RowBox[{"First", "@", "#"}]}], "===", "Chain"}], "&"}], 
                   ")"}]}], "]"}]}], "}"}]}], "&"}], "@", 
            RowBox[{"GatherBy", "[", 
             RowBox[{"exp", ",", "Head"}], "]"}]}]}], ";"}]}], "\n", "]"}], 
       ";", "\n", "\n", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "In", " ", "order", " ", "to", " ", "take", " ", "care", " ", "of", 
          " ", "mixed", " ", "chains", " ", "in", " ", "a", " ", "simple", 
          " ", "way", " ", "we", " ", "decompose", " ", "them", " ", "into", 
          " ", "an", " ", "angle", " ", "and", " ", "square", " ", "bracket", 
          " ", "and", " ", "add", " ", "a", " ", "fixed", " ", "connection", 
          " ", "to", " ", "the", " ", "list", " ", "of", " ", "connections"}],
          ",", " ", 
         RowBox[{"the", " ", "rest", " ", "follows", " ", "automatically"}]}],
         "*)"}], "\n", 
       RowBox[{"sign", "=", "1"}], ";", "\n", 
       RowBox[{"Do", "[", "\n", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{
          "Decomposition", " ", "into", " ", "angle", " ", "and", " ", 
           "square", " ", "is", " ", "done", " ", "by", " ", "introducing", 
           " ", "a", " ", "unique", " ", "label", " ", "fro", " ", "each", 
           " ", "chain"}], ",", " ", 
          RowBox[{
          "so", " ", "that", " ", "later", " ", "on", " ", "when", " ", 
           "contractions", " ", "are", " ", "performed", " ", "there", " ", 
           "will", " ", "be", " ", "exactly", " ", "for", " ", "each", " ", 
           "of", " ", 
           RowBox[{"these", "."}]}]}], "*)"}], "\n", 
        RowBox[{
         RowBox[{
          RowBox[{"ag", "=", 
           RowBox[{"Join", "[", 
            RowBox[{"ag", ",", 
             RowBox[{"{", 
              RowBox[{"SpinorAngleBracket", "[", 
               RowBox[{
                RowBox[{"i", "[", 
                 RowBox[{"[", "2", "]"}], "]"}], ",", 
                RowBox[{"Most", "@", 
                 RowBox[{"i", "[", 
                  RowBox[{"[", "3", "]"}], "]"}]}], ",", 
                RowBox[{"unique", "=", 
                 RowBox[{"pp", "[", 
                  RowBox[{
                   RowBox[{"Last", "@", 
                    RowBox[{"i", "[", 
                    RowBox[{"[", "3", "]"}], "]"}]}], ",", 
                   RowBox[{"Unique", "[", "]"}]}], "]"}]}]}], "]"}], "}"}]}], 
            "]"}]}], ";", "\n", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"OrderedQ", "[", 
             RowBox[{"{", 
              RowBox[{"unique", ",", 
               RowBox[{"i", "[", 
                RowBox[{"[", "4", "]"}], "]"}]}], "}"}], "]"}], ",", "\n", 
            RowBox[{
             RowBox[{"sq", "=", 
              RowBox[{"Join", "[", 
               RowBox[{"sq", ",", 
                RowBox[{"{", 
                 RowBox[{"SpinorSquareBracket", "[", 
                  RowBox[{"unique", ",", 
                   RowBox[{"i", "[", 
                    RowBox[{"[", "4", "]"}], "]"}]}], "]"}], "}"}]}], "]"}]}],
              ";"}], "\n", ",", "\n", 
            RowBox[{"(*", 
             RowBox[{
             "Sign", " ", "keeps", " ", "track", " ", "of", " ", "signs", " ",
               "since", " ", "the", " ", "arguments", " ", "of", " ", "the", 
              " ", "brackets", " ", "need", " ", "to", " ", "be", " ", 
              "correctly", " ", "ordered", " ", 
              RowBox[{"(", 
               RowBox[{
               "this", " ", "was", " ", "an", " ", "initial", " ", 
                "assumption", " ", "on", " ", "the", " ", "input", " ", 
                "list", " ", "so", " ", "it", " ", "must", " ", "be", " ", 
                "mantained"}], ")"}]}], "*)"}], "\n", 
            RowBox[{
             RowBox[{"sign", "=", 
              RowBox[{
               RowBox[{"-", "1"}], "*", "sign"}]}], ";", "\n", 
             RowBox[{"sq", "=", 
              RowBox[{"Join", "[", 
               RowBox[{"sq", ",", 
                RowBox[{"{", 
                 RowBox[{"SpinorSquareBracket", "[", 
                  RowBox[{
                   RowBox[{"i", "[", 
                    RowBox[{"[", "4", "]"}], "]"}], ",", "unique"}], "]"}], 
                 "}"}]}], "]"}]}], ";"}]}], "\n", "]"}], ";"}], "\n", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "ch"}], "}"}]}], "]"}], ";", "\n", "\n", 
       RowBox[{"(*", 
        RowBox[{
        "Remove", " ", "some", " ", "redundancy", " ", "by", " ", "removing", 
         " ", "unnecessary", " ", "powers"}], "*)"}], "\n", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"SpinorAngleBracket", ",", "SpinorSquareBracket"}], "}"}], 
         ",", "\n", 
         RowBox[{
          RowBox[{
           RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{"x_", ",", "y_", ",", "z_"}], "]"}], ":=", 
           RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{"x", ",", "z"}], "]"}]}], ";", "\n", 
          RowBox[{
           RowBox[{"SpinorAngleBracket", "[", 
            RowBox[{"x_", ",", "y_", ",", "z_"}], "]"}], ":=", 
           RowBox[{"SpinorAngleBracket", "[", 
            RowBox[{"x", ",", "z"}], "]"}]}], ";", "\n", 
          RowBox[{"removed", "=", 
           RowBox[{"{", "}"}]}], ";", "\n", "\n", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "@", "#"}], ">", "0"}], ",", "\n", 
              RowBox[{
               RowBox[{"localbrackets", "=", "sq"}], ";", "\n", 
               RowBox[{"Do", "[", "\n", 
                RowBox[{
                 RowBox[{
                  RowBox[{"labs", "=", 
                   RowBox[{"Alternatives", "@@", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"First", "@", "#"}], ",", 
                    RowBox[{"Last", "@", "#"}]}], "}"}], "&"}], "@", 
                    RowBox[{"First", "@", "i"}]}], ")"}]}]}], ";", "\n", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"#", ">", "0"}], ",", "\n", 
                    RowBox[{
                    RowBox[{"ag", "=", 
                    RowBox[{"DeleteCases", "[", 
                    RowBox[{"ag", ",", 
                    RowBox[{"First", "@", "i"}], ",", "1", ",", "#"}], 
                    "]"}]}], ";", 
                    RowBox[{"removed", "=", 
                    RowBox[{"Join", "[", 
                    RowBox[{"removed", ",", 
                    RowBox[{"ConstantArray", "[", 
                    RowBox[{
                    RowBox[{"First", "@", "i"}], ",", "#"}], "]"}]}], "]"}]}],
                     ";"}]}], "]"}], "&"}], "@", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Length", "@", "i"}], "-", 
                    RowBox[{"Count", "[", 
                    RowBox[{"localbrackets", ",", "labs", ",", "2"}], "]"}]}],
                     ")"}]}], ";"}], "\n", ",", 
                 RowBox[{"{", 
                  RowBox[{"i", ",", "#"}], "}"}]}], "]"}], ";"}]}], "\n", 
             "]"}], "&"}], "@", 
           RowBox[{"Select", "[", 
            RowBox[{
             RowBox[{"Gather", "[", "ag", "]"}], ",", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "@", "#"}], ">", "1"}], "&"}], ")"}]}], 
            "]"}]}], ";", "\n", "\n", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "@", "#"}], ">", "0"}], ",", "\n", 
              RowBox[{
               RowBox[{"localbrackets", "=", "ag"}], ";", "\n", 
               RowBox[{"Do", "[", "\n", 
                RowBox[{
                 RowBox[{
                  RowBox[{"labs", "=", 
                   RowBox[{"Alternatives", "@@", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"First", "@", "#"}], ",", 
                    RowBox[{"Last", "@", "#"}]}], "}"}], "&"}], "@", 
                    RowBox[{"First", "@", "i"}]}], ")"}]}]}], ";", "\n", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"#", ">", "0"}], ",", 
                    RowBox[{
                    RowBox[{"sq", "=", 
                    RowBox[{"DeleteCases", "[", 
                    RowBox[{"sq", ",", 
                    RowBox[{"First", "@", "i"}], ",", "1", ",", "#"}], 
                    "]"}]}], ";", 
                    RowBox[{"removed", "=", 
                    RowBox[{"Join", "[", 
                    RowBox[{"removed", ",", 
                    RowBox[{"ConstantArray", "[", 
                    RowBox[{
                    RowBox[{"First", "@", "i"}], ",", "#"}], "]"}]}], "]"}]}],
                     ";"}]}], "]"}], "&"}], "@", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Length", "@", "i"}], "-", 
                    RowBox[{"Count", "[", 
                    RowBox[{"localbrackets", ",", "labs", ",", "2"}], "]"}]}],
                     ")"}]}], ";"}], "\n", ",", 
                 RowBox[{"{", 
                  RowBox[{"i", ",", "#"}], "}"}]}], "]"}], ";"}]}], "\n", 
             "]"}], "&"}], "@", 
           RowBox[{"Select", "[", 
            RowBox[{
             RowBox[{"Gather", "[", "sq", "]"}], ",", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "@", "#"}], ">", "1"}], "&"}], ")"}]}], 
            "]"}]}], ";"}]}], "\n", "\n", "\n", "]"}], ";", "\n", "\n", 
       RowBox[{"(*", 
        RowBox[{
        "Find", " ", "the", " ", "momenta", " ", "and", " ", "their", " ", 
         "number"}], "*)"}], "\n", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"SpinorAngleBracket", ",", "SpinorSquareBracket"}], "}"}], 
         ",", "\n", 
         RowBox[{
          RowBox[{
           RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{"x_", ",", "y_", ",", "z_"}], "]"}], ":=", 
           RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{"x", ",", "z"}], "]"}]}], ";", "\n", 
          RowBox[{
           RowBox[{"SpinorAngleBracket", "[", 
            RowBox[{"x_", ",", "y_", ",", "z_"}], "]"}], ":=", 
           RowBox[{"SpinorAngleBracket", "[", 
            RowBox[{"x", ",", "z"}], "]"}]}], ";", "\n", "\n", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "These", " ", "are", " ", "the", " ", "momenta", " ", "and", " ", 
             "their", " ", 
             RowBox[{"multiplicities", ".", " ", "They"}], " ", "are", " ", 
             "found", " ", "by", " ", "extracting", " ", "all", " ", "the", 
             " ", "labels", " ", "from", " ", "the", " ", "brackest"}], ",", 
            " ", 
            RowBox[{
            "then", " ", "counting", " ", "the", " ", "labels", " ", "and", 
             " ", "looking", " ", "at", " ", "those", " ", "which", " ", 
             "appear", " ", "both", " ", "as", " ", "angle", " ", "and", " ", 
             RowBox[{"squares", ".", " ", "Then"}], " ", "we", " ", "take", 
             " ", "the", " ", "minimum", " ", "between", " ", "the", " ", 
             "angle", " ", "and", " ", "square", " ", "appearences"}], ",", 
            " ", 
            RowBox[{
            "the", " ", "mismatch", " ", "gives", " ", "the", " ", "helicity",
              " ", "weight", " ", "which", " ", "we", " ", "do", " ", "not", 
             " ", "need", " ", "right", " ", "now"}], ",", " ", 
            RowBox[{
            "the", " ", "rest", " ", "is", " ", "the", " ", "number", " ", 
             "of", " ", "momenta", " ", "which", " ", "can", " ", "be", " ", 
             RowBox[{"formed", "."}]}]}], "*)"}], "\n", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", 
              RowBox[{"momenta", "=", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Select", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "@", 
                    RowBox[{"First", "@", "#"}]}], "==", "2"}], "&"}], 
                    ")"}]}], "]"}], "&"}], "@", 
                  RowBox[{"GatherBy", "[", 
                   RowBox[{"#", ",", "Length"}], "]"}]}], "&"}], "@", 
                RowBox[{"GatherBy", "[", 
                 RowBox[{
                  RowBox[{"Join", "@@", 
                   RowBox[{"Tally", "/@", 
                    RowBox[{"Flatten", "/@", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"List", "@@@", "ag"}], ",", 
                    RowBox[{"List", "@@@", "sq"}]}], "}"}]}]}]}], ",", 
                  "First"}], "]"}]}]}], "]"}], ">", "0"}], ",", "\n", 
            RowBox[{
             RowBox[{"momenta", "=", 
              RowBox[{
               RowBox[{
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"First", "@", "#1"}], ",", 
                  RowBox[{"Min", "@", "#2"}]}], "}"}], "&"}], "@@@", 
               RowBox[{"Transpose", "/@", 
                RowBox[{"First", "@", "momenta"}]}]}]}], ";"}], "\n", ",", 
            "\n", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
               RowBox[{"If", " ", "momenta", " ", "has", " ", "length"}], "=", 
               RowBox[{
               "0", " ", "no", " ", "momenta", " ", "are", " ", 
                "presents"}]}], ",", " ", 
              RowBox[{
              "no", " ", "contractions", " ", "can", " ", "be", " ", "made", 
               " ", "and", " ", "we", " ", "return", " ", "the", " ", "input",
                " ", "list", " ", "as", " ", "it", " ", "is"}]}], "*)"}], 
            "\n", 
            RowBox[{
             RowBox[{"Return", "[", "exp", "]"}], ";"}]}], "\n", "]"}], ";", 
          "\n", "\n", "\n", "\n", 
          RowBox[{"(*", 
           RowBox[{
           "Extract", " ", "the", " ", "positions", " ", "of", " ", "the", 
            " ", "brackets", " ", "containg", " ", "each", " ", "momentum", 
            " ", "and", " ", "then", " ", "pair", " ", "them"}], "*)"}], "\n", 
          RowBox[{"candidatecontractions", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", 
              RowBox[{"#", ",", "1"}], "]"}], "&"}], "/@", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"Outer", "[", 
                RowBox[{"List", ",", "#1", ",", "#2", ",", "1"}], "]"}], 
               "&"}], "@@@", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"Position", "[", 
                    RowBox[{"ag", ",", "#"}], "]"}], ",", 
                   RowBox[{"Position", "[", 
                    RowBox[{"sq", ",", "#"}], "]"}]}], "}"}], "&"}], "/@", 
                RowBox[{"First", "@", 
                 RowBox[{"Transpose", "@", "momenta"}]}]}], ")"}]}], 
             ")"}]}]}], ";", "\n", "\n", 
          RowBox[{"(*", 
           RowBox[{
           "Out", " ", "of", " ", "the", " ", "candidatecontractions", " ", 
            "I", " ", "have", " ", "to", " ", "select", " ", "subsets", " ", 
            "with", " ", "number", " ", "of", " ", "elements", " ", "given", 
            " ", "by", " ", "the", " ", "multiplicity", " ", "of", " ", "the",
             " ", "given", " ", "momentum", " ", "and", " ", "then", " ", 
            "apply", " ", "a", " ", "feasibility", " ", 
            RowBox[{"check", ":", " ", 
             RowBox[{
             "every", " ", "bracket", " ", "can", " ", "only", " ", "appear", 
              " ", "once", " ", "per", " ", 
              RowBox[{"momentum", "."}]}]}]}], "*)"}], "\n", 
          RowBox[{"chains", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"Subsets", "[", 
              RowBox[{"#1", ",", 
               RowBox[{"{", "#2", "}"}]}], "]"}], "&"}], "@@@", 
            RowBox[{"Transpose", "@", 
             RowBox[{"{", 
              RowBox[{"candidatecontractions", ",", 
               RowBox[{"Last", "@", 
                RowBox[{"Transpose", "@", "momenta"}]}]}], "}"}]}]}]}], ";", 
          "\n", 
          RowBox[{"(*", 
           RowBox[{"Apply", " ", 
            RowBox[{"check", ":"}]}], "*)"}], "\n", 
          RowBox[{"chains", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"DeleteCases", "[", 
              RowBox[{"#", ",", 
               RowBox[{"_", "?", "feasibilitytest"}]}], "]"}], "&"}], "/@", 
            "chains"}]}], ";", "\n", "\n", 
          RowBox[{"(*", 
           RowBox[{
           "Out", " ", "of", " ", "these", " ", "we", " ", "need", " ", "to", 
            " ", "take", " ", "all", " ", "possible", " ", 
            RowBox[{"combinations", "."}]}], "*)"}], "\n", 
          RowBox[{"chains", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", 
              RowBox[{"#", ",", "1"}], "]"}], "&"}], "/@", 
            RowBox[{"Tuples", "@", "chains"}]}]}], ";"}]}], "\n", "]"}], ";", 
       "\n", "\n", 
       RowBox[{"(*", 
        RowBox[{
        "Reoreder", " ", "list", " ", "such", " ", "that", " ", "the", " ", 
         "structure", " ", "of", " ", "contracted", " ", "chains", " ", "is", 
         " ", "visible"}], "*)"}], "\n", 
       RowBox[{"chains", "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Apply", "[", 
           RowBox[{"chorder", ",", 
            RowBox[{
             RowBox[{
              RowBox[{"GatherBy", "[", 
               RowBox[{"#", ",", 
                RowBox[{
                 RowBox[{"#", "[", 
                  RowBox[{"[", 
                   RowBox[{"2", ",", "1"}], "]"}], "]"}], "&"}]}], "]"}], 
              "&"}], "/@", "chains"}], ",", 
            RowBox[{"{", "2", "}"}]}], "]"}], ",", 
          RowBox[{
           RowBox[{
            RowBox[{"Flatten", "@", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"Part", "[", 
                    RowBox[{"ag", ",", "#"}], "]"}], "&"}], "/@", "#1"}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Part", "[", 
                    RowBox[{"sq", ",", "#"}], "]"}], "&"}], "/@", "#2"}], ",",
                     "removed", ",", "sign"}], "}"}], "&"}], "@@", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"Complement", "[", 
                    RowBox[{
                    RowBox[{"Range", "@", 
                    RowBox[{"Length", "@", "ag"}]}], ",", "#1"}], "]"}], ",", 
                   RowBox[{"Complement", "[", 
                    RowBox[{
                    RowBox[{"Range", "@", 
                    RowBox[{"Length", "@", "sq"}]}], ",", "#2"}], "]"}]}], 
                  "}"}]}], "&"}], "@@", 
               RowBox[{"Map", "[", 
                RowBox[{"First", ",", 
                 RowBox[{"Transpose", "@", "#"}], ",", 
                 RowBox[{"{", "2", "}"}]}], "]"}]}], ")"}]}], "&"}], "/@", 
           "chains"}]}], "}"}]}], ";", "\n", "\n", 
       RowBox[{"(*", 
        RowBox[{
        "Next", " ", "convert", " ", "to", " ", "chains", " ", "the", " ", 
         "single", " ", "parts"}], "*)"}], "\n", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", "chorder", "}"}], ",", "\n", "\n", 
         RowBox[{"(*", 
          RowBox[{
          "Next", " ", "we", " ", "transformtraces", " ", "from", " ", "even",
            " ", "to", " ", "odd", " ", "chains", " ", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
             "so", " ", "far", " ", "we", " ", "counted", " ", "the", " ", 
              "number", " ", "of", " ", "momenta"}], ",", " ", 
             RowBox[{
             "now", " ", "we", " ", "count", " ", "the", " ", "number", " ", 
              "of", " ", "connections"}]}], ")"}]}], "*)"}], "\n", 
         RowBox[{
          RowBox[{
           RowBox[{"chorder", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"i1_", ",", "j1_"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"i2_", ",", "j2_"}], "}"}]}], "}"}], ",", "x__", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"i1_", ",", "_"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"_", ",", "_"}], "}"}]}], "}"}]}], "]"}], ":=", 
           RowBox[{"chorder", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"i1", ",", "j1"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"i2", ",", "j2"}], "}"}]}], "}"}], ",", "x"}], 
            "]"}]}], ";", "\n", "\n", 
          RowBox[{"(*", 
           RowBox[{"Build", " ", "the", " ", "chains"}], "*)"}], "\n", 
          RowBox[{
           RowBox[{"chorder", "[", "x__", "]"}], ":=", 
           RowBox[{"ChainBuilder", "[", 
            RowBox[{
             RowBox[{"{", "x", "}"}], ",", "ag", ",", "sq"}], "]"}]}], ";", 
          "\n", "\n", 
          RowBox[{"(*", 
           RowBox[{
           "Reconvert", " ", "unique", " ", "labels", " ", "for", " ", 
            "mixed", " ", "chains", " ", "into", " ", "original", " ", 
            "labels"}], "*)"}], "\n", 
          RowBox[{
           RowBox[{"pp", "[", 
            RowBox[{"x_", ",", "_"}], "]"}], ":=", "x"}], ";", "\n", "\n", 
          RowBox[{"Return", "[", 
           RowBox[{"Flatten", "/@", 
            RowBox[{"Transpose", "@", "chains"}]}], "]"}], ";"}]}], "\n", 
        "]"}], ";"}]}], "\n", "\n", "]"}]}], ";"}]}]], "Code",ExpressionUUID->\
"4cd78243-28f0-48c3-9354-bd9eb98b7a59"]
}, Closed]],

Cell[CellGroupData[{

Cell["toChainNew", "Subsubsection",ExpressionUUID->"c9e5a0c5-3410-4589-8250-77b3e73053e9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "toChainNew", " ", "is", " ", "the", " ", "new", " ", "version", " ", "of",
     " ", "ToChain", " ", "which", " ", "is", " ", "slower", " ", 
    RowBox[{"(", 
     RowBox[{"due", " ", "to", " ", "combinatorics"}], ")"}], " ", "but", " ",
     "build", " ", "all", " ", "possible", " ", "chains", " ", "and", " ", 
    "selects", " ", "the", " ", "once", " ", "fitting", " ", "the", " ", 
    "criteria", " ", "chosen", " ", "by", " ", "the", " ", "user"}], "*)"}], 
  "\n", "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"toChainNew", "[", 
     RowBox[{"exp_", ",", 
      RowBox[{"chainCrit_", ":", "\"\<ShortestChain\>\""}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "locexp", ",", "tochain", ",", "tochaininv", ",", "chainselect"}], 
       "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"locexp", "=", "exp"}], ";", "\n", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"Power", ",", "Times"}], "}"}], ",", "\n", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Power", "[", 
             RowBox[{
              RowBox[{"f_", "[", "x__", "]"}], ",", 
              RowBox[{"p_", "?", "Negative"}]}], "]"}], "/;", 
            RowBox[{
             RowBox[{"f", "==", "SpinorAngleBracket"}], "||", 
             RowBox[{"f", "==", "SpinorSquareBracket"}], "||", 
             RowBox[{"f", "==", "Chain"}]}]}], ":=", 
           RowBox[{"tochaininv", "[", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"ConstantArray", "[", 
              RowBox[{
               RowBox[{"f", "[", "x", "]"}], ",", 
               RowBox[{"-", "p"}]}], "]"}]}], "]"}]}], ";", "\n", 
          RowBox[{
           RowBox[{
            RowBox[{"Power", "[", 
             RowBox[{
              RowBox[{"f_", "[", "x__", "]"}], ",", "p_"}], "]"}], "/;", 
            RowBox[{
             RowBox[{"f", "==", "SpinorAngleBracket"}], "||", 
             RowBox[{"f", "==", "SpinorSquareBracket"}], "||", 
             RowBox[{"f", "==", "Chain"}]}]}], ":=", 
           RowBox[{"tochain", "[", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"ConstantArray", "[", 
              RowBox[{
               RowBox[{"f", "[", "x", "]"}], ",", "p"}], "]"}]}], "]"}]}], 
          ";", "\n", 
          RowBox[{
           RowBox[{
            RowBox[{"Times", "[", 
             RowBox[{"z___", ",", 
              RowBox[{"f_", "[", "x__", "]"}], ",", "y___"}], "]"}], "/;", 
            RowBox[{
             RowBox[{"f", "==", "SpinorAngleBracket"}], "||", 
             RowBox[{"f", "==", "SpinorSquareBracket"}], "||", 
             RowBox[{"f", "==", "Chain"}]}]}], ":=", 
           RowBox[{"Times", "[", 
            RowBox[{"z", ",", 
             RowBox[{"tochain", "[", 
              RowBox[{"f", "[", "x", "]"}], "]"}], ",", "y"}], "]"}]}], ";", 
          "\n", 
          RowBox[{"locexp", "=", "locexp"}], ";"}]}], "\n", "]"}], ";", "\n", 
       RowBox[{"tochain", " ", "/:", " ", 
        RowBox[{"Times", "[", 
         RowBox[{
          RowBox[{"tochain", "[", "x__", "]"}], ",", 
          RowBox[{"tochain", "[", "y__", "]"}], ",", "z___"}], "]"}], ":=", 
        RowBox[{"Times", "[", 
         RowBox[{
          RowBox[{"tochain", "[", 
           RowBox[{"x", ",", "y"}], "]"}], ",", "z"}], "]"}]}], ";", "\n", 
       RowBox[{"tochaininv", " ", "/:", " ", 
        RowBox[{"Times", "[", 
         RowBox[{
          RowBox[{"tochaininv", "[", "x__", "]"}], ",", 
          RowBox[{"tochaininv", "[", "y__", "]"}], ",", "z___"}], "]"}], ":=", 
        RowBox[{"Times", "[", 
         RowBox[{
          RowBox[{"tochaininv", "[", 
           RowBox[{"x", ",", "y"}], "]"}], ",", "z"}], "]"}]}], ";", "\n", 
       RowBox[{"locexp", "=", "locexp"}], ";", "\n", "\n", 
       RowBox[{"(*", 
        RowBox[{
        "Basing", " ", "on", " ", "the", " ", "options", " ", "we", " ", 
         "decide", " ", "which", " ", "chain", " ", "we", " ", "want", " ", 
         "to", " ", "pick"}], "*)"}], "\n", 
       RowBox[{"Which", "[", 
        RowBox[{
         RowBox[{"chainCrit", "===", "\"\<ShortestChain\>\""}], ",", "\n", 
         RowBox[{
          RowBox[{"chainselect", "[", "chains_List", "]"}], ":=", 
          RowBox[{"Times", "@@", 
           RowBox[{"Last", "@", 
            RowBox[{"SortBy", "[", 
             RowBox[{"chains", ",", "Length"}], "]"}]}]}]}], ",", "\n", 
         RowBox[{"chainCrit", "===", "\"\<LongestChain\>\""}], ",", "\n", 
         RowBox[{
          RowBox[{"chainselect", "[", "chains_List", "]"}], ":=", 
          RowBox[{"Times", "@@", 
           RowBox[{"First", "@", 
            RowBox[{"SortBy", "[", 
             RowBox[{"chains", ",", "Length"}], "]"}]}]}]}], ",", "\n", 
         RowBox[{"chainCrit", "===", "\"\<MostTraces\>\""}], ",", "\n", 
         RowBox[{
          RowBox[{"chainselect", "[", "chains_List", "]"}], ":=", 
          RowBox[{"Times", "@@", 
           RowBox[{"Last", "@", 
            RowBox[{"SortBy", "[", 
             RowBox[{"chains", ",", 
              RowBox[{
               RowBox[{"Length", "@", 
                RowBox[{"Cases", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{
                   RowBox[{"Chain", "[", 
                    RowBox[{"$angle", ",", "x_", ",", 
                    RowBox[{"{", "__", "}"}], ",", "x_", ",", "$square"}], 
                    "]"}], ":>", "1"}]}], "]"}]}], "&"}]}], "]"}]}]}]}], ",", 
         "\n", "True", ",", "\n", 
         RowBox[{
          RowBox[{"chainselect", "[", "chains_List", "]"}], ":=", 
          RowBox[{"Times", "@@", 
           RowBox[{"Last", "@", 
            RowBox[{"SortBy", "[", 
             RowBox[{"chains", ",", "Length"}], "]"}]}]}]}]}], "\n", "]"}], 
       ";", "\n", "\n", 
       RowBox[{
        RowBox[{"tochain", "[", "x__", "]"}], ":=", 
        RowBox[{"chainselect", "@", 
         RowBox[{"AllChains", "[", 
          RowBox[{"{", "x", "}"}], "]"}]}]}], ";", "\n", 
       RowBox[{
        RowBox[{"tochaininv", "[", "x__", "]"}], ":=", 
        RowBox[{"Power", "[", 
         RowBox[{
          RowBox[{"chainselect", "@", 
           RowBox[{"AllChains", "[", 
            RowBox[{"{", "x", "}"}], "]"}]}], ",", 
          RowBox[{"-", "1"}]}], "]"}]}], ";", "\n", 
       RowBox[{"Return", "[", "locexp", "]"}], ";"}]}], "\n", "]"}]}], 
   ";"}]}]], "Code",ExpressionUUID->"550f8374-f490-49c9-890c-8210637f6f5f"]
}, Closed]],

Cell[CellGroupData[{

Cell["ToChain", "Subsubsection",ExpressionUUID->"691d3b74-b5e8-4f5d-9df7-57064d7387fc"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "ToChain", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"ChainSelection", "->", "\"\<RandomChain\>\""}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"ToChain", "::", "opt"}], "=", 
  "\"\<Unknown option, proceed with ShortestChain\>\""}]}], "Code",ExpressionU\
UID->"9f9b6008-030f-4b30-bc53-082e67570786"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "ToChain", " ", "takes", " ", "simply", " ", "redirects", " ", "the", " ", 
    "call", " ", "to", " ", "the", " ", "appropriate", " ", "algorithm"}], 
   "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"ToChain", "[", 
     RowBox[{"exp_", ",", 
      RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
    RowBox[{"Which", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"OptionValue", "[", "ChainSelection", "]"}], "===", 
       "\"\<RandomChain\>\""}], ",", "\n", 
      RowBox[{"toChainOld", "[", "exp", "]"}], ",", "\n", 
      RowBox[{
       RowBox[{"OptionValue", "[", "ChainSelection", "]"}], "===", 
       "\"\<ShortestChain\>\""}], ",", "\n", 
      RowBox[{"toChainNew", "[", 
       RowBox[{"exp", ",", "\"\<ShortestChain\>\""}], "]"}], ",", "\n", 
      RowBox[{
       RowBox[{"OptionValue", "[", "ChainSelection", "]"}], "===", 
       "\"\<LongestChain\>\""}], ",", "\n", 
      RowBox[{"toChainNew", "[", 
       RowBox[{"exp", ",", "\"\<LongestChain\>\""}], "]"}], ",", "\n", 
      RowBox[{
       RowBox[{"OptionValue", "[", "ChainSelection", "]"}], "===", 
       "\"\<MostTraces\>\""}], ",", "\n", 
      RowBox[{"toChainNew", "[", 
       RowBox[{"exp", ",", "\"\<MostTraces\>\""}], "]"}], ",", "\n", "True", 
      ",", "\n", 
      RowBox[{
       RowBox[{"Message", "[", 
        RowBox[{"ToChain", "::", "opt"}], "]"}], ";", "\n", 
       RowBox[{"toChainNew", "[", "exp", "]"}]}]}], "\n", "]"}]}], 
   ";"}]}]], "Code",ExpressionUUID->"88b719d3-07af-433f-8acb-a220f0a893a9"]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{

Cell["Preprocessing", "Subsection",
 CellChangeTimes->{{3.846245675277483*^9, 
  3.846245677621294*^9}},ExpressionUUID->"5cb88fc9-3da6-4eb3-8874-\
9a48338fb3de"],

Cell[BoxData[
 RowBox[{
  RowBox[{"PreChain", "[", "exp_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "aa", ",", "bb", ",", "ab", ",", "wrapper", ",", "invwrapper", ",", 
      "local", ",", "SpinorAngleBracket", ",", "SpinorSquareBracket", ",", 
      "Chain"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"local", "=", "exp"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Convert", " ", "all", " ", "the", " ", "chains", " ", "and", " ", 
       "spinor", " ", "brackets", " ", "into", " ", "simpler", " ", "objects",
        " ", "and", " ", "wrap", " ", "them", " ", "into", " ", "a", " ", 
       "function", " ", "which", " ", "will", " ", "chain", " ", "them"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpinorAngleBracket", "[", "x__", "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"aa", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpinorSquareBracket", "[", "x__", "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"bb", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x__", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"aa", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x__", ",", "$square"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"ab", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x__", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"ab", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Reverse", "@", 
          RowBox[{"Flatten", "@", 
           RowBox[{"{", "x", "}"}]}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x__", ",", "$square"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"bb", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Define", " ", "properties", " ", "of", " ", "the", " ", "wrapper", 
        " ", "so", " ", "that", " ", "it", " ", "wraps", " ", "everything", 
        " ", "together"}], ",", " ", 
       RowBox[{"taking", " ", "care", " ", "of", " ", "the", " ", 
        RowBox[{"powers", ".", " ", "Inverse"}], " ", "powers", " ", "are", 
        " ", "the", " ", "reason", " ", "we", " ", "need", " ", "the", " ", 
        "auxiliary", " ", "invwrapper"}], ",", " ", 
       RowBox[{
        RowBox[{
        "this", " ", "would", " ", "be", " ", "needed", " ", "if", " ", "we", 
         " ", "could", " ", "go", " ", "deeper", " ", "with", " ", "the", " ",
          "upvalues", " ", "of", " ", "wrapper"}], "..."}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{
       RowBox[{"wrapper", "[", "x_", "]"}], "*", 
       RowBox[{"wrapper", "[", "y_", "]"}]}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x_", "]"}], ",", 
        RowBox[{"n_", "?", "Positive"}]}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"Power", "[", 
        RowBox[{"x", ",", "n"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x_", "]"}], ",", 
        RowBox[{"n_", "?", "Negative"}]}], "]"}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"Power", "[", 
        RowBox[{"x", ",", 
         RowBox[{"-", "n"}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"invwrapper", " ", "/:", " ", 
      RowBox[{
       RowBox[{"invwrapper", "[", "x_", "]"}], "*", 
       RowBox[{"invwrapper", "[", "y_", "]"}]}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Reconvert", " ", "the", " ", "inwrapper", " ", "to", " ", "the", " ", 
       "inverse", " ", "power", " ", "of", " ", "a", " ", "wrapper"}], "*)"}],
      "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_", "]"}], ":=", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x", "]"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Next", " ", "we", " ", "want", " ", "the", " ", "wrapper", " ", "to", 
        " ", "be", " ", "ready", " ", "to", " ", "actually", " ", "do", " ", 
        "stuff"}], ",", " ", 
       RowBox[{
       "so", " ", "we", " ", "group", " ", "things", " ", "together", " ", 
        "in", " ", 
        RowBox[{"lists", ":", " ", "aa"}]}], ",", "bb", ",", 
       RowBox[{"ab", " ", "and", " ", "ba", " ", "separate"}], ",", " ", 
       RowBox[{
       "along", " ", "with", " ", "the", " ", "product", " ", "of", " ", 
        "already", " ", "used", " ", 
        RowBox[{"stuff", ".", " ", "First"}], " ", "convert", " ", 
        "arguments", " ", "of", " ", "wrapper", " ", "to", " ", "a", " ", 
        "list"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "invwrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"f_", "[", "x__", "]"}], "]"}], ":=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"f", "===", "Times"}], ",", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"List", "[", "x", "]"}], "]"}], ",", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"{", "x", "}"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Here", " ", "we", " ", "gather", " ", "the", " ", "objects", " ", 
        "by", " ", "head"}], ",", " ", 
       RowBox[{
       "then", " ", "replace", " ", "powers", " ", "by", " ", "arrays", " ", 
        "with", " ", "correct", " ", "multiplicity"}], ",", " ", 
       RowBox[{
       "and", " ", "finally", " ", "make", "  ", "atable", " ", "with", " ", 
        "the", " ", "elements", " ", "of", " ", "each", " ", "type", " ", 
        "putting", " ", "an", " ", "empty", " ", "list", " ", "for", " ", 
        "the", " ", "missing", " ", 
        RowBox[{"ones", ".", " ", "We"}], " ", "keep", " ", "the", " ", 
        "invwrapper", " ", "as", " ", "an", " ", "external", " ", 
        "container"}], ",", " ", 
       RowBox[{
       "so", " ", "that", " ", "once", " ", "wrapper", " ", "has", " ", 
        "done", " ", 
        RowBox[{"it", "'"}], "s", " ", "job"}], ",", " ", 
       RowBox[{
       "invwrapper", " ", "can", " ", "select", " ", "the", " ", "chain", " ",
         "we", " ", "want"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"wrapper", "[", 
        RowBox[{"1", ",", "1", ",", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"SelectFirst", "[", 
            RowBox[{
             RowBox[{"GatherBy", "[", 
              RowBox[{
               RowBox[{"Flatten", "[", 
                RowBox[{"x", "/.", 
                 RowBox[{"Power", "->", "ConstantArray"}]}], "]"}], ",", 
               "Head"}], "]"}], ",", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "0"}], "]"}], "]"}], "===", "i"}], "&"}], 
              ")"}], ",", 
             RowBox[{"{", "}"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"{", 
              RowBox[{"aa", ",", "ab", ",", "bb"}], "}"}]}], "}"}]}], "]"}]}],
         "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Now", " ", "we", " ", "clear", " ", "the", " ", "invwrapper", " ", 
        "and", " ", "make", " ", "the", " ", "wrapper", " ", "do", " ", "the",
         " ", "magic", " ", "of", " ", 
        RowBox[{"combinatorics", ".", " ", "The"}], " ", "aa"}], ",", "bb", 
       ",", "ba", ",", 
       RowBox[{
       "ab", " ", "objects", " ", "get", " ", "some", " ", "specific", " ", 
        "properties", " ", "which", " ", "is", " ", "what", " ", "will", " ", 
        "build", " ", "the", " ", "chains"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "invwrapper", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"THE", " ", "FOLLOWING", " ", "IS", " ", "WRONG"}], ",", 
          " ", 
          RowBox[{
          "WE", " ", "NEED", " ", "THE", " ", "WRAPPER", " ", "TO", " ", "DO",
            " ", "IT", " ", "BECAUSE", " ", "ALSO", " ", "THE", " ", "ORDER", 
           " ", "OF", " ", "THE", " ", "CONTRACTION", " ", "WITH", " ", "THE",
            " ", "EXTREMA", " ", 
           RowBox[{"MATTERS", ":", " ", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"if", " ", "I", " ", "have"}], " ", "<", "1"}], 
                 "..."}], "1"}], ">", " ", 
               RowBox[{
                RowBox[{"and", " ", "[", 
                 RowBox[{"1", ",", "2"}], "]"}], " ", "I", " ", "need", " ", 
                "both"}], " ", "<", "1"}], "..."}], "12"}]}]}]}], "]"}], " ", 
        "and"}], " ", "-", 
       RowBox[{"[", 
        RowBox[{
         RowBox[{
          RowBox[{"21", "..."}], "1"}], ">"}]}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"aa", " ", "/:", " ", 
        RowBox[{
         RowBox[{"aa", "[", 
          RowBox[{"x1_", ",", "y1___", ",", "z1_"}], "]"}], "*", 
         RowBox[{"ab", "[", 
          RowBox[{"x2__", ",", "x1_"}], "]"}]}], ":=", 
        RowBox[{"aa", "[", 
         RowBox[{"x2", ",", "x1", ",", "y1", ",", "z1"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"aa", " ", "/:", " ", 
        RowBox[{
         RowBox[{"aa", "[", 
          RowBox[{"x1_", ",", "y1___", ",", "z1_"}], "]"}], "*", 
         RowBox[{"ab", "[", 
          RowBox[{"x2__", ",", "z1_"}], "]"}]}], ":=", 
        RowBox[{"aa", "[", 
         RowBox[{"x1", ",", "y1", ",", "z1", ",", 
          RowBox[{"Sequence", "@@", 
           RowBox[{"Reverse", "@", 
            RowBox[{"{", "x2", "}"}]}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"bb", " ", "/:", " ", 
        RowBox[{
         RowBox[{"bb", "[", 
          RowBox[{"x1_", ",", "y1___", ",", "z1_"}], "]"}], "*", 
         RowBox[{"ab", "[", 
          RowBox[{"x1_", ",", "y2__"}], "]"}]}], ":=", 
        RowBox[{"bb", "[", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"Reverse", "@", 
            RowBox[{"{", "y2", "}"}]}]}], ",", "x1", ",", "y1", ",", "z1"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"bb", " ", "/:", " ", 
        RowBox[{
         RowBox[{"bb", "[", 
          RowBox[{"x1_", ",", "y1___", ",", "z1_"}], "]"}], "*", 
         RowBox[{"ab", "[", 
          RowBox[{"z1_", ",", "y2__"}], "]"}]}], ":=", 
        RowBox[{"bb", "[", 
         RowBox[{"x1", ",", "y1", ",", "z1", ",", "y2"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"aa", " ", "/:", " ", 
        RowBox[{
         RowBox[{"aa", "[", 
          RowBox[{"x1_", ",", "y1___", ",", "z1_"}], "]"}], "*", 
         RowBox[{"bb", "[", 
          RowBox[{"x1_", ",", "y2__"}], "]"}]}], ":=", 
        RowBox[{"-", 
         RowBox[{"ab", "[", 
          RowBox[{
           RowBox[{"Sequence", "@@", 
            RowBox[{"Reverse", "@", 
             RowBox[{"{", 
              RowBox[{"x1", ",", "y1", ",", "z1"}], "}"}]}]}], ",", "y2"}], 
          "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"aa", " ", "/:", " ", 
        RowBox[{
         RowBox[{"aa", "[", 
          RowBox[{"x1_", ",", "y1___", ",", "z1_"}], "]"}], "*", 
         RowBox[{"bb", "[", 
          RowBox[{"x2__", ",", "x1_"}], "]"}]}], ":=", 
        RowBox[{"ab", "[", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"Reverse", "@", 
            RowBox[{"{", 
             RowBox[{"x1", ",", "y1", ",", "z1"}], "}"}]}]}], ",", 
          RowBox[{"Sequence", "@@", 
           RowBox[{"Reverse", "@", 
            RowBox[{"{", "x2", "}"}]}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"aa", " ", "/:", " ", 
        RowBox[{
         RowBox[{"aa", "[", 
          RowBox[{"x1_", ",", "y1___", ",", "z1_"}], "]"}], "*", 
         RowBox[{"bb", "[", 
          RowBox[{"z1_", ",", "y2__"}], "]"}]}], ":=", 
        RowBox[{"ab", "[", 
         RowBox[{"x1", ",", "y1", ",", "z1", ",", "y2"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"aa", " ", "/:", " ", 
        RowBox[{
         RowBox[{"aa", "[", 
          RowBox[{"x1_", ",", "y1___", ",", "z1_"}], "]"}], "*", 
         RowBox[{"bb", "[", 
          RowBox[{"x2__", ",", "z1_"}], "]"}]}], ":=", 
        RowBox[{"-", 
         RowBox[{"ab", "[", 
          RowBox[{"x1", ",", "y1", ",", "z1", ",", 
           RowBox[{"Sequence", "@@", 
            RowBox[{"Reverse", "@", 
             RowBox[{"{", "x2", "}"}]}]}]}], "]"}]}]}], ";"}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Return", " ", "the", " ", "function"}], "*)"}], 
     "\[IndentingNewLine]", "local"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.8462456814201593`*^9, 3.846245825156507*^9}, {
   3.84624588041416*^9, 3.846246059525483*^9}, {3.846246159961267*^9, 
   3.846246506356346*^9}, {3.8462465588496513`*^9, 3.846246776938932*^9}, {
   3.8462468211574593`*^9, 3.846246821357975*^9}, {3.8462469009381323`*^9, 
   3.846247006582032*^9}, {3.846247070132245*^9, 3.846247149644244*^9}, {
   3.846247374359428*^9, 3.8462474663508*^9}, {3.8462475097111187`*^9, 
   3.846247529989496*^9}, 3.846247663407776*^9, {3.846247846840952*^9, 
   3.8462478514860983`*^9}, {3.846247998536194*^9, 3.8462482085672503`*^9}, {
   3.8462483680399227`*^9, 3.8462486484817333`*^9}, {3.8462487027049007`*^9, 
   3.846248724368257*^9}, {3.846248797143999*^9, 3.846248816218581*^9}, {
   3.8462488954114532`*^9, 3.846249049858389*^9}, {3.846249189482415*^9, 
   3.8462493254442596`*^9}, {3.846249385925198*^9, 3.846249487653274*^9}, {
   3.846249544221499*^9, 3.846249546222382*^9}, {3.846249589856963*^9, 
   3.84624967719884*^9}, {3.8462502101602983`*^9, 3.8462502823829317`*^9}, {
   3.8466736897255898`*^9, 
   3.8466737132423563`*^9}},ExpressionUUID->"ba6287bc-50e6-419f-84d2-\
90f26483d92d"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"7", "*", "z", "*", 
   TemplateBox[{"1", "2"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"2", "3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "4"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "5"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   RowBox[{
    TemplateBox[{"5", "6"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}], 
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "/", 
    RowBox[{"(", 
     RowBox[{
      TemplateBox[{"p1", "p2"},
       "SpinorAngleBracket",
       DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
          RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
       InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
          RowBox[{#, ",", #2}], "]"}]& )], 
      RowBox[{
       TemplateBox[{"p2", "p3"},
        "SpinorSquareBracket",
        DisplayFunction->(RowBox[{"[", 
           RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}], "//", 
  "PreChain"}]], "Input",
 CellChangeTimes->{{3.846242173509924*^9, 3.846242231112877*^9}, {
  3.846246116586875*^9, 3.846246150278006*^9}, {3.8462461817347727`*^9, 
  3.846246182158164*^9}, {3.846246578013474*^9, 3.846246578378786*^9}, {
  3.846247680110651*^9, 3.846247683789065*^9}},
 CellLabel->"In[5]:=",ExpressionUUID->"ba3f9ba6-bfbe-4ccd-9234-e701af655803"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(", 
   RowBox[{"7", " ", "z", " ", 
    RowBox[{"invwrapper", "[", 
     RowBox[{"wrapper", "[", 
      RowBox[{"1", ",", "1", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"aa", "[", 
            RowBox[{"1", ",", "2"}], "]"}], ",", 
           RowBox[{"aa", "[", 
            RowBox[{"3", ",", "4"}], "]"}], ",", 
           RowBox[{"aa", "[", 
            RowBox[{"3", ",", "5"}], "]"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"ab", "[", 
           RowBox[{"7", ",", "8", ",", "9"}], "]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"bb", "[", 
            RowBox[{"2", ",", "3"}], "]"}], ",", 
           RowBox[{"bb", "[", 
            RowBox[{"5", ",", "6"}], "]"}], ",", 
           RowBox[{"bb", "[", 
            RowBox[{"5", ",", "6"}], "]"}]}], "}"}]}], "}"}]}], "]"}], 
     "]"}]}], ")"}], "/", 
  RowBox[{"invwrapper", "[", 
   RowBox[{"wrapper", "[", 
    RowBox[{"1", ",", "1", ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"aa", "[", 
         RowBox[{"p1", ",", "p2"}], "]"}], "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"bb", "[", 
          RowBox[{"p2", ",", "p3"}], "]"}], ",", 
         RowBox[{"bb", "[", 
          RowBox[{"p2", ",", "p3"}], "]"}]}], "}"}]}], "}"}]}], "]"}], 
   "]"}]}]], "Output",
 CellChangeTimes->{
  3.84624611997372*^9, 3.846246151308091*^9, 3.846246183552204*^9, 
   3.846246235365589*^9, 3.846246376832349*^9, {3.846246424554968*^9, 
   3.846246439031102*^9}, 3.846246471934087*^9, 3.846246579394256*^9, 
   3.846246688354754*^9, 3.8462470081212587`*^9, {3.8462470922578087`*^9, 
   3.846247121462365*^9}, {3.846247445871354*^9, 3.846247467791078*^9}, {
   3.846247668496654*^9, 3.846247685000882*^9}, {3.846248016852743*^9, 
   3.846248049962275*^9}, 3.8462484455387506`*^9, {3.846248476005752*^9, 
   3.8462484847031097`*^9}, 3.846248535328216*^9, 3.846249757710393*^9, 
   3.846667513813611*^9, 3.846673693242999*^9},
 CellLabel->"Out[5]=",ExpressionUUID->"d7a7aaa4-9e21-48e4-9ed1-18ef1e89ce23"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["Preprocessing continued", "Subsection",
 CellChangeTimes->{{3.846245675277483*^9, 3.846245677621294*^9}, {
  3.846673722916071*^9, 
  3.846673724332143*^9}},ExpressionUUID->"6ce3182f-5b23-4073-9124-\
f454d656bbcb"],

Cell[BoxData[
 RowBox[{
  RowBox[{"PreChain", "[", "exp_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "aa", ",", "bb", ",", "ab", ",", "wrapper", ",", "invwrapper", ",", 
      "local", ",", "SpinorAngleBracket", ",", "SpinorSquareBracket", ",", 
      "Chain"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"local", "=", "exp"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Convert", " ", "all", " ", "the", " ", "chains", " ", "and", " ", 
       "spinor", " ", "brackets", " ", "into", " ", "simpler", " ", "objects",
        " ", "and", " ", "wrap", " ", "them", " ", "into", " ", "a", " ", 
       "function", " ", "which", " ", "will", " ", "chain", " ", "them"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpinorAngleBracket", "[", "x__", "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"aa", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpinorSquareBracket", "[", "x__", "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"bb", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x__", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"aa", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x__", ",", "$square"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"ab", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x__", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"ab", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Reverse", "@", 
          RowBox[{"Flatten", "@", 
           RowBox[{"{", "x", "}"}]}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x__", ",", "$square"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"bb", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Define", " ", "properties", " ", "of", " ", "the", " ", "wrapper", 
        " ", "so", " ", "that", " ", "it", " ", "wraps", " ", "everything", 
        " ", "together"}], ",", " ", 
       RowBox[{"taking", " ", "care", " ", "of", " ", "the", " ", 
        RowBox[{"powers", ".", " ", "Inverse"}], " ", "powers", " ", "are", 
        " ", "the", " ", "reason", " ", "we", " ", "need", " ", "the", " ", 
        "auxiliary", " ", "invwrapper"}], ",", " ", 
       RowBox[{
        RowBox[{
        "this", " ", "would", " ", "be", " ", "needed", " ", "if", " ", "we", 
         " ", "could", " ", "go", " ", "deeper", " ", "with", " ", "the", " ",
          "upvalues", " ", "of", " ", "wrapper"}], "..."}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{
       RowBox[{"wrapper", "[", "x_", "]"}], "*", 
       RowBox[{"wrapper", "[", "y_", "]"}]}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x_", "]"}], ",", 
        RowBox[{"n_", "?", "Positive"}]}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"Power", "[", 
        RowBox[{"x", ",", "n"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x_", "]"}], ",", 
        RowBox[{"n_", "?", "Negative"}]}], "]"}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"Power", "[", 
        RowBox[{"x", ",", 
         RowBox[{"-", "n"}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"invwrapper", " ", "/:", " ", 
      RowBox[{
       RowBox[{"invwrapper", "[", "x_", "]"}], "*", 
       RowBox[{"invwrapper", "[", "y_", "]"}]}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Reconvert", " ", "the", " ", "inwrapper", " ", "to", " ", "the", " ", 
       "inverse", " ", "power", " ", "of", " ", "a", " ", "wrapper"}], "*)"}],
      "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_", "]"}], ":=", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x", "]"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Next", " ", "we", " ", "want", " ", "the", " ", "wrapper", " ", "to", 
        " ", "be", " ", "ready", " ", "to", " ", "actually", " ", "do", " ", 
        "stuff"}], ",", " ", 
       RowBox[{
       "so", " ", "we", " ", "group", " ", "things", " ", "together", " ", 
        "in", " ", 
        RowBox[{"lists", ":", " ", "aa"}]}], ",", "bb", ",", 
       RowBox[{"ab", " ", "and", " ", "ba", " ", "separate"}], ",", " ", 
       RowBox[{
       "along", " ", "with", " ", "the", " ", "product", " ", "of", " ", 
        "already", " ", "used", " ", 
        RowBox[{"stuff", ".", " ", "First"}], " ", "convert", " ", 
        "arguments", " ", "of", " ", "wrapper", " ", "to", " ", "a", " ", 
        "list"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "invwrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"f_", "[", "x__", "]"}], "]"}], ":=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"f", "===", "Times"}], ",", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"List", "[", "x", "]"}], "]"}], ",", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"{", "x", "}"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Here", " ", "we", " ", "gather", " ", "the", " ", "objects", " ", 
        "by", " ", "head"}], ",", " ", 
       RowBox[{
       "then", " ", "replace", " ", "powers", " ", "by", " ", "arrays", " ", 
        "with", " ", "correct", " ", "multiplicity"}], ",", " ", 
       RowBox[{
       "and", " ", "finally", " ", "make", "  ", "atable", " ", "with", " ", 
        "the", " ", "elements", " ", "of", " ", "each", " ", "type", " ", 
        "putting", " ", "an", " ", "empty", " ", "list", " ", "for", " ", 
        "the", " ", "missing", " ", 
        RowBox[{"ones", ".", " ", "We"}], " ", "keep", " ", "the", " ", 
        "invwrapper", " ", "as", " ", "an", " ", "external", " ", 
        "container"}], ",", " ", 
       RowBox[{
       "so", " ", "that", " ", "once", " ", "wrapper", " ", "has", " ", 
        "done", " ", 
        RowBox[{"it", "'"}], "s", " ", "job"}], ",", " ", 
       RowBox[{
       "invwrapper", " ", "can", " ", "select", " ", "the", " ", "chain", " ",
         "we", " ", "want"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"wrapper", "[", 
        RowBox[{"1", ",", "1", ",", 
         RowBox[{"Sequence", "@@", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"SelectFirst", "[", 
             RowBox[{
              RowBox[{"GatherBy", "[", 
               RowBox[{
                RowBox[{"Flatten", "[", 
                 RowBox[{"x", "/.", 
                  RowBox[{"Power", "->", "ConstantArray"}]}], "]"}], ",", 
                "Head"}], "]"}], ",", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                 RowBox[{"#", "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", "0"}], "]"}], "]"}], "===", "i"}], "&"}],
                ")"}], ",", 
              RowBox[{"{", "}"}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{"{", 
               RowBox[{"aa", ",", "ab", ",", "bb"}], "}"}]}], "}"}]}], 
           "]"}]}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Now", " ", "we", " ", "clear", " ", "the", " ", "invwrapper", " ", 
        "and", " ", "make", " ", "the", " ", "wrapper", " ", "do", " ", "the",
         " ", "magic", " ", "of", " ", 
        RowBox[{"combinatorics", ".", " ", "The"}], " ", "aa"}], ",", "bb", 
       ",", "ba", ",", 
       RowBox[{
       "ab", " ", "objects", " ", "get", " ", "some", " ", "specific", " ", 
        "properties", " ", "which", " ", "is", " ", "what", " ", "will", " ", 
        "build", " ", "the", " ", "chains"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "invwrapper", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"The", " ", "wrapper", " ", "acts", " ", "recursively"}], ",", 
       " ", 
       RowBox[{"testing", " ", "its", " ", "second", " ", 
        RowBox[{"argument", "'"}], "s", " ", "head", " ", "and", " ", 
        "accordingly", " ", "combining", " ", "it", " ", "with", " ", "one", 
        " ", "of", " ", "the", " ", "elements", " ", "in", " ", "the", " ", 
        "lists", " ", "of", " ", 
        RowBox[{"brackets", ".", " ", "If"}], " ", "no", " ", "combination", 
        " ", "is", " ", "possible", " ", "the", " ", "second", " ", 
        "argument", " ", "is", " ", "merged", " ", "with", " ", "the", " ", 
        "first", " ", "one", " ", "and", " ", "a", " ", "new", " ", "cycle", 
        " ", 
        RowBox[{"begins", ".", " ", "Termination"}], " ", "condition", " ", 
        "is", " ", "that", " ", "all", " ", "lists", " ", "are", " ", 
        "empty"}]}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Termination", " ", "condition"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "y_", ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}]}], "]"}], ":=", 
      RowBox[{"x", "*", "y"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"The", " ", "starting", " ", "point"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "1", ",", "a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{"a", "=!=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"x", ",", 
          RowBox[{"First", "@", "a"}], ",", 
          RowBox[{"Rest", "@", "a"}], ",", "b", ",", "c"}], "]"}], ",", 
        RowBox[{"b", "=!=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"x", ",", 
          RowBox[{"First", "@", "b"}], ",", "a", ",", 
          RowBox[{"Rest", "@", "b"}], ",", "c"}], "]"}], ",", 
        RowBox[{"c", "=!=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"x", ",", 
          RowBox[{"First", "@", "c"}], ",", "a", ",", "b", ",", 
          RowBox[{"Rest", "@", "c"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "If", " ", "any", " ", "two", " ", "of", " ", "the", " ", "lists", " ", 
       "are", " ", "empty", " ", "there", " ", "is", " ", "nothing", " ", 
       "to", " ", "be", " ", 
       RowBox[{"done", "."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "y_", ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}], ",", "a_"}], "]"}], ":=", 
      RowBox[{"x", "*", "y", "*", 
       RowBox[{"Times", "@@", "a"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "y_", ",", 
        RowBox[{"{", "}"}], ",", "a_", ",", 
        RowBox[{"{", "}"}]}], "]"}], ":=", 
      RowBox[{"x", "*", "y", "*", 
       RowBox[{"Times", "@@", "a"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "y_", ",", "a_", ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}]}], "]"}], ":=", 
      RowBox[{"x", "*", "y", "*", 
       RowBox[{"Times", "@@", "a"}]}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"GENERAL", " ", 
       RowBox[{"QUESTION", ":", " ", 
        RowBox[{"is", " ", "this", " ", "pattern", " ", "matching", " ", 
         RowBox[{"aa", "[", 
          RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], " ", "faster", " ", 
         "or", " ", "is", " ", 
         RowBox[{"aa", "[", "x__", "]"}], " ", "with", " ", "calling", " ", 
         RowBox[{"First", "@", "x"}], " ", "every", " ", "time", " ", 
         RowBox[{"faster", "?"}]}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Entry", " ", "is", " ", "aa"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "If", " ", "upon", " ", "parsing", " ", "the", " ", "lists", " ", "of",
         " ", "objects", " ", "and", " ", "making", " ", "all", " ", "the", 
        " ", "possible", " ", "contractions", " ", "an", " ", "empty", " ", 
        "list", " ", "is", " ", "returned"}], ",", " ", 
       RowBox[{
       "we", " ", "need", " ", "to", " ", "move", " ", "the", " ", "input", 
        " ", "entry", " ", "to", " ", "the", " ", "overall", " ", "product", 
        " ", "but", " ", "and", " ", "start", " ", "a", " ", "new", " ", 
        "iteration"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"ex_", ",", 
        RowBox[{"aa", "[", 
         RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], ",", "a_", ",", "b_", 
        ",", "c_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", "===", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"ftest", "[", 
           RowBox[{
            RowBox[{"ex", "*", 
             RowBox[{"aa", "[", 
              RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ",", "1", ",", "a", 
            ",", "b", ",", "c"}], "]"}], ",", "#"}], "]"}], "&"}], "@", 
       "\[IndentingNewLine]", 
       RowBox[{"Join", "[", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "Combining", " ", "the", " ", "last", " ", "entry", " ", "of", " ", 
          "the", " ", "aa", " ", "with", " ", "all", " ", "the", " ", "first",
           " ", "entries", " ", "of", " ", "the", " ", "bb"}], "*)"}], 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1"}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"ab", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"List", "@@", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ")"}]}]}], "]"}], ",", 
               "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "Combining", " ", "the", " ", "last", " ", "entry", " ", "of", " ", 
           "aa", " ", "with", " ", "the", " ", "last", " ", "of", " ", "ab", 
           " ", "and", " ", "bb"}], "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"b", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"b", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}]}], "]"}], ",", 
               "a", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"b", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}], ",", "c"}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "b"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"ab", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}]}], "]"}], ",", 
               "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "First", " ", "entry", " ", "of", " ", "aa", " ", "with", " ", 
           "first", " ", "of", " ", "bb"}], "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1"}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"ab", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"{", 
                    RowBox[{"y", ",", "z"}], "}"}]}]}], ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}], "]"}], ",", 
               "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{
          "First", " ", "of", " ", "aa", " ", "with", " ", "last", " ", "of", 
           " ", "ab"}], "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"b", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"aa", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"b", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", "y", ",", 
                 "z"}], "]"}], ",", "a", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"b", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}], ",", "c"}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "b"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"First", " ", "aa", " ", "with", " ", "last", " ", "bb"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"ab", "[", 
                RowBox[{"Sequence", "@@", 
                 RowBox[{"Reverse", "@", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", "y", ",", 
                    "z"}], "}"}]}]}], "]"}], ",", "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}]}], "]"}]}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Entry", " ", "in", " ", "ab"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"ex_", ",", 
        RowBox[{"ab", "[", 
         RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], ",", "a_", ",", "b_", 
        ",", "c_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", "===", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"ftest", "[", 
           RowBox[{
            RowBox[{"ex", "*", 
             RowBox[{"ab", "[", 
              RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ",", "1", ",", "a", 
            ",", "b", ",", "c"}], "]"}], ",", "#"}], "]"}], "&"}], "@", 
       RowBox[{"Join", "[", 
        RowBox[{"(*", 
         RowBox[{"Last", " ", "ab", " ", "with", " ", "first", " ", "aa"}], 
         "*)"}], 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"a", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1"}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"a", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}], "]"}], ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"a", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}], ",", "b", ",", "c"}], 
              "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "a"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"Last", " ", "ab", " ", "with", " ", "last", " ", "aa"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"a", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"a", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}]}], "]"}], ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"a", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}], ",", "b", ",", "c"}], 
              "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "a"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"First", " ", "ab", " ", "with", " ", "last", " ", "bb"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"bb", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", "y", ",", 
                 "z"}], "]"}], ",", "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"First", " ", "ab", " ", "with", " ", "first", " ", "bb"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1"}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"bb", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}], ",", "y", ",", 
                 "z"}], "]"}], ",", "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}]}], "]"}]}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Entry", " ", "in", " ", 
        RowBox[{"bb", ".", " ", "We"}], " ", "simply", " ", "plug", " ", "it",
         " ", "back", " ", "into", " ", "the", " ", "bb", " ", "list", " ", 
        "and", " ", "restart"}], ",", " ", 
       RowBox[{
       "so", " ", "we", " ", "recycle", " ", "definitions", " ", "of", " ", 
        "aa", " ", "and", " ", "ab", " ", "above"}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"ex_", ",", 
        RowBox[{"bb", "[", "x__", "]"}], ",", "a_", ",", "b_", ",", "c_"}], 
       "]"}], ":=", 
      RowBox[{"ftest", "[", 
       RowBox[{"ex", ",", "1", ",", "a", ",", "b", ",", 
        RowBox[{"Append", "[", 
         RowBox[{"c", ",", 
          RowBox[{"bb", "[", "x", "]"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"local", "=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"1", ",", 
        RowBox[{"bb", "[", 
         RowBox[{"p5", ",", "p3", ",", "p9"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"aa", "[", 
           RowBox[{"1", ",", "2"}], "]"}], ",", 
          RowBox[{"aa", "[", 
           RowBox[{"4", ",", "9"}], "]"}], ",", 
          RowBox[{"aa", "[", 
           RowBox[{"9", ",", "5"}], "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"ab", "[", 
           RowBox[{"7", ",", "8", ",", "9"}], "]"}], ",", 
          RowBox[{"ab", "[", 
           RowBox[{"1", ",", "2", ",", "9"}], "]"}], ",", 
          RowBox[{"ab", "[", 
           RowBox[{"1", ",", "2", ",", "p1"}], "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"bb", "[", 
           RowBox[{"p1", ",", "3"}], "]"}], ",", 
          RowBox[{"bb", "[", 
           RowBox[{"5", ",", "6"}], "]"}], ",", 
          RowBox[{"bb", "[", 
           RowBox[{"5", ",", "9"}], "]"}], ",", 
          RowBox[{"bb", "[", 
           RowBox[{"2", ",", "4"}], "]"}], ",", 
          RowBox[{"bb", "[", 
           RowBox[{"p2", ",", "p1"}], "]"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Return", " ", "the", " ", "function"}], "*)"}], 
     "\[IndentingNewLine]", "local"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.8462456814201593`*^9, 3.846245825156507*^9}, {
   3.84624588041416*^9, 3.846246059525483*^9}, {3.846246159961267*^9, 
   3.846246506356346*^9}, {3.8462465588496513`*^9, 3.846246776938932*^9}, {
   3.8462468211574593`*^9, 3.846246821357975*^9}, {3.8462469009381323`*^9, 
   3.846247006582032*^9}, {3.846247070132245*^9, 3.846247149644244*^9}, {
   3.846247374359428*^9, 3.8462474663508*^9}, {3.8462475097111187`*^9, 
   3.846247529989496*^9}, 3.846247663407776*^9, {3.846247846840952*^9, 
   3.8462478514860983`*^9}, {3.846247998536194*^9, 3.8462482085672503`*^9}, {
   3.8462483680399227`*^9, 3.8462486484817333`*^9}, {3.8462487027049007`*^9, 
   3.846248724368257*^9}, {3.846248797143999*^9, 3.846248816218581*^9}, {
   3.8462488954114532`*^9, 3.846249049858389*^9}, {3.846249189482415*^9, 
   3.8462493254442596`*^9}, {3.846249385925198*^9, 3.846249487653274*^9}, {
   3.846249544221499*^9, 3.846249546222382*^9}, {3.846249589856963*^9, 
   3.84624967719884*^9}, {3.8462502101602983`*^9, 3.8462502823829317`*^9}, {
   3.8466736897255898`*^9, 3.8466737132423563`*^9}, {3.846673787513953*^9, 
   3.8466738715461493`*^9}, {3.846673957521954*^9, 3.846673984547014*^9}, {
   3.846674145495881*^9, 3.8466742128864717`*^9}, {3.846674595008449*^9, 
   3.846674630136456*^9}, {3.846674694990931*^9, 3.8466747000636473`*^9}, {
   3.8466747961635733`*^9, 3.846674953065852*^9}, {3.8466749914594097`*^9, 
   3.846675024454584*^9}, {3.846675202987584*^9, 3.846675218898118*^9}, {
   3.846675252620487*^9, 3.8466753463304377`*^9}, {3.846675554571374*^9, 
   3.846675660387985*^9}, {3.8466757145470448`*^9, 3.846675822132268*^9}, {
   3.846676264327422*^9, 3.846676282809916*^9}, {3.846676318013103*^9, 
   3.8466763538782*^9}, 3.8466764126300097`*^9, {3.846676467765717*^9, 
   3.846676558822207*^9}, {3.846676738181177*^9, 3.846676742607403*^9}, {
   3.846676775079438*^9, 3.84667680190305*^9}, {3.846676877605699*^9, 
   3.846677019256134*^9}, {3.846677833092266*^9, 3.846677955482648*^9}, {
   3.846678266914877*^9, 3.8466783138718147`*^9}, {3.846678423487372*^9, 
   3.8466785489015512`*^9}, {3.846678590086501*^9, 3.846678590240883*^9}, {
   3.846737994247161*^9, 3.846738004503858*^9}, {3.84673803926145*^9, 
   3.846738043581056*^9}, {3.846738075204897*^9, 3.8467380767987223`*^9}, {
   3.846738324485396*^9, 3.846738363902405*^9}, {3.846738549976481*^9, 
   3.8467386234799957`*^9}, {3.8467386620800943`*^9, 
   3.8467386667625303`*^9}, {3.846738707330525*^9, 3.846738709144993*^9}, {
   3.8467387719995604`*^9, 3.846738802416275*^9}, {3.846738865026211*^9, 
   3.8467388941297913`*^9}, {3.8467390345762873`*^9, 3.846739145036749*^9}, {
   3.846739185086565*^9, 3.8467393313401337`*^9}, {3.846739689354558*^9, 
   3.846739694756753*^9}, {3.8467400608109426`*^9, 3.846740223107369*^9}, {
   3.846740311305922*^9, 3.8467403137190647`*^9}, {3.84674042257513*^9, 
   3.8467404287644377`*^9}, {3.84674073988706*^9, 3.8467408609842367`*^9}, {
   3.846740898995308*^9, 3.846740902645625*^9}, {3.846741092330057*^9, 
   3.846741223363451*^9}, {3.846741273401784*^9, 3.8467413019477367`*^9}, {
   3.846741527121957*^9, 3.846741527308371*^9}, {3.8467415957943*^9, 
   3.846741645888163*^9}, {3.846741748890009*^9, 3.846741839195334*^9}, {
   3.846741884019949*^9, 3.846741998114798*^9}, {3.846742063810554*^9, 
   3.84674210675229*^9}, {3.846742137695187*^9, 3.846742187767593*^9}, {
   3.846742227202767*^9, 3.846742311862904*^9}, {3.846742434968604*^9, 
   3.8467426301567087`*^9}, {3.846742696026381*^9, 3.846742750778027*^9}},
 CellLabel->
  "In[113]:=",ExpressionUUID->"a85f2d44-0fa4-45e2-b100-951bcc12a0cc"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"7", "*", "z", "*", 
   TemplateBox[{"1", "2"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"2", "3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "4"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "5"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   RowBox[{
    TemplateBox[{"5", "6"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}], 
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "/", 
    RowBox[{"(", 
     RowBox[{
      TemplateBox[{"p1", "p2"},
       "SpinorAngleBracket",
       DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
          RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
       InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
          RowBox[{#, ",", #2}], "]"}]& )], 
      RowBox[{
       TemplateBox[{"p2", "p3"},
        "SpinorSquareBracket",
        DisplayFunction->(RowBox[{"[", 
           RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}], "//", 
  "PreChain"}]], "Input",
 CellChangeTimes->{{3.846242173509924*^9, 3.846242231112877*^9}, {
  3.846246116586875*^9, 3.846246150278006*^9}, {3.8462461817347727`*^9, 
  3.846246182158164*^9}, {3.846246578013474*^9, 3.846246578378786*^9}, {
  3.846247680110651*^9, 3.846247683789065*^9}},
 CellLabel->
  "In[114]:=",ExpressionUUID->"92931acd-c407-4adf-b3d5-357469dad063"],

Cell[BoxData[
 RowBox[{"ftest", "[", 
  RowBox[{"1", ",", "1", ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"aa", "[", 
      RowBox[{"1", ",", "2"}], "]"}], ",", 
     RowBox[{"aa", "[", 
      RowBox[{"4", ",", "9"}], "]"}], ",", 
     RowBox[{"aa", "[", 
      RowBox[{"9", ",", "5"}], "]"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"ab", "[", 
      RowBox[{"7", ",", "8", ",", "9"}], "]"}], ",", 
     RowBox[{"ab", "[", 
      RowBox[{"1", ",", "2", ",", "9"}], "]"}], ",", 
     RowBox[{"ab", "[", 
      RowBox[{"1", ",", "2", ",", "p1"}], "]"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"bb", "[", 
      RowBox[{"p1", ",", "3"}], "]"}], ",", 
     RowBox[{"bb", "[", 
      RowBox[{"5", ",", "6"}], "]"}], ",", 
     RowBox[{"bb", "[", 
      RowBox[{"5", ",", "9"}], "]"}], ",", 
     RowBox[{"bb", "[", 
      RowBox[{"2", ",", "4"}], "]"}], ",", 
     RowBox[{"bb", "[", 
      RowBox[{"p2", ",", "p1"}], "]"}], ",", 
     RowBox[{"bb", "[", 
      RowBox[{"p5", ",", "p3", ",", "p9"}], "]"}]}], "}"}]}], "]"}]], "Output",
 CellChangeTimes->{
  3.84624611997372*^9, 3.846246151308091*^9, 3.846246183552204*^9, 
   3.846246235365589*^9, 3.846246376832349*^9, {3.846246424554968*^9, 
   3.846246439031102*^9}, 3.846246471934087*^9, 3.846246579394256*^9, 
   3.846246688354754*^9, 3.8462470081212587`*^9, {3.8462470922578087`*^9, 
   3.846247121462365*^9}, {3.846247445871354*^9, 3.846247467791078*^9}, {
   3.846247668496654*^9, 3.846247685000882*^9}, {3.846248016852743*^9, 
   3.846248049962275*^9}, 3.8462484455387506`*^9, {3.846248476005752*^9, 
   3.8462484847031097`*^9}, 3.846248535328216*^9, 3.846249757710393*^9, 
   3.846667513813611*^9, 3.846673693242999*^9, 3.846674204087784*^9, {
   3.846674935957589*^9, 3.846674954745063*^9}, 3.846675030390892*^9, 
   3.846675206681568*^9, {3.8466752434827557`*^9, 3.846675291700943*^9}, 
   3.846678483068389*^9, {3.846678522601722*^9, 3.846678550403185*^9}, 
   3.8467380114278393`*^9, 3.8467380456997623`*^9, 3.846738078710441*^9, 
   3.84673862739706*^9, 3.846738669944131*^9, 3.846738940403521*^9, 
   3.846739053551709*^9, 3.8467393053039494`*^9, 3.846739336531863*^9, 
   3.846739696777441*^9, 3.846740190453413*^9, 3.8467402249021387`*^9, 
   3.846740869774839*^9, 3.8467409039996853`*^9, 3.846741537562234*^9, {
   3.8467418142038727`*^9, 3.8467418410786247`*^9}, 3.846742010400065*^9, 
   3.846742202063075*^9, 3.846742487301585*^9, 3.846742636959553*^9, {
   3.846742698989911*^9, 3.846742753065506*^9}},
 CellLabel->
  "Out[114]=",ExpressionUUID->"d6625037-8bbe-4fc5-8af8-79538087e9dc"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Drop", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"a", ",", "b", ",", "c", ",", "d", ",", "e"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"3", ",", "5"}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.846674527522703*^9, 3.8466745616556177`*^9}},
 CellLabel->"In[13]:=",ExpressionUUID->"a94ee9cf-19ce-4daf-8e1d-d879f660293a"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"a", ",", "b"}], "}"}]], "Output",
 CellChangeTimes->{{3.8466745337227583`*^9, 3.846674563130909*^9}},
 CellLabel->"Out[13]=",ExpressionUUID->"d410ff37-5556-41ee-a545-713ea2c70da8"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Table", "[", 
  RowBox[{
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{"i", "===", "b"}], ",", "1", ",", "Nothing"}], "]"}], ",", 
   RowBox[{"{", 
    RowBox[{"i", ",", 
     RowBox[{"{", 
      RowBox[{"a", ",", "b", ",", "c"}], "}"}]}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.846675835127018*^9, 3.846675882448163*^9}},
 CellLabel->"In[38]:=",ExpressionUUID->"f8cb976b-03fb-4507-82b4-8406e83c1849"],

Cell[BoxData[
 RowBox[{"{", "1", "}"}]], "Output",
 CellChangeTimes->{{3.846675851771722*^9, 3.846675882680285*^9}},
 CellLabel->"Out[38]=",ExpressionUUID->"81a477e6-0c19-481d-b47b-8d2dc3ca918c"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"Table", "[", 
   RowBox[{
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"i", "===", "5"}], ",", "1", ",", "Nothing"}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "10000"}], "}"}]}], "]"}], "//", 
  "AbsoluteTiming"}]], "Input",
 CellChangeTimes->{{3.846676138207015*^9, 3.846676179213376*^9}, 
   3.846676213004821*^9},
 CellLabel->"In[42]:=",ExpressionUUID->"7b01f067-c0ac-4b49-85d7-377ea4976069"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"0.019417`", ",", 
   RowBox[{"{", "1", "}"}]}], "}"}]], "Output",
 CellChangeTimes->{{3.846676174561108*^9, 3.846676179426866*^9}, 
   3.8466762144272623`*^9},
 CellLabel->"Out[42]=",ExpressionUUID->"71fe96c1-3145-43df-b57d-328ea63575f1"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"DeleteCases", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"i", "===", "5"}], ",", "1"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "10000"}], "}"}]}], "]"}], ",", "Null"}], "]"}], "//",
   "AbsoluteTiming"}]], "Input",
 CellChangeTimes->{{3.8466761944431257`*^9, 3.8466762158421307`*^9}},
 CellLabel->"In[43]:=",ExpressionUUID->"2cb4e89e-20ec-4447-8380-90bd7c60b4bc"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"0.016278`", ",", 
   RowBox[{"{", "1", "}"}]}], "}"}]], "Output",
 CellChangeTimes->{{3.846676205861642*^9, 3.846676216443527*^9}},
 CellLabel->"Out[43]=",ExpressionUUID->"5fa58c5e-9741-4868-8064-5ae5a7d89397"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{"f", "[", 
    RowBox[{"1", ",", "2", ",", "3"}], "]"}], "}"}], "[", 
  RowBox[{"[", 
   RowBox[{"1", ",", "1"}], "]"}], "]"}]], "Input",
 CellChangeTimes->{{3.84667834502227*^9, 3.846678382246582*^9}},
 CellLabel->"In[52]:=",ExpressionUUID->"f5c84b15-f36b-432f-a857-db008503701c"],

Cell[BoxData["1"], "Output",
 CellChangeTimes->{{3.846678355156786*^9, 3.846678382987679*^9}},
 CellLabel->"Out[52]=",ExpressionUUID->"10b16e63-0701-4556-80cf-f5798bbc7930"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["\<\
Recursing the previous test, very slow with high powers of brackets\
\>", "Subsection",
 CellChangeTimes->{{3.846245675277483*^9, 3.846245677621294*^9}, {
  3.846673722916071*^9, 3.846673724332143*^9}, {3.8467427791663427`*^9, 
  3.846742783985442*^9}, {3.846744431908648*^9, 
  3.8467444392345448`*^9}},ExpressionUUID->"e9d95bbe-a245-4546-ab91-\
3b551c64daa4"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{"Options", "[", "PreChain", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"ChainSelection", "->"}], "}"}]}], "*)"}]], "Input",
 CellChangeTimes->{{3.846743508106366*^9, 3.846743528518509*^9}, {
  3.846743605388595*^9, 
  3.846743661255863*^9}},ExpressionUUID->"abe71767-4bd5-4acb-ad61-\
dfe1ec985742"],

Cell[BoxData[
 RowBox[{
  RowBox[{"PreChain", "[", "exp_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "aa", ",", "bb", ",", "ab", ",", "wrapper", ",", "invwrapper", ",", 
      "local", ",", "SpinorAngleBracket", ",", "SpinorSquareBracket", ",", 
      "Chain", ",", "ftest"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"local", "=", "exp"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Convert", " ", "all", " ", "the", " ", "chains", " ", "and", " ", 
       "spinor", " ", "brackets", " ", "into", " ", "simpler", " ", "objects",
        " ", "and", " ", "wrap", " ", "them", " ", "into", " ", "a", " ", 
       "function", " ", "which", " ", "will", " ", "chain", " ", "them"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpinorAngleBracket", "[", "x__", "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"aa", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpinorSquareBracket", "[", "x__", "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"bb", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x__", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"aa", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x__", ",", "$square"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"ab", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x__", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"ab", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Reverse", "@", 
          RowBox[{"Flatten", "@", 
           RowBox[{"{", "x", "}"}]}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x__", ",", "$square"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"bb", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Define", " ", "properties", " ", "of", " ", "the", " ", "wrapper", 
        " ", "so", " ", "that", " ", "it", " ", "wraps", " ", "everything", 
        " ", "together"}], ",", " ", 
       RowBox[{"taking", " ", "care", " ", "of", " ", "the", " ", 
        RowBox[{"powers", ".", " ", "Inverse"}], " ", "powers", " ", "are", 
        " ", "the", " ", "reason", " ", "we", " ", "need", " ", "the", " ", 
        "auxiliary", " ", "invwrapper"}], ",", " ", 
       RowBox[{
        RowBox[{
        "this", " ", "would", " ", "be", " ", "needed", " ", "if", " ", "we", 
         " ", "could", " ", "go", " ", "deeper", " ", "with", " ", "the", " ",
          "upvalues", " ", "of", " ", "wrapper"}], "..."}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{
       RowBox[{"wrapper", "[", "x_", "]"}], "*", 
       RowBox[{"wrapper", "[", "y_", "]"}]}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x_", "]"}], ",", 
        RowBox[{"n_", "?", "Positive"}]}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"Power", "[", 
        RowBox[{"x", ",", "n"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x_", "]"}], ",", 
        RowBox[{"n_", "?", "Negative"}]}], "]"}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"Power", "[", 
        RowBox[{"x", ",", 
         RowBox[{"-", "n"}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"invwrapper", " ", "/:", " ", 
      RowBox[{
       RowBox[{"invwrapper", "[", "x_", "]"}], "*", 
       RowBox[{"invwrapper", "[", "y_", "]"}]}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Reconvert", " ", "the", " ", "inwrapper", " ", "to", " ", "the", " ", 
       "inverse", " ", "power", " ", "of", " ", "a", " ", "wrapper"}], "*)"}],
      "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_", "]"}], ":=", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x", "]"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Next", " ", "we", " ", "want", " ", "the", " ", "wrapper", " ", "to", 
        " ", "be", " ", "ready", " ", "to", " ", "actually", " ", "do", " ", 
        "stuff"}], ",", " ", 
       RowBox[{
       "so", " ", "we", " ", "group", " ", "things", " ", "together", " ", 
        "in", " ", 
        RowBox[{"lists", ":", " ", "aa"}]}], ",", "bb", ",", 
       RowBox[{"ab", " ", "and", " ", "ba", " ", "separate"}], ",", " ", 
       RowBox[{
       "along", " ", "with", " ", "the", " ", "product", " ", "of", " ", 
        "already", " ", "used", " ", 
        RowBox[{"stuff", ".", " ", "First"}], " ", "convert", " ", 
        "arguments", " ", "of", " ", "wrapper", " ", "to", " ", "a", " ", 
        "list"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "invwrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"f_", "[", "x__", "]"}], "]"}], ":=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"f", "===", "Times"}], ",", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"List", "[", "x", "]"}], "]"}], ",", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"{", "x", "}"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Here", " ", "we", " ", "gather", " ", "the", " ", "objects", " ", 
        "by", " ", "head"}], ",", " ", 
       RowBox[{
       "then", " ", "replace", " ", "powers", " ", "by", " ", "arrays", " ", 
        "with", " ", "correct", " ", "multiplicity"}], ",", " ", 
       RowBox[{
       "and", " ", "finally", " ", "make", "  ", "atable", " ", "with", " ", 
        "the", " ", "elements", " ", "of", " ", "each", " ", "type", " ", 
        "putting", " ", "an", " ", "empty", " ", "list", " ", "for", " ", 
        "the", " ", "missing", " ", 
        RowBox[{"ones", ".", " ", "We"}], " ", "keep", " ", "the", " ", 
        "invwrapper", " ", "as", " ", "an", " ", "external", " ", 
        "container"}], ",", " ", 
       RowBox[{
       "so", " ", "that", " ", "once", " ", "wrapper", " ", "has", " ", 
        "done", " ", 
        RowBox[{"it", "'"}], "s", " ", "job"}], ",", " ", 
       RowBox[{
       "invwrapper", " ", "can", " ", "select", " ", "the", " ", "chain", " ",
         "we", " ", "want"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"wrapper", "[", 
        RowBox[{"1", ",", "1", ",", 
         RowBox[{"Sequence", "@@", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"SelectFirst", "[", 
             RowBox[{
              RowBox[{"GatherBy", "[", 
               RowBox[{
                RowBox[{"Flatten", "[", 
                 RowBox[{"x", "/.", 
                  RowBox[{"Power", "->", "ConstantArray"}]}], "]"}], ",", 
                "Head"}], "]"}], ",", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                 RowBox[{"#", "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", "0"}], "]"}], "]"}], "===", "i"}], "&"}],
                ")"}], ",", 
              RowBox[{"{", "}"}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{"{", 
               RowBox[{"aa", ",", "ab", ",", "bb"}], "}"}]}], "}"}]}], 
           "]"}]}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Now", " ", "we", " ", "clear", " ", "the", " ", "invwrapper", " ", 
        "and", " ", "make", " ", "the", " ", "wrapper", " ", "do", " ", "the",
         " ", "magic", " ", "of", " ", 
        RowBox[{"combinatorics", ".", " ", "The"}], " ", "aa"}], ",", "bb", 
       ",", "ba", ",", 
       RowBox[{
       "ab", " ", "objects", " ", "get", " ", "some", " ", "specific", " ", 
        "properties", " ", "which", " ", "is", " ", "what", " ", "will", " ", 
        "build", " ", "the", " ", "chains"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "invwrapper", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"The", " ", "wrapper", " ", "acts", " ", "recursively"}], ",", 
       " ", 
       RowBox[{"testing", " ", "its", " ", "second", " ", 
        RowBox[{"argument", "'"}], "s", " ", "head", " ", "and", " ", 
        "accordingly", " ", "combining", " ", "it", " ", "with", " ", "one", 
        " ", "of", " ", "the", " ", "elements", " ", "in", " ", "the", " ", 
        "lists", " ", "of", " ", 
        RowBox[{"brackets", ".", " ", "If"}], " ", "no", " ", "combination", 
        " ", "is", " ", "possible", " ", "the", " ", "second", " ", 
        "argument", " ", "is", " ", "merged", " ", "with", " ", "the", " ", 
        "first", " ", "one", " ", "and", " ", "a", " ", "new", " ", "cycle", 
        " ", 
        RowBox[{"begins", ".", " ", "Termination"}], " ", "condition", " ", 
        "is", " ", "that", " ", "all", " ", "lists", " ", "are", " ", 
        "empty"}]}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Termination", " ", "condition"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "y_", ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}]}], "]"}], ":=", 
      RowBox[{"x", "*", "y"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"The", " ", "starting", " ", "point"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "1", ",", "a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{"a", "=!=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"x", ",", 
          RowBox[{"First", "@", "a"}], ",", 
          RowBox[{"Rest", "@", "a"}], ",", "b", ",", "c"}], "]"}], ",", 
        RowBox[{"b", "=!=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"x", ",", 
          RowBox[{"First", "@", "b"}], ",", "a", ",", 
          RowBox[{"Rest", "@", "b"}], ",", "c"}], "]"}], ",", 
        RowBox[{"c", "=!=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"x", ",", 
          RowBox[{"First", "@", "c"}], ",", "a", ",", "b", ",", 
          RowBox[{"Rest", "@", "c"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "If", " ", "any", " ", "two", " ", "of", " ", "the", " ", "lists", " ", 
       "are", " ", "empty", " ", "and", " ", "there", " ", "are", " ", "no", 
       " ", "brackets", " ", "in", " ", "the", " ", "second", " ", "slot", 
       " ", "of", " ", "wrapper", " ", "there", " ", "is", " ", "nothing", 
       " ", "to", " ", "be", " ", 
       RowBox[{"done", "."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "1", ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}], ",", "a_"}], "]"}], ":=", 
      RowBox[{"x", "*", 
       RowBox[{"Times", "@@", "a"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "1", ",", 
        RowBox[{"{", "}"}], ",", "a_", ",", 
        RowBox[{"{", "}"}]}], "]"}], ":=", 
      RowBox[{"x", "*", 
       RowBox[{"Times", "@@", "a"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "1", ",", "a_", ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}]}], "]"}], ":=", 
      RowBox[{"x", "*", 
       RowBox[{"Times", "@@", "a"}]}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"GENERAL", " ", 
       RowBox[{"QUESTION", ":", " ", 
        RowBox[{"is", " ", "this", " ", "pattern", " ", "matching", " ", 
         RowBox[{"aa", "[", 
          RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], " ", "faster", " ", 
         "or", " ", "is", " ", 
         RowBox[{"aa", "[", "x__", "]"}], " ", "with", " ", "calling", " ", 
         RowBox[{"First", "@", "x"}], " ", "every", " ", "time", " ", 
         RowBox[{"faster", "?"}]}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Entry", " ", "is", " ", "aa"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "If", " ", "upon", " ", "parsing", " ", "the", " ", "lists", " ", "of",
         " ", "objects", " ", "and", " ", "making", " ", "all", " ", "the", 
        " ", "possible", " ", "contractions", " ", "an", " ", "empty", " ", 
        "list", " ", "is", " ", "returned"}], ",", " ", 
       RowBox[{
       "we", " ", "need", " ", "to", " ", "move", " ", "the", " ", "input", 
        " ", "entry", " ", "to", " ", "the", " ", "overall", " ", "product", 
        " ", "but", " ", "and", " ", "start", " ", "a", " ", "new", " ", 
        "iteration"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"ex_", ",", 
        RowBox[{"aa", "[", 
         RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], ",", "a_", ",", "b_", 
        ",", "c_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", "===", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"ftest", "[", 
           RowBox[{
            RowBox[{"ex", "*", 
             RowBox[{"aa", "[", 
              RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ",", "1", ",", "a", 
            ",", "b", ",", "c"}], "]"}], ",", "#"}], "]"}], "&"}], "@", 
       "\[IndentingNewLine]", 
       RowBox[{"Join", "[", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "Combining", " ", "the", " ", "last", " ", "entry", " ", "of", " ", 
          "the", " ", "aa", " ", "with", " ", "all", " ", "the", " ", "first",
           " ", "entries", " ", "of", " ", "the", " ", "bb"}], "*)"}], 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1"}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"ab", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"List", "@@", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ")"}]}]}], "]"}], ",", 
               "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "Combining", " ", "the", " ", "last", " ", "entry", " ", "of", " ", 
           "aa", " ", "with", " ", "the", " ", "last", " ", "of", " ", "ab", 
           " ", "and", " ", "bb"}], "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"b", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"b", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}]}], "]"}], ",", 
               "a", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"b", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}], ",", "c"}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "b"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"ab", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}]}], "]"}], ",", 
               "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "First", " ", "entry", " ", "of", " ", "aa", " ", "with", " ", 
           "first", " ", "of", " ", "bb"}], "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1"}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"ab", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"{", 
                    RowBox[{"y", ",", "z"}], "}"}]}]}], ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}], "]"}], ",", 
               "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{
          "First", " ", "of", " ", "aa", " ", "with", " ", "last", " ", "of", 
           " ", "ab"}], "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"b", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"aa", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"b", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", "y", ",", 
                 "z"}], "]"}], ",", "a", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"b", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}], ",", "c"}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "b"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"First", " ", "aa", " ", "with", " ", "last", " ", "bb"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"ab", "[", 
                RowBox[{"Sequence", "@@", 
                 RowBox[{"Reverse", "@", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", "y", ",", 
                    "z"}], "}"}]}]}], "]"}], ",", "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}]}], "]"}]}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Entry", " ", "in", " ", "ab"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"ex_", ",", 
        RowBox[{"ab", "[", 
         RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], ",", "a_", ",", "b_", 
        ",", "c_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", "===", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"ftest", "[", 
           RowBox[{
            RowBox[{"ex", "*", 
             RowBox[{"ab", "[", 
              RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ",", "1", ",", "a", 
            ",", "b", ",", "c"}], "]"}], ",", "#"}], "]"}], "&"}], "@", 
       RowBox[{"Join", "[", 
        RowBox[{"(*", 
         RowBox[{"Last", " ", "ab", " ", "with", " ", "first", " ", "aa"}], 
         "*)"}], 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"a", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1"}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"a", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}], "]"}], ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"a", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}], ",", "b", ",", "c"}], 
              "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "a"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"Last", " ", "ab", " ", "with", " ", "last", " ", "aa"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"a", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"a", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}]}], "]"}], ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"a", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}], ",", "b", ",", "c"}], 
              "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "a"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"First", " ", "ab", " ", "with", " ", "last", " ", "bb"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"bb", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", "y", ",", 
                 "z"}], "]"}], ",", "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"First", " ", "ab", " ", "with", " ", "first", " ", "bb"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1"}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"ftest", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"bb", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}]}], ",", "y", ",", 
                 "z"}], "]"}], ",", "a", ",", "b", ",", 
               RowBox[{"Drop", "[", 
                RowBox[{"c", ",", 
                 RowBox[{"{", "i", "}"}]}], "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}]}], "]"}]}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Entry", " ", "in", " ", 
        RowBox[{"bb", ".", " ", "We"}], " ", "simply", " ", "plug", " ", "it",
         " ", "back", " ", "into", " ", "the", " ", "bb", " ", "list", " ", 
        "and", " ", "restart"}], ",", " ", 
       RowBox[{
       "so", " ", "we", " ", "recycle", " ", "definitions", " ", "of", " ", 
        "aa", " ", "and", " ", "ab", " ", "above"}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"ex_", ",", 
        RowBox[{"bb", "[", "x__", "]"}], ",", "a_", ",", "b_", ",", "c_"}], 
       "]"}], ":=", 
      RowBox[{"ftest", "[", 
       RowBox[{"ex", ",", "1", ",", "a", ",", "b", ",", 
        RowBox[{"Append", "[", 
         RowBox[{"c", ",", 
          RowBox[{"bb", "[", "x", "]"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"ftest", "=", "wrapper"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Finally", ",", " ", 
       RowBox[{
       "invwrapper", " ", "flattens", " ", "out", " ", "the", " ", "nested", 
        " ", "lists", " ", "and", " ", "returns", " ", "the", " ", "one", " ",
         "which", " ", "best", " ", "fits", " ", "the", " ", "selection", " ",
         "criterion"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
      RowBox[{"First", "@", 
       RowBox[{"Flatten", "[", "x", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Reconvert", " ", "the", " ", "aa"}], ",", "ab", ",", 
       RowBox[{"bb", " ", "to", " ", "the", " ", "spinor", " ", "objects"}]}],
       "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", 
      RowBox[{
      "SpinorAngleBracket", ",", "SpinorSquareBracket", ",", "Chain"}], "]"}],
      ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"aa", "[", "x__", "]"}], ":=", 
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", 
        RowBox[{"First", "@", 
         RowBox[{"{", "x", "}"}]}], ",", 
        RowBox[{"Most", "@", 
         RowBox[{"Rest", "@", 
          RowBox[{"{", "x", "}"}]}]}], ",", 
        RowBox[{"Last", "@", 
         RowBox[{"{", "x", "}"}]}], ",", "$angle"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"ab", "[", "x__", "]"}], ":=", 
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", 
        RowBox[{"First", "@", 
         RowBox[{"{", "x", "}"}]}], ",", 
        RowBox[{"Most", "@", 
         RowBox[{"Rest", "@", 
          RowBox[{"{", "x", "}"}]}]}], ",", 
        RowBox[{"Last", "@", 
         RowBox[{"{", "x", "}"}]}], ",", "$square"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"bb", "[", "x__", "]"}], ":=", 
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", 
        RowBox[{"First", "@", 
         RowBox[{"{", "x", "}"}]}], ",", 
        RowBox[{"Most", "@", 
         RowBox[{"Rest", "@", 
          RowBox[{"{", "x", "}"}]}]}], ",", 
        RowBox[{"Last", "@", 
         RowBox[{"{", "x", "}"}]}], ",", "$square"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x_", ",", 
        RowBox[{"{", "}"}], ",", "y_", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{"x", ",", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x_", ",", 
        RowBox[{"{", "}"}], ",", "y_", ",", "$square"}], "]"}], ":=", 
      RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{"x", ",", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Return", " ", "the", " ", "function"}], "*)"}], 
     "\[IndentingNewLine]", "local"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.8462456814201593`*^9, 3.846245825156507*^9}, {
   3.84624588041416*^9, 3.846246059525483*^9}, {3.846246159961267*^9, 
   3.846246506356346*^9}, {3.8462465588496513`*^9, 3.846246776938932*^9}, {
   3.8462468211574593`*^9, 3.846246821357975*^9}, {3.8462469009381323`*^9, 
   3.846247006582032*^9}, {3.846247070132245*^9, 3.846247149644244*^9}, {
   3.846247374359428*^9, 3.8462474663508*^9}, {3.8462475097111187`*^9, 
   3.846247529989496*^9}, 3.846247663407776*^9, {3.846247846840952*^9, 
   3.8462478514860983`*^9}, {3.846247998536194*^9, 3.8462482085672503`*^9}, {
   3.8462483680399227`*^9, 3.8462486484817333`*^9}, {3.8462487027049007`*^9, 
   3.846248724368257*^9}, {3.846248797143999*^9, 3.846248816218581*^9}, {
   3.8462488954114532`*^9, 3.846249049858389*^9}, {3.846249189482415*^9, 
   3.8462493254442596`*^9}, {3.846249385925198*^9, 3.846249487653274*^9}, {
   3.846249544221499*^9, 3.846249546222382*^9}, {3.846249589856963*^9, 
   3.84624967719884*^9}, {3.8462502101602983`*^9, 3.8462502823829317`*^9}, {
   3.8466736897255898`*^9, 3.8466737132423563`*^9}, {3.846673787513953*^9, 
   3.8466738715461493`*^9}, {3.846673957521954*^9, 3.846673984547014*^9}, {
   3.846674145495881*^9, 3.8466742128864717`*^9}, {3.846674595008449*^9, 
   3.846674630136456*^9}, {3.846674694990931*^9, 3.8466747000636473`*^9}, {
   3.8466747961635733`*^9, 3.846674953065852*^9}, {3.8466749914594097`*^9, 
   3.846675024454584*^9}, {3.846675202987584*^9, 3.846675218898118*^9}, {
   3.846675252620487*^9, 3.8466753463304377`*^9}, {3.846675554571374*^9, 
   3.846675660387985*^9}, {3.8466757145470448`*^9, 3.846675822132268*^9}, {
   3.846676264327422*^9, 3.846676282809916*^9}, {3.846676318013103*^9, 
   3.8466763538782*^9}, 3.8466764126300097`*^9, {3.846676467765717*^9, 
   3.846676558822207*^9}, {3.846676738181177*^9, 3.846676742607403*^9}, {
   3.846676775079438*^9, 3.84667680190305*^9}, {3.846676877605699*^9, 
   3.846677019256134*^9}, {3.846677833092266*^9, 3.846677955482648*^9}, {
   3.846678266914877*^9, 3.8466783138718147`*^9}, {3.846678423487372*^9, 
   3.8466785489015512`*^9}, {3.846678590086501*^9, 3.846678590240883*^9}, {
   3.846737994247161*^9, 3.846738004503858*^9}, {3.84673803926145*^9, 
   3.846738043581056*^9}, {3.846738075204897*^9, 3.8467380767987223`*^9}, {
   3.846738324485396*^9, 3.846738363902405*^9}, {3.846738549976481*^9, 
   3.8467386234799957`*^9}, {3.8467386620800943`*^9, 
   3.8467386667625303`*^9}, {3.846738707330525*^9, 3.846738709144993*^9}, {
   3.8467387719995604`*^9, 3.846738802416275*^9}, {3.846738865026211*^9, 
   3.8467388941297913`*^9}, {3.8467390345762873`*^9, 3.846739145036749*^9}, {
   3.846739185086565*^9, 3.8467393313401337`*^9}, {3.846739689354558*^9, 
   3.846739694756753*^9}, {3.8467400608109426`*^9, 3.846740223107369*^9}, {
   3.846740311305922*^9, 3.8467403137190647`*^9}, {3.84674042257513*^9, 
   3.8467404287644377`*^9}, {3.84674073988706*^9, 3.8467408609842367`*^9}, {
   3.846740898995308*^9, 3.846740902645625*^9}, {3.846741092330057*^9, 
   3.846741223363451*^9}, {3.846741273401784*^9, 3.8467413019477367`*^9}, {
   3.846741527121957*^9, 3.846741527308371*^9}, {3.8467415957943*^9, 
   3.846741645888163*^9}, {3.846741748890009*^9, 3.846741839195334*^9}, {
   3.846741884019949*^9, 3.846741998114798*^9}, {3.846742063810554*^9, 
   3.84674210675229*^9}, {3.846742137695187*^9, 3.846742187767593*^9}, {
   3.846742227202767*^9, 3.846742311862904*^9}, {3.846742434968604*^9, 
   3.8467426301567087`*^9}, {3.846742696026381*^9, 3.846742750778027*^9}, {
   3.846742802984507*^9, 3.8467428167728453`*^9}, {3.846742890066197*^9, 
   3.8467428911290913`*^9}, {3.846743039834488*^9, 3.846743042779208*^9}, {
   3.8467430826284523`*^9, 3.846743096066346*^9}, {3.846743232096546*^9, 
   3.846743308351609*^9}, {3.846743430005843*^9, 3.846743466618582*^9}, {
   3.846743674642068*^9, 3.8467439478485317`*^9}},
 CellLabel->
  "In[135]:=",ExpressionUUID->"d9c46fa1-22be-4264-9fda-3f0631cd3809"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"7", "*", "z", "*", 
   TemplateBox[{"1", "2"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"2", "3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "4"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "5"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   RowBox[{
    TemplateBox[{"5", "6"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}], 
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "/", 
    RowBox[{"(", 
     RowBox[{
      TemplateBox[{"p1", "p2"},
       "SpinorAngleBracket",
       DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
          RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
       InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
          RowBox[{#, ",", #2}], "]"}]& )], 
      RowBox[{
       TemplateBox[{"p2", "p3"},
        "SpinorSquareBracket",
        DisplayFunction->(RowBox[{"[", 
           RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}], "//", 
  "PreChain"}]], "Input",
 CellChangeTimes->{{3.846242173509924*^9, 3.846242231112877*^9}, {
  3.846246116586875*^9, 3.846246150278006*^9}, {3.8462461817347727`*^9, 
  3.846246182158164*^9}, {3.846246578013474*^9, 3.846246578378786*^9}, {
  3.846247680110651*^9, 3.846247683789065*^9}},
 CellLabel->
  "In[136]:=",ExpressionUUID->"c71c2964-1f0e-459b-a3d5-2ae4ac4902d4"],

Cell[BoxData[
 FractionBox[
  RowBox[{"7", " ", "z", " ", 
   TemplateBox[{"1", 
     RowBox[{"{", 
       RowBox[{"2", ",", "3"}], "}"}], "4"},
    "AngleAngleChain",
    DisplayFunction->(
     RowBox[{"\[LeftAngleBracket]", #, #2, #3, "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$angle", 
       "]"}]& )], " ", 
   TemplateBox[{"3", 
     RowBox[{"{", "5", "}"}], "6"},
    "AngleSquareChain",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], " ", 
   TemplateBox[{"7", 
     RowBox[{"{", "8", "}"}], "9"},
    "AngleSquareChain",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], " ", 
   TemplateBox[{"5", "6"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )]}], 
  RowBox[{
   TemplateBox[{"p1", 
     RowBox[{"{", "p2", "}"}], "p3"},
    "AngleSquareChain",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], " ", 
   TemplateBox[{"p2", "p3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )]}]]], "Output",
 CellChangeTimes->{
  3.84624611997372*^9, 3.846246151308091*^9, 3.846246183552204*^9, 
   3.846246235365589*^9, 3.846246376832349*^9, {3.846246424554968*^9, 
   3.846246439031102*^9}, 3.846246471934087*^9, 3.846246579394256*^9, 
   3.846246688354754*^9, 3.8462470081212587`*^9, {3.8462470922578087`*^9, 
   3.846247121462365*^9}, {3.846247445871354*^9, 3.846247467791078*^9}, {
   3.846247668496654*^9, 3.846247685000882*^9}, {3.846248016852743*^9, 
   3.846248049962275*^9}, 3.8462484455387506`*^9, {3.846248476005752*^9, 
   3.8462484847031097`*^9}, 3.846248535328216*^9, 3.846249757710393*^9, 
   3.846667513813611*^9, 3.846673693242999*^9, 3.846674204087784*^9, {
   3.846674935957589*^9, 3.846674954745063*^9}, 3.846675030390892*^9, 
   3.846675206681568*^9, {3.8466752434827557`*^9, 3.846675291700943*^9}, 
   3.846678483068389*^9, {3.846678522601722*^9, 3.846678550403185*^9}, 
   3.8467380114278393`*^9, 3.8467380456997623`*^9, 3.846738078710441*^9, 
   3.84673862739706*^9, 3.846738669944131*^9, 3.846738940403521*^9, 
   3.846739053551709*^9, 3.8467393053039494`*^9, 3.846739336531863*^9, 
   3.846739696777441*^9, 3.846740190453413*^9, 3.8467402249021387`*^9, 
   3.846740869774839*^9, 3.8467409039996853`*^9, 3.846741537562234*^9, {
   3.8467418142038727`*^9, 3.8467418410786247`*^9}, 3.846742010400065*^9, 
   3.846742202063075*^9, 3.846742487301585*^9, 3.846742636959553*^9, {
   3.846742698989911*^9, 3.846742753065506*^9}, 3.846742821663252*^9, 
   3.8467428935453978`*^9, 3.846743044954796*^9, 3.846743099163868*^9, 
   3.8467432608507338`*^9, {3.846743291150421*^9, 3.846743310303846*^9}, 
   3.846743696569893*^9, {3.846743916768108*^9, 3.8467439498985567`*^9}},
 CellLabel->
  "Out[136]=",ExpressionUUID->"eca2e6c6-ca74-4bb6-a078-203b3a2698bf"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"test", "=", 
   RowBox[{"7", "*", "z", "*", 
    TemplateBox[{"1", "2"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    TemplateBox[{"2", "3"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    TemplateBox[{"3", "4"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    TemplateBox[{"3", "5"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    RowBox[{
     TemplateBox[{"5", "6"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}], 
    RowBox[{
     TemplateBox[{"7", 
       RowBox[{"{", "8", "}"}], "9"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "/", 
     RowBox[{"(", 
      RowBox[{
       TemplateBox[{"p1", "p2"},
        "SpinorAngleBracket",
        DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
           RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], 
       RowBox[{
        TemplateBox[{"p2", "p3"},
         "SpinorSquareBracket",
         DisplayFunction->(RowBox[{"[", 
            RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
         InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.846743970308426*^9, 3.846743972693273*^9}},
 CellLabel->
  "In[137]:=",ExpressionUUID->"594a690f-3a09-4e5d-8e3f-6cb678b80b63"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"test", "^", "3"}], "//", "ToChain"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "1000"}], "}"}]}], "]"}], "//", 
  "AbsoluteTiming"}]], "Input",
 CellChangeTimes->{{3.846743979401436*^9, 3.84674399624229*^9}, {
  3.8467440327908*^9, 3.8467440333816767`*^9}},
 CellLabel->
  "In[140]:=",ExpressionUUID->"757222ce-073f-4b86-8e34-60b0af19d556"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"1.243207`", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{3.84674399739345*^9, 3.846744035412333*^9},
 CellLabel->
  "Out[140]=",ExpressionUUID->"7c5ba756-9c36-49da-937a-4f01786b113d"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"test", "^", "2"}], "//", "PreChain"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "1000"}], "}"}]}], "]"}], "//", 
  "AbsoluteTiming"}]], "Input",
 CellChangeTimes->{{3.8467440064319487`*^9, 3.8467440081034946`*^9}, {
  3.846744039308696*^9, 3.846744040548047*^9}, {3.846744117268402*^9, 
  3.846744123980432*^9}},
 CellLabel->
  "In[143]:=",ExpressionUUID->"fdc01fda-42b3-4302-a3c2-fbe3b9063ba2"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"23.594525`", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{
  3.846744009235771*^9, {3.846744114703321*^9, 3.8467441488409843`*^9}},
 CellLabel->
  "Out[143]=",ExpressionUUID->"b3b442fd-6d5c-4b28-bfc5-d9a386733d8e"]
}, Open  ]],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
  "Combinatorics", " ", "of", " ", "terms", " ", "explodes", " ", "with", " ",
    "the", " ", "number", " ", "of", " ", "powers", " ", "in", " ", "each", 
   " ", "bracket"}], "*)"}]], "Input",
 CellChangeTimes->{{3.846744140018464*^9, 
  3.8467441639582148`*^9}},ExpressionUUID->"fc6b4642-44e5-4721-99a5-\
aa7ffcccc7bb"]
}, Closed]],

Cell[CellGroupData[{

Cell["Recursing the previous test, taking care of combinatorics", "Subsection",
 CellChangeTimes->{{3.846245675277483*^9, 3.846245677621294*^9}, {
  3.846673722916071*^9, 3.846673724332143*^9}, {3.8467427791663427`*^9, 
  3.846742783985442*^9}, {3.846744431908648*^9, 
  3.846744456203334*^9}},ExpressionUUID->"00bcdd66-eed0-4157-bed7-\
04ef14501218"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Options", "[", "PreChain", "]"}], "=", 
  RowBox[{"{", 
   RowBox[{"ChainSelection", "->", "\"\<RandomChain\>\""}], "}"}]}]], "Input",
 CellChangeTimes->{{3.846743508106366*^9, 3.846743528518509*^9}, {
  3.846743605388595*^9, 3.846743661255863*^9}, {3.846762618647623*^9, 
  3.846762626770125*^9}},ExpressionUUID->"84959906-c38f-4b6e-a23c-\
1015a0668f45"],

Cell[BoxData[
 RowBox[{
  RowBox[{"PreChain", "[", "exp_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "aa", ",", "bb", ",", "ab", ",", "wrapper", ",", "invwrapper", ",", 
      "local", ",", "SpinorAngleBracket", ",", "SpinorSquareBracket", ",", 
      "Chain", ",", "mult", ",", "tmp"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"local", "=", "exp"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Convert", " ", "all", " ", "the", " ", "chains", " ", "and", " ", 
       "spinor", " ", "brackets", " ", "into", " ", "simpler", " ", "objects",
        " ", "and", " ", "wrap", " ", "them", " ", "into", " ", "a", " ", 
       "function", " ", "which", " ", "will", " ", "chain", " ", "them"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpinorAngleBracket", "[", "x__", "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"aa", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpinorSquareBracket", "[", "x__", "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"bb", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x__", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"aa", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x__", ",", "$square"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"ab", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x__", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"ab", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Reverse", "@", 
          RowBox[{"Flatten", "@", 
           RowBox[{"{", "x", "}"}]}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x__", ",", "$square"}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"bb", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Define", " ", "properties", " ", "of", " ", "the", " ", "wrapper", 
        " ", "so", " ", "that", " ", "it", " ", "wraps", " ", "everything", 
        " ", "together"}], ",", " ", 
       RowBox[{"taking", " ", "care", " ", "of", " ", "the", " ", 
        RowBox[{"powers", ".", " ", "Inverse"}], " ", "powers", " ", "are", 
        " ", "the", " ", "reason", " ", "we", " ", "need", " ", "the", " ", 
        "auxiliary", " ", "invwrapper"}], ",", " ", 
       RowBox[{
        RowBox[{
        "this", " ", "would", " ", "be", " ", "needed", " ", "if", " ", "we", 
         " ", "could", " ", "go", " ", "deeper", " ", "with", " ", "the", " ",
          "upvalues", " ", "of", " ", "wrapper"}], "..."}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{
       RowBox[{"wrapper", "[", "x_", "]"}], "*", 
       RowBox[{"wrapper", "[", "y_", "]"}]}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x_", "]"}], ",", 
        RowBox[{"n_", "?", "Positive"}]}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"Power", "[", 
        RowBox[{"x", ",", "n"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"wrapper", " ", "/:", " ", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x_", "]"}], ",", 
        RowBox[{"n_", "?", "Negative"}]}], "]"}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"Power", "[", 
        RowBox[{"x", ",", 
         RowBox[{"-", "n"}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"invwrapper", " ", "/:", " ", 
      RowBox[{
       RowBox[{"invwrapper", "[", "x_", "]"}], "*", 
       RowBox[{"invwrapper", "[", "y_", "]"}]}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Reconvert", " ", "the", " ", "inwrapper", " ", "to", " ", "the", " ", 
       "inverse", " ", "power", " ", "of", " ", "a", " ", "wrapper"}], "*)"}],
      "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_", "]"}], ":=", 
      RowBox[{"Power", "[", 
       RowBox[{
        RowBox[{"wrapper", "[", "x", "]"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Next", " ", "we", " ", "want", " ", "the", " ", "wrapper", " ", "to", 
        " ", "be", " ", "ready", " ", "to", " ", "actually", " ", "do", " ", 
        "stuff"}], ",", " ", 
       RowBox[{
       "so", " ", "we", " ", "group", " ", "things", " ", "together", " ", 
        "in", " ", 
        RowBox[{"lists", ":", " ", "aa"}]}], ",", "bb", ",", 
       RowBox[{"ab", " ", "and", " ", "ba", " ", "separate"}], ",", " ", 
       RowBox[{
       "along", " ", "with", " ", "the", " ", "product", " ", "of", " ", 
        "already", " ", "used", " ", 
        RowBox[{"stuff", ".", " ", "First"}], " ", "convert", " ", 
        "arguments", " ", "of", " ", "wrapper", " ", "to", " ", "a", " ", 
        "list"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "invwrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"f_", "[", "x__", "]"}], "]"}], ":=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"f", "===", "Times"}], ",", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"List", "[", "x", "]"}], "]"}], ",", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"{", "x", "}"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Here", " ", "we", " ", "gather", " ", "the", " ", "objects", " ", 
        "by", " ", "head"}], ",", " ", 
       RowBox[{
       "then", " ", "replace", " ", "powers", " ", "by", " ", "arrays", " ", 
        "with", " ", "correct", " ", "multiplicity"}], ",", " ", 
       RowBox[{
       "and", " ", "finally", " ", "make", "  ", "atable", " ", "with", " ", 
        "the", " ", "elements", " ", "of", " ", "each", " ", "type", " ", 
        "putting", " ", "an", " ", "empty", " ", "list", " ", "for", " ", 
        "the", " ", "missing", " ", 
        RowBox[{"ones", ".", " ", "We"}], " ", "keep", " ", "the", " ", 
        "invwrapper", " ", "as", " ", "an", " ", "external", " ", 
        "container"}], ",", " ", 
       RowBox[{
       "so", " ", "that", " ", "once", " ", "wrapper", " ", "has", " ", 
        "done", " ", 
        RowBox[{"it", "'"}], "s", " ", "job"}], ",", " ", 
       RowBox[{
       "invwrapper", " ", "can", " ", "select", " ", "the", " ", "chain", " ",
         "we", " ", "want"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
      RowBox[{"invwrapper", "[", 
       RowBox[{"wrapper", "[", 
        RowBox[{"1", ",", "1", ",", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"SelectFirst", "[", 
            RowBox[{
             RowBox[{"GatherBy", "[", 
              RowBox[{
               RowBox[{"Flatten", "[", 
                RowBox[{"x", "/.", 
                 RowBox[{"Power", "->", "ConstantArray"}]}], "]"}], ",", 
               "Head"}], "]"}], ",", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "0"}], "]"}], "]"}], "===", "i"}], "&"}], 
              ")"}], ",", 
             RowBox[{"{", "}"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"{", 
              RowBox[{"aa", ",", "ab", ",", "bb"}], "}"}]}], "}"}]}], "]"}]}],
         "]"}], "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "In", " ", "order", " ", "to", " ", "get", " ", "blown", " ", "out", 
        " ", "of", " ", "the", " ", "water", " ", "by", " ", "combinatorics", 
        " ", "we", " ", "need", " ", "to", " ", "take", " ", "into", " ", 
        "account", " ", "the", " ", "multiplicity", " ", "with", " ", "which",
         " ", "each", " ", "bracket", " ", "appears"}], ",", " ", 
       RowBox[{
        RowBox[{"i", ".", "e", ".", " ", "its"}], " ", 
        RowBox[{"power", ".", " ", "To"}], " ", "do", " ", "so", " ", 
        "\"\<efficiently\>\"", " ", "we", " ", "introduce", " ", "another", 
        " ", "auxiliary", " ", "function"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"1", ",", "1", ",", 
        RowBox[{"{", 
         RowBox[{"a_", ",", "b_", ",", "c_"}], "}"}]}], "]"}], ":=", 
      RowBox[{"wrapper", "[", 
       RowBox[{"1", ",", "1", ",", 
        RowBox[{"mult", "@@@", 
         RowBox[{"Tally", "@", "a"}]}], ",", 
        RowBox[{"mult", "@@@", 
         RowBox[{"Tally", "@", "b"}]}], ",", 
        RowBox[{"mult", "@@@", 
         RowBox[{"Tally", "@", "c"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "When", " ", "multiplicity", " ", "reaches", " ", "zero", " ", "mult", 
       " ", "simply", " ", "drops", " ", "out", " ", "of", " ", "the", " ", 
       "game"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"mult", "[", 
       RowBox[{"x_", ",", "0"}], "]"}], ":=", 
      RowBox[{"Nothing", "[", "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Now", " ", "we", " ", "clear", " ", "the", " ", "invwrapper", " ", 
        "and", " ", "make", " ", "the", " ", "wrapper", " ", "do", " ", "the",
         " ", "magic", " ", "of", " ", 
        RowBox[{"combinatorics", ".", " ", "The"}], " ", "aa"}], ",", "bb", 
       ",", "ba", ",", 
       RowBox[{
       "ab", " ", "objects", " ", "get", " ", "some", " ", "specific", " ", 
        "properties", " ", "which", " ", "is", " ", "what", " ", "will", " ", 
        "build", " ", "the", " ", "chains"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", 
      RowBox[{"invwrapper", ",", "wrapper"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"The", " ", "wrapper", " ", "acts", " ", "recursively"}], ",", 
       " ", 
       RowBox[{"testing", " ", "its", " ", "second", " ", 
        RowBox[{"argument", "'"}], "s", " ", "head", " ", "and", " ", 
        "accordingly", " ", "combining", " ", "it", " ", "with", " ", "one", 
        " ", "of", " ", "the", " ", "elements", " ", "in", " ", "the", " ", 
        "lists", " ", "of", " ", 
        RowBox[{"brackets", ".", " ", "If"}], " ", "no", " ", "combination", 
        " ", "is", " ", "possible", " ", "the", " ", "second", " ", 
        "argument", " ", "is", " ", "merged", " ", "with", " ", "the", " ", 
        "first", " ", "one", " ", "and", " ", "a", " ", "new", " ", "cycle", 
        " ", 
        RowBox[{"begins", ".", " ", "Termination"}], " ", "condition", " ", 
        "is", " ", "that", " ", "all", " ", "lists", " ", "are", " ", 
        "empty"}]}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Termination", " ", "condition"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "y_", ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}]}], "]"}], ":=", 
      RowBox[{"x", "*", "y"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"The", " ", "starting", " ", "point"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "1", ",", "a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{"a", "=!=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"x", ",", 
          RowBox[{"a", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"ReplacePart", "[", 
           RowBox[{"a", ",", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"1", ",", "2"}], "}"}], "->", 
             RowBox[{
              RowBox[{"a", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], "]"}], 
          ",", "b", ",", "c"}], "]"}], ",", 
        RowBox[{"b", "=!=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"x", ",", 
          RowBox[{"b", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", "a", ",", 
          RowBox[{"ReplacePart", "[", 
           RowBox[{"b", ",", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"1", ",", "2"}], "}"}], "->", 
             RowBox[{
              RowBox[{"b", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], "]"}], 
          ",", "c"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "If", " ", "any", " ", "two", " ", "of", " ", "the", " ", "lists", " ", 
       "are", " ", "empty", " ", "and", " ", "there", " ", "are", " ", "no", 
       " ", "brackets", " ", "in", " ", "the", " ", "second", " ", "slot", 
       " ", "of", " ", "wrapper", " ", "there", " ", "is", " ", "nothing", 
       " ", "to", " ", "be", " ", 
       RowBox[{"done", "."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "1", ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}], ",", "a_"}], "]"}], ":=", 
      RowBox[{"x", "*", 
       RowBox[{"Times", "@@", 
        RowBox[{"Power", "@@@", "a"}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "1", ",", 
        RowBox[{"{", "}"}], ",", "a_", ",", 
        RowBox[{"{", "}"}]}], "]"}], ":=", 
      RowBox[{"x", "*", 
       RowBox[{"Times", "@@", 
        RowBox[{"Power", "@@@", "a"}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"x_", ",", "1", ",", "a_", ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", "}"}]}], "]"}], ":=", 
      RowBox[{"x", "*", 
       RowBox[{"Times", "@@", 
        RowBox[{"Power", "@@@", "a"}]}]}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"GENERAL", " ", 
       RowBox[{"QUESTION", ":", " ", 
        RowBox[{"is", " ", "this", " ", "pattern", " ", "matching", " ", 
         RowBox[{"aa", "[", 
          RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], " ", "faster", " ", 
         "or", " ", "is", " ", 
         RowBox[{"aa", "[", "x__", "]"}], " ", "with", " ", "calling", " ", 
         RowBox[{"First", "@", "x"}], " ", "every", " ", "time", " ", 
         RowBox[{"faster", "?"}]}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Entry", " ", "is", " ", "aa"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "If", " ", "upon", " ", "parsing", " ", "the", " ", "lists", " ", "of",
         " ", "objects", " ", "and", " ", "making", " ", "all", " ", "the", 
        " ", "possible", " ", "contractions", " ", "an", " ", "empty", " ", 
        "list", " ", "is", " ", "returned"}], ",", " ", 
       RowBox[{
       "we", " ", "need", " ", "to", " ", "move", " ", "the", " ", "input", 
        " ", "entry", " ", "to", " ", "the", " ", "overall", " ", "product", 
        " ", "but", " ", "and", " ", "start", " ", "a", " ", "new", " ", 
        "iteration"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"ex_", ",", 
        RowBox[{"aa", "[", 
         RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], ",", "a_", ",", "b_", 
        ",", "c_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", "===", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"wrapper", "[", 
           RowBox[{
            RowBox[{"ex", "*", 
             RowBox[{"aa", "[", 
              RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ",", "1", ",", "a", 
            ",", "b", ",", "c"}], "]"}], ",", "#"}], "]"}], "&"}], "@", 
       "\[IndentingNewLine]", 
       RowBox[{"Join", "[", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "Combining", " ", "the", " ", "last", " ", "entry", " ", "of", " ", 
          "the", " ", "aa", " ", "with", " ", "all", " ", "the", " ", "first",
           " ", "entries", " ", "of", " ", "the", " ", "bb"}], "*)"}], 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", "1"}], "]"}], "]"}], "===", "z"}],
              ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"ab", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"List", "@@", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}]}], ")"}]}]}], "]"}],
                ",", "a", ",", "b", ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"c", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "Combining", " ", "the", " ", "last", " ", "entry", " ", "of", " ", 
           "aa", " ", "with", " ", "the", " ", "last", " ", "of", " ", "ab", 
           " ", "and", " ", "bb"}], "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"b", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"b", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}]}], "]"}],
                ",", "a", ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"b", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"b", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}], ",", "c"}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "b"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"ab", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}]}], "]"}],
                ",", "a", ",", "b", ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"c", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "First", " ", "entry", " ", "of", " ", "aa", " ", "with", " ", 
           "first", " ", "of", " ", "bb"}], "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", "1"}], "]"}], "]"}], "===", "x"}],
              ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"ab", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"{", 
                    RowBox[{"y", ",", "z"}], "}"}]}]}], ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}], "]"}], 
               ",", "a", ",", "b", ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"c", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{
          "First", " ", "of", " ", "aa", " ", "with", " ", "last", " ", "of", 
           " ", "ab"}], "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"b", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"aa", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"b", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}], ",", "y", 
                 ",", "z"}], "]"}], ",", "a", ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"b", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"b", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}], ",", "c"}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "b"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"First", " ", "aa", " ", "with", " ", "last", " ", "bb"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"ab", "[", 
                RowBox[{"Sequence", "@@", 
                 RowBox[{"Reverse", "@", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}], ",", "y", 
                    ",", "z"}], "}"}]}]}], "]"}], ",", "a", ",", "b", ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"c", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}]}], "]"}]}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Entry", " ", "in", " ", "ab"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"ex_", ",", 
        RowBox[{"ab", "[", 
         RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], ",", "a_", ",", "b_", 
        ",", "c_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", "===", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"wrapper", "[", 
           RowBox[{
            RowBox[{"ex", "*", 
             RowBox[{"ab", "[", 
              RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ",", "1", ",", "a", 
            ",", "b", ",", "c"}], "]"}], ",", "#"}], "]"}], "&"}], "@", 
       RowBox[{"Join", "[", 
        RowBox[{"(*", 
         RowBox[{"Last", " ", "ab", " ", "with", " ", "first", " ", "aa"}], 
         "*)"}], 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"a", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", "1"}], "]"}], "]"}], "===", "z"}],
              ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"a", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}], "]"}], 
               ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"a", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"a", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}], ",", "b", ",", "c"}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "a"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"Last", " ", "ab", " ", "with", " ", "last", " ", "aa"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"a", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"a", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}]}], "]"}],
                ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"a", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"a", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}], ",", "b", ",", "c"}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "a"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"First", " ", "ab", " ", "with", " ", "last", " ", "bb"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", 
                 RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{"ex", ",", 
               RowBox[{"bb", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}], ",", "y", 
                 ",", "z"}], "]"}], ",", "a", ",", "b", ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"c", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"First", " ", "ab", " ", "with", " ", "first", " ", "bb"}], 
          "*)"}], 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1", ",", "1"}], "]"}], "]"}], "===", "x"}],
              ",", 
             RowBox[{"wrapper", "[", 
              RowBox[{
               RowBox[{"-", "ex"}], ",", 
               RowBox[{"bb", "[", 
                RowBox[{
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"Reverse", "@", 
                   RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}], ",", 
                 "y", ",", "z"}], "]"}], ",", "a", ",", "b", ",", 
               RowBox[{"ReplacePart", "[", 
                RowBox[{"c", ",", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"i", ",", "2"}], "}"}], "->", 
                  RowBox[{
                   RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                "]"}]}], "]"}], ",", 
             RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}]}], "]"}]}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Entry", " ", "in", " ", 
        RowBox[{"bb", ".", " ", "We"}], " ", "simply", " ", "plug", " ", "it",
         " ", "back", " ", "into", " ", "the", " ", "bb", " ", "list", " ", 
        "and", " ", "restart"}], ",", " ", 
       RowBox[{
       "so", " ", "we", " ", "recycle", " ", "definitions", " ", "of", " ", 
        "aa", " ", "and", " ", "ab", " ", "above"}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrapper", "[", 
       RowBox[{"ex_", ",", 
        RowBox[{"bb", "[", "x__", "]"}], ",", "a_", ",", "b_", ",", "c_"}], 
       "]"}], ":=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"tmp", "=", 
           RowBox[{"Flatten", "[", 
            RowBox[{"Position", "[", 
             RowBox[{"c", ",", 
              RowBox[{"bb", "[", "x", "]"}]}], "]"}], "]"}]}], ")"}], "===", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"ex", ",", "1", ",", "a", ",", "b", ",", 
          RowBox[{"Append", "[", 
           RowBox[{"c", ",", 
            RowBox[{"mult", "[", 
             RowBox[{
              RowBox[{"bb", "[", "x", "]"}], ",", "1"}], "]"}]}], "]"}]}], 
         "]"}], ",", 
        RowBox[{"wrapper", "[", 
         RowBox[{"ex", ",", "1", ",", "a", ",", "b", ",", 
          RowBox[{"ReplacePart", "[", 
           RowBox[{"c", ",", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"First", "@", "tmp"}], ",", "2"}], "}"}], "->", 
             RowBox[{
              RowBox[{"c", "[", 
               RowBox[{"[", 
                RowBox[{
                 RowBox[{"First", "@", "tmp"}], ",", "2"}], "]"}], "]"}], "+",
               "1"}]}]}], "]"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Finally", ",", " ", 
       RowBox[{
       "invwrapper", " ", "flattens", " ", "out", " ", "the", " ", "nested", 
        " ", "lists", " ", "and", " ", "returns", " ", "the", " ", "one", " ",
         "which", " ", "best", " ", "fits", " ", "the", " ", "selection", " ",
         "criterion"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
      RowBox[{"First", "@", 
       RowBox[{"Flatten", "[", "x", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Reconvert", " ", "the", " ", "aa"}], ",", "ab", ",", 
       RowBox[{"bb", " ", "to", " ", "the", " ", "spinor", " ", "objects"}]}],
       "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", 
      RowBox[{
      "SpinorAngleBracket", ",", "SpinorSquareBracket", ",", "Chain"}], "]"}],
      ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"aa", "[", "x__", "]"}], ":=", 
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", 
        RowBox[{"First", "@", 
         RowBox[{"{", "x", "}"}]}], ",", 
        RowBox[{"Most", "@", 
         RowBox[{"Rest", "@", 
          RowBox[{"{", "x", "}"}]}]}], ",", 
        RowBox[{"Last", "@", 
         RowBox[{"{", "x", "}"}]}], ",", "$angle"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"ab", "[", "x__", "]"}], ":=", 
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", 
        RowBox[{"First", "@", 
         RowBox[{"{", "x", "}"}]}], ",", 
        RowBox[{"Most", "@", 
         RowBox[{"Rest", "@", 
          RowBox[{"{", "x", "}"}]}]}], ",", 
        RowBox[{"Last", "@", 
         RowBox[{"{", "x", "}"}]}], ",", "$square"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"bb", "[", "x__", "]"}], ":=", 
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", 
        RowBox[{"First", "@", 
         RowBox[{"{", "x", "}"}]}], ",", 
        RowBox[{"Most", "@", 
         RowBox[{"Rest", "@", 
          RowBox[{"{", "x", "}"}]}]}], ",", 
        RowBox[{"Last", "@", 
         RowBox[{"{", "x", "}"}]}], ",", "$square"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$angle", ",", "x_", ",", 
        RowBox[{"{", "}"}], ",", "y_", ",", "$angle"}], "]"}], ":=", 
      RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{"x", ",", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Chain", "[", 
       RowBox[{"$square", ",", "x_", ",", 
        RowBox[{"{", "}"}], ",", "y_", ",", "$square"}], "]"}], ":=", 
      RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{"x", ",", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Return", " ", "the", " ", "function"}], "*)"}], 
     "\[IndentingNewLine]", "local"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.8462456814201593`*^9, 3.846245825156507*^9}, {
   3.84624588041416*^9, 3.846246059525483*^9}, {3.846246159961267*^9, 
   3.846246506356346*^9}, {3.8462465588496513`*^9, 3.846246776938932*^9}, {
   3.8462468211574593`*^9, 3.846246821357975*^9}, {3.8462469009381323`*^9, 
   3.846247006582032*^9}, {3.846247070132245*^9, 3.846247149644244*^9}, {
   3.846247374359428*^9, 3.8462474663508*^9}, {3.8462475097111187`*^9, 
   3.846247529989496*^9}, 3.846247663407776*^9, {3.846247846840952*^9, 
   3.8462478514860983`*^9}, {3.846247998536194*^9, 3.8462482085672503`*^9}, {
   3.8462483680399227`*^9, 3.8462486484817333`*^9}, {3.8462487027049007`*^9, 
   3.846248724368257*^9}, {3.846248797143999*^9, 3.846248816218581*^9}, {
   3.8462488954114532`*^9, 3.846249049858389*^9}, {3.846249189482415*^9, 
   3.8462493254442596`*^9}, {3.846249385925198*^9, 3.846249487653274*^9}, {
   3.846249544221499*^9, 3.846249546222382*^9}, {3.846249589856963*^9, 
   3.84624967719884*^9}, {3.8462502101602983`*^9, 3.8462502823829317`*^9}, {
   3.8466736897255898`*^9, 3.8466737132423563`*^9}, {3.846673787513953*^9, 
   3.8466738715461493`*^9}, {3.846673957521954*^9, 3.846673984547014*^9}, {
   3.846674145495881*^9, 3.8466742128864717`*^9}, {3.846674595008449*^9, 
   3.846674630136456*^9}, {3.846674694990931*^9, 3.8466747000636473`*^9}, {
   3.8466747961635733`*^9, 3.846674953065852*^9}, {3.8466749914594097`*^9, 
   3.846675024454584*^9}, {3.846675202987584*^9, 3.846675218898118*^9}, {
   3.846675252620487*^9, 3.8466753463304377`*^9}, {3.846675554571374*^9, 
   3.846675660387985*^9}, {3.8466757145470448`*^9, 3.846675822132268*^9}, {
   3.846676264327422*^9, 3.846676282809916*^9}, {3.846676318013103*^9, 
   3.8466763538782*^9}, 3.8466764126300097`*^9, {3.846676467765717*^9, 
   3.846676558822207*^9}, {3.846676738181177*^9, 3.846676742607403*^9}, {
   3.846676775079438*^9, 3.84667680190305*^9}, {3.846676877605699*^9, 
   3.846677019256134*^9}, {3.846677833092266*^9, 3.846677955482648*^9}, {
   3.846678266914877*^9, 3.8466783138718147`*^9}, {3.846678423487372*^9, 
   3.8466785489015512`*^9}, {3.846678590086501*^9, 3.846678590240883*^9}, {
   3.846737994247161*^9, 3.846738004503858*^9}, {3.84673803926145*^9, 
   3.846738043581056*^9}, {3.846738075204897*^9, 3.8467380767987223`*^9}, {
   3.846738324485396*^9, 3.846738363902405*^9}, {3.846738549976481*^9, 
   3.8467386234799957`*^9}, {3.8467386620800943`*^9, 
   3.8467386667625303`*^9}, {3.846738707330525*^9, 3.846738709144993*^9}, {
   3.8467387719995604`*^9, 3.846738802416275*^9}, {3.846738865026211*^9, 
   3.8467388941297913`*^9}, {3.8467390345762873`*^9, 3.846739145036749*^9}, {
   3.846739185086565*^9, 3.8467393313401337`*^9}, {3.846739689354558*^9, 
   3.846739694756753*^9}, {3.8467400608109426`*^9, 3.846740223107369*^9}, {
   3.846740311305922*^9, 3.8467403137190647`*^9}, {3.84674042257513*^9, 
   3.8467404287644377`*^9}, {3.84674073988706*^9, 3.8467408609842367`*^9}, {
   3.846740898995308*^9, 3.846740902645625*^9}, {3.846741092330057*^9, 
   3.846741223363451*^9}, {3.846741273401784*^9, 3.8467413019477367`*^9}, {
   3.846741527121957*^9, 3.846741527308371*^9}, {3.8467415957943*^9, 
   3.846741645888163*^9}, {3.846741748890009*^9, 3.846741839195334*^9}, {
   3.846741884019949*^9, 3.846741998114798*^9}, {3.846742063810554*^9, 
   3.84674210675229*^9}, {3.846742137695187*^9, 3.846742187767593*^9}, {
   3.846742227202767*^9, 3.846742311862904*^9}, {3.846742434968604*^9, 
   3.8467426301567087`*^9}, {3.846742696026381*^9, 3.846742750778027*^9}, {
   3.846742802984507*^9, 3.8467428167728453`*^9}, {3.846742890066197*^9, 
   3.8467428911290913`*^9}, {3.846743039834488*^9, 3.846743042779208*^9}, {
   3.8467430826284523`*^9, 3.846743096066346*^9}, {3.846743232096546*^9, 
   3.846743308351609*^9}, {3.846743430005843*^9, 3.846743466618582*^9}, {
   3.846743674642068*^9, 3.8467439478485317`*^9}, {3.846757292491746*^9, 
   3.846757362945348*^9}, {3.8467574294782124`*^9, 3.846757433996887*^9}, {
   3.846757480935882*^9, 3.846757586611937*^9}, {3.846757629917018*^9, 
   3.84675769313622*^9}, {3.846757896979762*^9, 3.846757910077166*^9}, {
   3.846757965876402*^9, 3.846757967126268*^9}, {3.8467580074662857`*^9, 
   3.846758042493403*^9}, {3.8467580851447906`*^9, 3.8467581652888947`*^9}, {
   3.846758283695571*^9, 3.84675830859065*^9}, {3.846759052744413*^9, 
   3.846759201902575*^9}, {3.846759265432683*^9, 3.846759303972077*^9}, {
   3.8467594306671467`*^9, 3.84675944312948*^9}, {3.846759498593891*^9, 
   3.846759580771838*^9}, {3.8467599206609*^9, 3.8467599409392433`*^9}, {
   3.846760047365443*^9, 3.846760301481989*^9}, {3.846760368724524*^9, 
   3.8467603697920437`*^9}, {3.846760465752306*^9, 3.846760595583912*^9}, {
   3.8467606912704678`*^9, 3.846760722904125*^9}, 3.846760861779859*^9, {
   3.84676100367754*^9, 3.846761016091728*^9}, 3.846761054791007*^9, {
   3.8467610993331614`*^9, 3.846761204795373*^9}, {3.8467621585850983`*^9, 
   3.8467621739066877`*^9}, {3.8467622043042917`*^9, 3.846762231589814*^9}, {
   3.8467622809649477`*^9, 3.8467622811161346`*^9}, {3.846762324145405*^9, 
   3.846762333115369*^9}, {3.846762365576317*^9, 3.8467623868763437`*^9}, {
   3.846762459295772*^9, 3.8467624617875357`*^9}, {3.846762521784429*^9, 
   3.846762597208755*^9}},
 CellLabel->
  "In[233]:=",ExpressionUUID->"d03a6935-ab96-4201-b6a0-67a4e93e08ce"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"7", "*", "z", "*", 
   TemplateBox[{"1", "2"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"2", "3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "4"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "5"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   RowBox[{
    TemplateBox[{"5", "6"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}], 
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "/", 
    RowBox[{"(", 
     RowBox[{
      TemplateBox[{"p1", "p2"},
       "SpinorAngleBracket",
       DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
          RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
       InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
          RowBox[{#, ",", #2}], "]"}]& )], 
      RowBox[{
       TemplateBox[{"p2", "p3"},
        "SpinorSquareBracket",
        DisplayFunction->(RowBox[{"[", 
           RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}], "//", 
  "PreChain"}]], "Input",
 CellChangeTimes->{{3.846242173509924*^9, 3.846242231112877*^9}, {
  3.846246116586875*^9, 3.846246150278006*^9}, {3.8462461817347727`*^9, 
  3.846246182158164*^9}, {3.846246578013474*^9, 3.846246578378786*^9}, {
  3.846247680110651*^9, 3.846247683789065*^9}, {3.8467594054913588`*^9, 
  3.846759412790703*^9}},
 CellLabel->
  "In[234]:=",ExpressionUUID->"59659eae-029e-498c-bd5d-ae5fc0efbef5"],

Cell[BoxData[
 FractionBox[
  RowBox[{"7", " ", "z", " ", 
   TemplateBox[{"1", 
     RowBox[{"{", 
       RowBox[{"2", ",", "3"}], "}"}], "4"},
    "AngleAngleChain",
    DisplayFunction->(
     RowBox[{"\[LeftAngleBracket]", #, #2, #3, "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$angle", 
       "]"}]& )], " ", 
   TemplateBox[{"3", 
     RowBox[{"{", "5", "}"}], "6"},
    "AngleSquareChain",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], " ", 
   TemplateBox[{"7", 
     RowBox[{"{", "8", "}"}], "9"},
    "AngleSquareChain",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], " ", 
   TemplateBox[{"5", "6"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )]}], 
  RowBox[{
   TemplateBox[{"p1", 
     RowBox[{"{", "p2", "}"}], "p3"},
    "AngleSquareChain",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], " ", 
   TemplateBox[{"p2", "p3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )]}]]], "Output",
 CellChangeTimes->{
  3.84624611997372*^9, 3.846246151308091*^9, 3.846246183552204*^9, 
   3.846246235365589*^9, 3.846246376832349*^9, {3.846246424554968*^9, 
   3.846246439031102*^9}, 3.846246471934087*^9, 3.846246579394256*^9, 
   3.846246688354754*^9, 3.8462470081212587`*^9, {3.8462470922578087`*^9, 
   3.846247121462365*^9}, {3.846247445871354*^9, 3.846247467791078*^9}, {
   3.846247668496654*^9, 3.846247685000882*^9}, {3.846248016852743*^9, 
   3.846248049962275*^9}, 3.8462484455387506`*^9, {3.846248476005752*^9, 
   3.8462484847031097`*^9}, 3.846248535328216*^9, 3.846249757710393*^9, 
   3.846667513813611*^9, 3.846673693242999*^9, 3.846674204087784*^9, {
   3.846674935957589*^9, 3.846674954745063*^9}, 3.846675030390892*^9, 
   3.846675206681568*^9, {3.8466752434827557`*^9, 3.846675291700943*^9}, 
   3.846678483068389*^9, {3.846678522601722*^9, 3.846678550403185*^9}, 
   3.8467380114278393`*^9, 3.8467380456997623`*^9, 3.846738078710441*^9, 
   3.84673862739706*^9, 3.846738669944131*^9, 3.846738940403521*^9, 
   3.846739053551709*^9, 3.8467393053039494`*^9, 3.846739336531863*^9, 
   3.846739696777441*^9, 3.846740190453413*^9, 3.8467402249021387`*^9, 
   3.846740869774839*^9, 3.8467409039996853`*^9, 3.846741537562234*^9, {
   3.8467418142038727`*^9, 3.8467418410786247`*^9}, 3.846742010400065*^9, 
   3.846742202063075*^9, 3.846742487301585*^9, 3.846742636959553*^9, {
   3.846742698989911*^9, 3.846742753065506*^9}, 3.846742821663252*^9, 
   3.8467428935453978`*^9, 3.846743044954796*^9, 3.846743099163868*^9, 
   3.8467432608507338`*^9, {3.846743291150421*^9, 3.846743310303846*^9}, 
   3.846743696569893*^9, {3.846743916768108*^9, 3.8467439498985567`*^9}, 
   3.846757593809761*^9, 3.846758312350493*^9, {3.846759384728903*^9, 
   3.8467594137807007`*^9}, 3.846759539418352*^9, 3.84676074165191*^9, 
   3.846760865426648*^9, 3.846761060071117*^9, {3.846761184868147*^9, 
   3.8467612065858727`*^9}, 3.846762175936771*^9, {3.846762206121325*^9, 
   3.846762232738701*^9}, 3.8467622830487137`*^9, 3.846762336509307*^9, 
   3.846762389967955*^9, 3.846762464782827*^9, 3.846762543120842*^9, 
   3.846762600048937*^9},
 CellLabel->
  "Out[234]=",ExpressionUUID->"ae64e6b0-b362-41a1-bdff-894b9b7fdfe1"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"test", "=", 
   RowBox[{"7", "*", "z", "*", 
    TemplateBox[{"1", "2"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    TemplateBox[{"2", "3"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    TemplateBox[{"3", "4"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    TemplateBox[{"3", "5"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    RowBox[{
     TemplateBox[{"5", "6"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}], 
    RowBox[{
     TemplateBox[{"7", 
       RowBox[{"{", "8", "}"}], "9"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "/", 
     RowBox[{"(", 
      RowBox[{
       TemplateBox[{"p1", "p2"},
        "SpinorAngleBracket",
        DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
           RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], 
       RowBox[{
        TemplateBox[{"p2", "p3"},
         "SpinorSquareBracket",
         DisplayFunction->(RowBox[{"[", 
            RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
         InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.846743970308426*^9, 3.846743972693273*^9}},
 CellLabel->
  "In[203]:=",ExpressionUUID->"8e855dc2-fa4c-4d99-a710-f6027d1532a6"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"test", "^", "3"}], "//", "ToChain"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "1000"}], "}"}]}], "]"}], "//", 
  "AbsoluteTiming"}]], "Input",
 CellChangeTimes->{{3.846743979401436*^9, 3.84674399624229*^9}, {
  3.8467440327908*^9, 3.8467440333816767`*^9}, {3.846760882878025*^9, 
  3.8467609251739388`*^9}},
 CellLabel->
  "In[208]:=",ExpressionUUID->"95553f6b-bcbf-41f0-adbc-b73f11d7c5b5"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"1.578293`", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{
  3.84674399739345*^9, 3.846744035412333*^9, {3.846760886163323*^9, 
   3.846760927338073*^9}},
 CellLabel->
  "Out[208]=",ExpressionUUID->"a2df510e-138d-4cf1-ac04-43896001a7fc"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"test", "^", "3"}], "//", "PreChain"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "1000"}], "}"}]}], "]"}], "//", 
  "AbsoluteTiming"}]], "Input",
 CellChangeTimes->{{3.8467440064319487`*^9, 3.8467440081034946`*^9}, {
  3.846744039308696*^9, 3.846744040548047*^9}, {3.846744117268402*^9, 
  3.846744123980432*^9}, {3.8467608939367332`*^9, 3.846760930909863*^9}},
 CellLabel->
  "In[209]:=",ExpressionUUID->"448e777a-ebee-4dcf-8a58-03286bb7d0e6"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"3.601811`", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{
  3.846744009235771*^9, {3.846744114703321*^9, 3.8467441488409843`*^9}, {
   3.846760895911515*^9, 3.846760935164515*^9}},
 CellLabel->
  "Out[209]=",ExpressionUUID->"104c8358-9c87-4a16-b5aa-78df5a3537d4"]
}, Open  ]],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
  "Combinatorics", " ", "of", " ", "terms", " ", "explodes", " ", "with", " ",
    "the", " ", "number", " ", "of", " ", "powers", " ", "in", " ", "each", 
   " ", "bracket"}], "*)"}]], "Input",
 CellChangeTimes->{{3.846744140018464*^9, 
  3.8467441639582148`*^9}},ExpressionUUID->"24aa8053-3b2a-43ba-b63c-\
49ec63419239"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"(", 
    RowBox[{"7", "*", "z", "*", 
     TemplateBox[{"1", "2"},
      "SpinorAngleBracket",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
         RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], 
     TemplateBox[{"2", "3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], 
     TemplateBox[{"3", "4"},
      "SpinorAngleBracket",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
         RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], 
     TemplateBox[{"3", "5"},
      "SpinorAngleBracket",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
         RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], 
     RowBox[{
      TemplateBox[{"5", "6"},
       "SpinorSquareBracket",
       DisplayFunction->(RowBox[{"[", 
          RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
       InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
          RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}], 
     RowBox[{
      TemplateBox[{"7", 
        RowBox[{"{", "8", "}"}], "9"},
       "AngleSquareChain",
       DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
       InterpretationFunction->(
        RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
          "$square", "]"}]& )], "/", 
      RowBox[{"(", 
       RowBox[{
        TemplateBox[{"p1", "p2"},
         "SpinorAngleBracket",
         DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
            RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
         InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
            RowBox[{#, ",", #2}], "]"}]& )], 
        RowBox[{
         TemplateBox[{"p2", "p3"},
          "SpinorSquareBracket",
          DisplayFunction->(RowBox[{"[", 
             RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
          InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
             RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}], ")"}], 
   "^", "3"}], "//", "PreChain"}]], "Input",
 CellChangeTimes->{{3.846760953438199*^9, 3.84676095793447*^9}},
 CellLabel->
  "In[210]:=",ExpressionUUID->"1eabf1d2-1c36-476b-abc9-e25d6be5db48"],

Cell[BoxData[
 FractionBox[
  RowBox[{"343", " ", 
   SuperscriptBox["z", "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"1", 
      RowBox[{"{", 
        RowBox[{"2", ",", "3"}], "}"}], "4"},
     "AngleAngleChain",
     DisplayFunction->(
      RowBox[{"\[LeftAngleBracket]", #, #2, #3, "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$angle",
         "]"}]& )], "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"3", 
      RowBox[{"{", "5", "}"}], "6"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"5", "6"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "3"]}], 
  RowBox[{
   SuperscriptBox[
    TemplateBox[{"p1", 
      RowBox[{"{", "p2", "}"}], "p3"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"p2", "p3"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]], "Output",
 CellChangeTimes->{3.8467609586193542`*^9},
 CellLabel->
  "Out[210]=",ExpressionUUID->"760e189e-7d3e-4a6b-ae42-d3e0ced93e75"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["Complete version", "Subsection",
 CellChangeTimes->{{3.846245675277483*^9, 3.846245677621294*^9}, {
  3.846673722916071*^9, 3.846673724332143*^9}, {3.8467427791663427`*^9, 
  3.846742783985442*^9}, {3.846744431908648*^9, 3.846744456203334*^9}, {
  3.846762647055242*^9, 
  3.846762649819271*^9}},ExpressionUUID->"cc73b313-c20a-40ca-a8f5-\
6a296e03e20b"],

Cell[BoxData[
 RowBox[{"ClearAll", "[", "PreChain", "]"}]], "Input",
 CellChangeTimes->{{3.846762785997642*^9, 3.8467627919336576`*^9}},
 CellLabel->
  "In[237]:=",ExpressionUUID->"0f31a181-1666-4060-8076-553724c12f1b"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"Options", "[", "PreChain", "]"}], "=", 
  RowBox[{"{", 
   RowBox[{"ChainSelection", "->", "\"\<RandomChain\>\""}], "}"}]}]], "Input",
 CellChangeTimes->{{3.846743508106366*^9, 3.846743528518509*^9}, {
  3.846743605388595*^9, 3.846743661255863*^9}, {3.846762618647623*^9, 
  3.846762626770125*^9}},
 CellLabel->
  "In[238]:=",ExpressionUUID->"ce725442-8380-448d-87b9-b5c2e12f8cfe"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"ChainSelection", "\[Rule]", "\<\"RandomChain\"\>"}], 
  "}"}]], "Output",
 CellChangeTimes->{3.846762793367238*^9},
 CellLabel->
  "Out[238]=",ExpressionUUID->"96e5a456-6c3b-407d-9088-f9be861f9394"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"PreChain", "[", 
   RowBox[{"exp_", ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "aa", ",", "bb", ",", "ab", ",", "wrapper", ",", "invwrapper", ",", 
      "local", ",", "mult", ",", "tmp"}], "}"}], ",", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "SpinorAngleBracket", ",", "SpinorSquareBracket", ",", "Chain"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"local", "=", "exp"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Convert", " ", "all", " ", "the", " ", "chains", " ", "and", " ", 
         "spinor", " ", "brackets", " ", "into", " ", "simpler", " ", 
         "objects", " ", "and", " ", "wrap", " ", "them", " ", "into", " ", 
         "a", " ", "function", " ", "which", " ", "will", " ", "chain", " ", 
         "them"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"SpinorAngleBracket", "[", "x__", "]"}], ":=", 
        RowBox[{"wrapper", "[", 
         RowBox[{"aa", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"SpinorSquareBracket", "[", "x__", "]"}], ":=", 
        RowBox[{"wrapper", "[", 
         RowBox[{"bb", "[", "x", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Chain", "[", 
         RowBox[{"$angle", ",", "x__", ",", "$angle"}], "]"}], ":=", 
        RowBox[{"wrapper", "[", 
         RowBox[{"aa", "[", 
          RowBox[{"Sequence", "@@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Chain", "[", 
         RowBox[{"$angle", ",", "x__", ",", "$square"}], "]"}], ":=", 
        RowBox[{"wrapper", "[", 
         RowBox[{"ab", "[", 
          RowBox[{"Sequence", "@@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Chain", "[", 
         RowBox[{"$square", ",", "x__", ",", "$angle"}], "]"}], ":=", 
        RowBox[{"wrapper", "[", 
         RowBox[{"ab", "[", 
          RowBox[{"Sequence", "@@", 
           RowBox[{"Reverse", "@", 
            RowBox[{"Flatten", "@", 
             RowBox[{"{", "x", "}"}]}]}]}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Chain", "[", 
         RowBox[{"$square", ",", "x__", ",", "$square"}], "]"}], ":=", 
        RowBox[{"wrapper", "[", 
         RowBox[{"bb", "[", 
          RowBox[{"Sequence", "@@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"{", "x", "}"}]}]}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "Define", " ", "properties", " ", "of", " ", "the", " ", "wrapper", 
          " ", "so", " ", "that", " ", "it", " ", "wraps", " ", "everything", 
          " ", "together"}], ",", " ", 
         RowBox[{"taking", " ", "care", " ", "of", " ", "the", " ", 
          RowBox[{"powers", ".", " ", "Inverse"}], " ", "powers", " ", "are", 
          " ", "the", " ", "reason", " ", "we", " ", "need", " ", "the", " ", 
          "auxiliary", " ", "invwrapper"}], ",", " ", 
         RowBox[{
          RowBox[{
          "this", " ", "would", " ", "be", " ", "needed", " ", "if", " ", 
           "we", " ", "could", " ", "go", " ", "deeper", " ", "with", " ", 
           "the", " ", "upvalues", " ", "of", " ", "wrapper"}], "..."}]}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"wrapper", " ", "/:", " ", 
        RowBox[{
         RowBox[{"wrapper", "[", "x_", "]"}], "*", 
         RowBox[{"wrapper", "[", "y_", "]"}]}], ":=", 
        RowBox[{"wrapper", "[", 
         RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"wrapper", " ", "/:", " ", 
        RowBox[{"Power", "[", 
         RowBox[{
          RowBox[{"wrapper", "[", "x_", "]"}], ",", 
          RowBox[{"n_", "?", "Positive"}]}], "]"}], ":=", 
        RowBox[{"wrapper", "[", 
         RowBox[{"Power", "[", 
          RowBox[{"x", ",", "n"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"wrapper", " ", "/:", " ", 
        RowBox[{"Power", "[", 
         RowBox[{
          RowBox[{"wrapper", "[", "x_", "]"}], ",", 
          RowBox[{"n_", "?", "Negative"}]}], "]"}], ":=", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"Power", "[", 
          RowBox[{"x", ",", 
           RowBox[{"-", "n"}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"invwrapper", " ", "/:", " ", 
        RowBox[{
         RowBox[{"invwrapper", "[", "x_", "]"}], "*", 
         RowBox[{"invwrapper", "[", "y_", "]"}]}], ":=", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"x", "*", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Reconvert", " ", "the", " ", "inwrapper", " ", "to", " ", "the", " ",
          "inverse", " ", "power", " ", "of", " ", "a", " ", "wrapper"}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"invwrapper", "[", "x_", "]"}], ":=", 
        RowBox[{"Power", "[", 
         RowBox[{
          RowBox[{"wrapper", "[", "x", "]"}], ",", 
          RowBox[{"-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "Next", " ", "we", " ", "want", " ", "the", " ", "wrapper", " ", 
          "to", " ", "be", " ", "ready", " ", "to", " ", "actually", " ", 
          "do", " ", "stuff"}], ",", " ", 
         RowBox[{
         "so", " ", "we", " ", "group", " ", "things", " ", "together", " ", 
          "in", " ", 
          RowBox[{"lists", ":", " ", "aa"}]}], ",", "bb", ",", 
         RowBox[{"ab", " ", "and", " ", "ba", " ", "separate"}], ",", " ", 
         RowBox[{
         "along", " ", "with", " ", "the", " ", "product", " ", "of", " ", 
          "already", " ", "used", " ", 
          RowBox[{"stuff", ".", " ", "First"}], " ", "convert", " ", 
          "arguments", " ", "of", " ", "wrapper", " ", "to", " ", "a", " ", 
          "list"}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Clear", "[", "invwrapper", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"f_", "[", "x__", "]"}], "]"}], ":=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"f", "===", "Times"}], ",", 
          RowBox[{"invwrapper", "[", 
           RowBox[{"List", "[", "x", "]"}], "]"}], ",", 
          RowBox[{"invwrapper", "[", 
           RowBox[{"{", "x", "}"}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "Here", " ", "we", " ", "gather", " ", "the", " ", "objects", " ", 
          "by", " ", "head"}], ",", " ", 
         RowBox[{
         "then", " ", "replace", " ", "powers", " ", "by", " ", "arrays", " ",
           "with", " ", "correct", " ", "multiplicity"}], ",", " ", 
         RowBox[{
         "and", " ", "finally", " ", "make", "  ", "atable", " ", "with", " ",
           "the", " ", "elements", " ", "of", " ", "each", " ", "type", " ", 
          "putting", " ", "an", " ", "empty", " ", "list", " ", "for", " ", 
          "the", " ", "missing", " ", 
          RowBox[{"ones", ".", " ", "We"}], " ", "keep", " ", "the", " ", 
          "invwrapper", " ", "as", " ", "an", " ", "external", " ", 
          "container"}], ",", " ", 
         RowBox[{
         "so", " ", "that", " ", "once", " ", "wrapper", " ", "has", " ", 
          "done", " ", 
          RowBox[{"it", "'"}], "s", " ", "job"}], ",", " ", 
         RowBox[{
         "invwrapper", " ", "can", " ", "select", " ", "the", " ", "chain", 
          " ", "we", " ", "want"}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Clear", "[", "wrapper", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
        RowBox[{"invwrapper", "[", 
         RowBox[{"wrapper", "[", 
          RowBox[{"1", ",", "1", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"SelectFirst", "[", 
              RowBox[{
               RowBox[{"GatherBy", "[", 
                RowBox[{
                 RowBox[{"Flatten", "[", 
                  RowBox[{"x", "/.", 
                   RowBox[{"Power", "->", "ConstantArray"}]}], "]"}], ",", 
                 "Head"}], "]"}], ",", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"[", 
                    RowBox[{"1", ",", "0"}], "]"}], "]"}], "===", "i"}], 
                 "&"}], ")"}], ",", 
               RowBox[{"{", "}"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"{", 
                RowBox[{"aa", ",", "ab", ",", "bb"}], "}"}]}], "}"}]}], 
            "]"}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "In", " ", "order", " ", "to", " ", "get", " ", "blown", " ", "out", 
          " ", "of", " ", "the", " ", "water", " ", "by", " ", 
          "combinatorics", " ", "we", " ", "need", " ", "to", " ", "take", 
          " ", "into", " ", "account", " ", "the", " ", "multiplicity", " ", 
          "with", " ", "which", " ", "each", " ", "bracket", " ", "appears"}],
          ",", " ", 
         RowBox[{
          RowBox[{"i", ".", "e", ".", " ", "its"}], " ", 
          RowBox[{"power", ".", " ", "To"}], " ", "do", " ", "so", " ", 
          "\"\<efficiently\>\"", " ", "we", " ", "introduce", " ", "another", 
          " ", "auxiliary", " ", "function"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"1", ",", "1", ",", 
          RowBox[{"{", 
           RowBox[{"a_", ",", "b_", ",", "c_"}], "}"}]}], "]"}], ":=", 
        RowBox[{"wrapper", "[", 
         RowBox[{"1", ",", "1", ",", 
          RowBox[{"mult", "@@@", 
           RowBox[{"Tally", "@", "a"}]}], ",", 
          RowBox[{"mult", "@@@", 
           RowBox[{"Tally", "@", "b"}]}], ",", 
          RowBox[{"mult", "@@@", 
           RowBox[{"Tally", "@", "c"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "When", " ", "multiplicity", " ", "reaches", " ", "zero", " ", "mult",
          " ", "simply", " ", "drops", " ", "out", " ", "of", " ", "the", " ",
          "game"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"mult", "[", 
         RowBox[{"x_", ",", "0"}], "]"}], ":=", 
        RowBox[{"Nothing", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "Now", " ", "we", " ", "clear", " ", "the", " ", "invwrapper", " ", 
          "and", " ", "make", " ", "the", " ", "wrapper", " ", "do", " ", 
          "the", " ", "magic", " ", "of", " ", 
          RowBox[{"combinatorics", ".", " ", "The"}], " ", "aa"}], ",", "bb", 
         ",", "ba", ",", 
         RowBox[{
         "ab", " ", "objects", " ", "get", " ", "some", " ", "specific", " ", 
          "properties", " ", "which", " ", "is", " ", "what", " ", "will", 
          " ", "build", " ", "the", " ", "chains"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"Clear", "[", 
        RowBox[{"invwrapper", ",", "wrapper"}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"The", " ", "wrapper", " ", "acts", " ", "recursively"}], 
         ",", " ", 
         RowBox[{"testing", " ", "its", " ", "second", " ", 
          RowBox[{"argument", "'"}], "s", " ", "head", " ", "and", " ", 
          "accordingly", " ", "combining", " ", "it", " ", "with", " ", "one",
           " ", "of", " ", "the", " ", "elements", " ", "in", " ", "the", " ",
           "lists", " ", "of", " ", 
          RowBox[{"brackets", ".", " ", "If"}], " ", "no", " ", "combination",
           " ", "is", " ", "possible", " ", "the", " ", "second", " ", 
          "argument", " ", "is", " ", "merged", " ", "with", " ", "the", " ", 
          "first", " ", "one", " ", "and", " ", "a", " ", "new", " ", "cycle",
           " ", 
          RowBox[{"begins", ".", " ", "Termination"}], " ", "condition", " ", 
          "is", " ", "that", " ", "all", " ", "lists", " ", "are", " ", 
          "empty"}]}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Termination", " ", "condition"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"x_", ",", "y_", ",", 
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}]}], "]"}], ":=", 
        RowBox[{"x", "*", "y"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"The", " ", "starting", " ", "point"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"x_", ",", "1", ",", "a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
        RowBox[{"Which", "[", 
         RowBox[{
          RowBox[{"a", "=!=", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"wrapper", "[", 
           RowBox[{"x", ",", 
            RowBox[{"a", "[", 
             RowBox[{"[", 
              RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
            RowBox[{"ReplacePart", "[", 
             RowBox[{"a", ",", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"1", ",", "2"}], "}"}], "->", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
             "]"}], ",", "b", ",", "c"}], "]"}], ",", 
          RowBox[{"b", "=!=", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"wrapper", "[", 
           RowBox[{"x", ",", 
            RowBox[{"b", "[", 
             RowBox[{"[", 
              RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", "a", ",", 
            RowBox[{"ReplacePart", "[", 
             RowBox[{"b", ",", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"1", ",", "2"}], "}"}], "->", 
               RowBox[{
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
             "]"}], ",", "c"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "If", " ", "any", " ", "two", " ", "of", " ", "the", " ", "lists", 
         " ", "are", " ", "empty", " ", "and", " ", "there", " ", "are", " ", 
         "no", " ", "brackets", " ", "in", " ", "the", " ", "second", " ", 
         "slot", " ", "of", " ", "wrapper", " ", "there", " ", "is", " ", 
         "nothing", " ", "to", " ", "be", " ", 
         RowBox[{"done", "."}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"x_", ",", "1", ",", 
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}], ",", "a_"}], "]"}], ":=", 
        RowBox[{"x", "*", 
         RowBox[{"Times", "@@", 
          RowBox[{"Power", "@@@", "a"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"x_", ",", "1", ",", 
          RowBox[{"{", "}"}], ",", "a_", ",", 
          RowBox[{"{", "}"}]}], "]"}], ":=", 
        RowBox[{"x", "*", 
         RowBox[{"Times", "@@", 
          RowBox[{"Power", "@@@", "a"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"x_", ",", "1", ",", "a_", ",", 
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}]}], "]"}], ":=", 
        RowBox[{"x", "*", 
         RowBox[{"Times", "@@", 
          RowBox[{"Power", "@@@", "a"}]}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"GENERAL", " ", 
         RowBox[{"QUESTION", ":", " ", 
          RowBox[{"is", " ", "this", " ", "pattern", " ", "matching", " ", 
           RowBox[{"aa", "[", 
            RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], " ", "faster", " ",
            "or", " ", "is", " ", 
           RowBox[{"aa", "[", "x__", "]"}], " ", "with", " ", "calling", " ", 
           RowBox[{"First", "@", "x"}], " ", "every", " ", "time", " ", 
           RowBox[{"faster", "?"}]}]}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Entry", " ", "is", " ", "aa"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "If", " ", "upon", " ", "parsing", " ", "the", " ", "lists", " ", 
          "of", " ", "objects", " ", "and", " ", "making", " ", "all", " ", 
          "the", " ", "possible", " ", "contractions", " ", "an", " ", 
          "empty", " ", "list", " ", "is", " ", "returned"}], ",", " ", 
         RowBox[{
         "we", " ", "need", " ", "to", " ", "move", " ", "the", " ", "input", 
          " ", "entry", " ", "to", " ", "the", " ", "overall", " ", "product",
           " ", "but", " ", "and", " ", "start", " ", "a", " ", "new", " ", 
          "iteration"}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"ex_", ",", 
          RowBox[{"aa", "[", 
           RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], ",", "a_", ",", 
          "b_", ",", "c_"}], "]"}], ":=", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"#", "===", 
             RowBox[{"{", "}"}]}], ",", 
            RowBox[{"wrapper", "[", 
             RowBox[{
              RowBox[{"ex", "*", 
               RowBox[{"aa", "[", 
                RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ",", "1", ",", 
              "a", ",", "b", ",", "c"}], "]"}], ",", "#"}], "]"}], "&"}], "@",
          "\[IndentingNewLine]", 
         RowBox[{"Join", "[", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Combining", " ", "the", " ", "last", " ", "entry", " ", "of", " ",
             "the", " ", "aa", " ", "with", " ", "all", " ", "the", " ", 
            "first", " ", "entries", " ", "of", " ", "the", " ", "bb"}], 
           "*)"}], 
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"c", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", "1"}], "]"}], "]"}], "===", 
                "z"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{"ex", ",", 
                 RowBox[{"ab", "[", 
                  RowBox[{"x", ",", "y", ",", 
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{"List", "@@", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}]}], ")"}]}]}], "]"}],
                  ",", "a", ",", "b", ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"c", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}]}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "Combining", " ", "the", " ", "last", " ", "entry", " ", "of", 
             " ", "aa", " ", "with", " ", "the", " ", "last", " ", "of", " ", 
             "ab", " ", "and", " ", "bb"}], "*)"}], 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", 
                   RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{"ex", ",", 
                 RowBox[{"aa", "[", 
                  RowBox[{"x", ",", "y", ",", 
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "@", 
                    RowBox[{"(", 
                    RowBox[{"b", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}]}], "]"}],
                  ",", "a", ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"b", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"b", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}], ",", "c"}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "b"}]}], "}"}]}], "]"}], ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"c", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", 
                   RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{
                 RowBox[{"-", "ex"}], ",", 
                 RowBox[{"ab", "[", 
                  RowBox[{"x", ",", "y", ",", 
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "@", 
                    RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}]}], "]"}],
                  ",", "a", ",", "b", ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"c", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}]}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "First", " ", "entry", " ", "of", " ", "aa", " ", "with", " ", 
             "first", " ", "of", " ", "bb"}], "*)"}], 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"c", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", "1"}], "]"}], "]"}], "===", 
                "x"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{
                 RowBox[{"-", "ex"}], ",", 
                 RowBox[{"ab", "[", 
                  RowBox[{
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "@", 
                    RowBox[{"{", 
                    RowBox[{"y", ",", "z"}], "}"}]}]}], ",", 
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}], "]"}], 
                 ",", "a", ",", "b", ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"c", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}]}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
           RowBox[{"(*", 
            RowBox[{
            "First", " ", "of", " ", "aa", " ", "with", " ", "last", " ", 
             "of", " ", "ab"}], "*)"}], 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", 
                   RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{"ex", ",", 
                 RowBox[{"aa", "[", 
                  RowBox[{
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{"b", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}], ",", "y", 
                   ",", "z"}], "]"}], ",", "a", ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"b", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"b", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}], ",", "c"}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "b"}]}], "}"}]}], "]"}], ",", 
           RowBox[{"(*", 
            RowBox[{"First", " ", "aa", " ", "with", " ", "last", " ", "bb"}],
             "*)"}], 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"c", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", 
                   RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{"ex", ",", 
                 RowBox[{"ab", "[", 
                  RowBox[{"Sequence", "@@", 
                   RowBox[{"Reverse", "@", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}], ",", "y", 
                    ",", "z"}], "}"}]}]}], "]"}], ",", "a", ",", "b", ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"c", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}]}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}]}], "]"}]}]}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Entry", " ", "in", " ", "ab"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"ex_", ",", 
          RowBox[{"ab", "[", 
           RowBox[{"x_", ",", "y___", ",", "z_"}], "]"}], ",", "a_", ",", 
          "b_", ",", "c_"}], "]"}], ":=", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"#", "===", 
             RowBox[{"{", "}"}]}], ",", 
            RowBox[{"wrapper", "[", 
             RowBox[{
              RowBox[{"ex", "*", 
               RowBox[{"ab", "[", 
                RowBox[{"x", ",", "y", ",", "z"}], "]"}]}], ",", "1", ",", 
              "a", ",", "b", ",", "c"}], "]"}], ",", "#"}], "]"}], "&"}], "@", 
         RowBox[{"Join", "[", 
          RowBox[{"(*", 
           RowBox[{"Last", " ", "ab", " ", "with", " ", "first", " ", "aa"}], 
           "*)"}], 
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", "1"}], "]"}], "]"}], "===", 
                "z"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{"ex", ",", 
                 RowBox[{"aa", "[", 
                  RowBox[{"x", ",", "y", ",", 
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{"a", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}], "]"}], 
                 ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"a", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"a", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}], ",", "b", ",", "c"}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "a"}]}], "}"}]}], "]"}], ",", 
           RowBox[{"(*", 
            RowBox[{"Last", " ", "ab", " ", "with", " ", "last", " ", "aa"}], 
            "*)"}], 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", 
                   RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "z"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{
                 RowBox[{"-", "ex"}], ",", 
                 RowBox[{"aa", "[", 
                  RowBox[{"x", ",", "y", ",", 
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "@", 
                    RowBox[{"(", 
                    RowBox[{"a", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}]}], "]"}],
                  ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"a", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"a", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}], ",", "b", ",", "c"}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "a"}]}], "}"}]}], "]"}], ",", 
           RowBox[{"(*", 
            RowBox[{"First", " ", "ab", " ", "with", " ", "last", " ", "bb"}],
             "*)"}], 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"c", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", 
                   RowBox[{"-", "1"}]}], "]"}], "]"}], "===", "x"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{"ex", ",", 
                 RowBox[{"bb", "[", 
                  RowBox[{
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}], ",", "y", 
                   ",", "z"}], "]"}], ",", "a", ",", "b", ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"c", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}]}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}], ",", 
           RowBox[{"(*", 
            RowBox[{
            "First", " ", "ab", " ", "with", " ", "first", " ", "bb"}], 
            "*)"}], 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"c", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1", ",", "1"}], "]"}], "]"}], "===", 
                "x"}], ",", 
               RowBox[{"wrapper", "[", 
                RowBox[{
                 RowBox[{"-", "ex"}], ",", 
                 RowBox[{"bb", "[", 
                  RowBox[{
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"Reverse", "@", 
                    RowBox[{"(", 
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], ")"}]}]}], ",", 
                   "y", ",", "z"}], "]"}], ",", "a", ",", "b", ",", 
                 RowBox[{"ReplacePart", "[", 
                  RowBox[{"c", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i", ",", "2"}], "}"}], "->", 
                    RowBox[{
                    RowBox[{"c", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "1"}]}]}], 
                  "]"}]}], "]"}], ",", 
               RowBox[{"Nothing", "[", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Length", "@", "c"}]}], "}"}]}], "]"}]}], "]"}]}]}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Entry", " ", "in", " ", 
          RowBox[{"bb", ".", " ", "We"}], " ", "simply", " ", "plug", " ", 
          "it", " ", "back", " ", "into", " ", "the", " ", "bb", " ", "list", 
          " ", "and", " ", "restart"}], ",", " ", 
         RowBox[{
         "so", " ", "we", " ", "recycle", " ", "definitions", " ", "of", " ", 
          "aa", " ", "and", " ", "ab", " ", "above"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"wrapper", "[", 
         RowBox[{"ex_", ",", 
          RowBox[{"bb", "[", "x__", "]"}], ",", "a_", ",", "b_", ",", "c_"}], 
         "]"}], ":=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"tmp", "=", 
             RowBox[{"Flatten", "[", 
              RowBox[{"Position", "[", 
               RowBox[{"c", ",", 
                RowBox[{"bb", "[", "x", "]"}]}], "]"}], "]"}]}], ")"}], "===", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"wrapper", "[", 
           RowBox[{"ex", ",", "1", ",", "a", ",", "b", ",", 
            RowBox[{"Append", "[", 
             RowBox[{"c", ",", 
              RowBox[{"mult", "[", 
               RowBox[{
                RowBox[{"bb", "[", "x", "]"}], ",", "1"}], "]"}]}], "]"}]}], 
           "]"}], ",", 
          RowBox[{"wrapper", "[", 
           RowBox[{"ex", ",", "1", ",", "a", ",", "b", ",", 
            RowBox[{"ReplacePart", "[", 
             RowBox[{"c", ",", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"First", "@", "tmp"}], ",", "2"}], "}"}], "->", 
               RowBox[{
                RowBox[{"c", "[", 
                 RowBox[{"[", 
                  RowBox[{
                   RowBox[{"First", "@", "tmp"}], ",", "2"}], "]"}], "]"}], 
                "+", "1"}]}]}], "]"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Finally", ",", " ", 
         RowBox[{
         "invwrapper", " ", "flattens", " ", "out", " ", "the", " ", "nested",
           " ", "lists", " ", "and", " ", "returns", " ", "the", " ", "one", 
          " ", "which", " ", "best", " ", "fits", " ", "the", " ", 
          "selection", " ", "criterion"}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Switch", "[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "ChainSelection", "]"}], ",", 
         "\[IndentingNewLine]", "\"\<RandomChain\>\"", ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
          RowBox[{"First", "@", 
           RowBox[{"Flatten", "[", "x", "]"}]}]}], ",", 
         "\[IndentingNewLine]", "\"\<LongestChain\>\"", ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"First", "@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{"FirstPosition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"Min", "@", "#"}]}], "]"}], "&"}], "@", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Total", "@", 
                    RowBox[{"Cases", "[", 
                    RowBox[{
                    RowBox[{"{", "#", "}"}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"aa", "[", "y__", "]"}], "|", 
                    RowBox[{"bb", "[", "y__", "]"}], "|", 
                    RowBox[{"ab", "[", "y__", "]"}]}], "/;", 
                    RowBox[{
                    RowBox[{"Length", "@", 
                    RowBox[{"{", "y", "}"}]}], ">", "2"}]}], ":>", 
                    RowBox[{"Length", "@", 
                    RowBox[{"{", "y", "}"}]}]}], ",", "\[Infinity]"}], 
                    "]"}]}], "&"}], "/@", "#"}], ")"}]}], "&"}], "@", "#"}], 
                ")"}]}], "]"}], "]"}], "&"}], "@", 
           RowBox[{"Flatten", "[", "x", "]"}]}]}], ",", 
         "\[IndentingNewLine]", "\"\<ShortestChain\>\"", ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"First", "@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{"FirstPosition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"Max", "@", "#"}]}], "]"}], "&"}], "@", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Total", "@", 
                    RowBox[{"Cases", "[", 
                    RowBox[{
                    RowBox[{"{", "#", "}"}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"aa", "[", "y__", "]"}], "|", 
                    RowBox[{"bb", "[", "y__", "]"}], "|", 
                    RowBox[{"ab", "[", "y__", "]"}]}], "/;", 
                    RowBox[{
                    RowBox[{"Length", "@", 
                    RowBox[{"{", "y", "}"}]}], ">", "2"}]}], ":>", 
                    RowBox[{"Length", "@", 
                    RowBox[{"{", "y", "}"}]}]}], ",", "\[Infinity]"}], 
                    "]"}]}], "&"}], "/@", "#"}], ")"}]}], "&"}], "@", "#"}], 
                ")"}]}], "]"}], "]"}], "&"}], "@", 
           RowBox[{"Flatten", "[", "x", "]"}]}]}], ",", 
         "\[IndentingNewLine]", "\"\<MostTraces\>\"", ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"invwrapper", "[", "x_List", "]"}], ":=", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"First", "@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{"FirstPosition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"Max", "@", "#"}], ",", 
                    RowBox[{"{", "1", "}"}]}], "]"}], "&"}], "@", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Count", "[", 
                    RowBox[{
                    RowBox[{"{", "#", "}"}], ",", 
                    RowBox[{"ab", "[", 
                    RowBox[{"y_", ",", "z__", ",", "y_"}], "]"}], ",", 
                    "\[Infinity]"}], "]"}], "&"}], "/@", "#"}], ")"}]}], 
                  "&"}], "@", "#"}], ")"}]}], "]"}], "]"}], "&"}], "@", 
           RowBox[{"Flatten", "[", "x", "]"}]}]}]}], "\[IndentingNewLine]", 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"local", "=", "local"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Reconvert", " ", "the", " ", "aa"}], ",", "ab", ",", 
         RowBox[{
         "bb", " ", "to", " ", "the", " ", "spinor", " ", "objects"}]}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Clear", "[", 
        RowBox[{
        "SpinorAngleBracket", ",", "SpinorSquareBracket", ",", "Chain"}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"aa", "[", "x__", "]"}], ":=", 
        RowBox[{"Chain", "[", 
         RowBox[{"$angle", ",", 
          RowBox[{"First", "@", 
           RowBox[{"{", "x", "}"}]}], ",", 
          RowBox[{"Most", "@", 
           RowBox[{"Rest", "@", 
            RowBox[{"{", "x", "}"}]}]}], ",", 
          RowBox[{"Last", "@", 
           RowBox[{"{", "x", "}"}]}], ",", "$angle"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"ab", "[", "x__", "]"}], ":=", 
        RowBox[{"Chain", "[", 
         RowBox[{"$angle", ",", 
          RowBox[{"First", "@", 
           RowBox[{"{", "x", "}"}]}], ",", 
          RowBox[{"Most", "@", 
           RowBox[{"Rest", "@", 
            RowBox[{"{", "x", "}"}]}]}], ",", 
          RowBox[{"Last", "@", 
           RowBox[{"{", "x", "}"}]}], ",", "$square"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"bb", "[", "x__", "]"}], ":=", 
        RowBox[{"Chain", "[", 
         RowBox[{"$square", ",", 
          RowBox[{"First", "@", 
           RowBox[{"{", "x", "}"}]}], ",", 
          RowBox[{"Most", "@", 
           RowBox[{"Rest", "@", 
            RowBox[{"{", "x", "}"}]}]}], ",", 
          RowBox[{"Last", "@", 
           RowBox[{"{", "x", "}"}]}], ",", "$square"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Chain", "[", 
         RowBox[{"$angle", ",", "x_", ",", 
          RowBox[{"{", "}"}], ",", "y_", ",", "$angle"}], "]"}], ":=", 
        RowBox[{"SpinorAngleBracket", "[", 
         RowBox[{"x", ",", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Chain", "[", 
         RowBox[{"$square", ",", "x_", ",", 
          RowBox[{"{", "}"}], ",", "y_", ",", "$square"}], "]"}], ":=", 
        RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{"x", ",", "y"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Return", " ", "the", " ", "function"}], "*)"}], 
       "\[IndentingNewLine]", "local"}]}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"End", " ", "of", " ", "Block"}], "*)"}], "\[IndentingNewLine]",
      "]"}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"End", " ", "of", " ", "Module"}], "*)"}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.8462456814201593`*^9, 3.846245825156507*^9}, {
   3.84624588041416*^9, 3.846246059525483*^9}, {3.846246159961267*^9, 
   3.846246506356346*^9}, {3.8462465588496513`*^9, 3.846246776938932*^9}, {
   3.8462468211574593`*^9, 3.846246821357975*^9}, {3.8462469009381323`*^9, 
   3.846247006582032*^9}, {3.846247070132245*^9, 3.846247149644244*^9}, {
   3.846247374359428*^9, 3.8462474663508*^9}, {3.8462475097111187`*^9, 
   3.846247529989496*^9}, 3.846247663407776*^9, {3.846247846840952*^9, 
   3.8462478514860983`*^9}, {3.846247998536194*^9, 3.8462482085672503`*^9}, {
   3.8462483680399227`*^9, 3.8462486484817333`*^9}, {3.8462487027049007`*^9, 
   3.846248724368257*^9}, {3.846248797143999*^9, 3.846248816218581*^9}, {
   3.8462488954114532`*^9, 3.846249049858389*^9}, {3.846249189482415*^9, 
   3.8462493254442596`*^9}, {3.846249385925198*^9, 3.846249487653274*^9}, {
   3.846249544221499*^9, 3.846249546222382*^9}, {3.846249589856963*^9, 
   3.84624967719884*^9}, {3.8462502101602983`*^9, 3.8462502823829317`*^9}, {
   3.8466736897255898`*^9, 3.8466737132423563`*^9}, {3.846673787513953*^9, 
   3.8466738715461493`*^9}, {3.846673957521954*^9, 3.846673984547014*^9}, {
   3.846674145495881*^9, 3.8466742128864717`*^9}, {3.846674595008449*^9, 
   3.846674630136456*^9}, {3.846674694990931*^9, 3.8466747000636473`*^9}, {
   3.8466747961635733`*^9, 3.846674953065852*^9}, {3.8466749914594097`*^9, 
   3.846675024454584*^9}, {3.846675202987584*^9, 3.846675218898118*^9}, {
   3.846675252620487*^9, 3.8466753463304377`*^9}, {3.846675554571374*^9, 
   3.846675660387985*^9}, {3.8466757145470448`*^9, 3.846675822132268*^9}, {
   3.846676264327422*^9, 3.846676282809916*^9}, {3.846676318013103*^9, 
   3.8466763538782*^9}, 3.8466764126300097`*^9, {3.846676467765717*^9, 
   3.846676558822207*^9}, {3.846676738181177*^9, 3.846676742607403*^9}, {
   3.846676775079438*^9, 3.84667680190305*^9}, {3.846676877605699*^9, 
   3.846677019256134*^9}, {3.846677833092266*^9, 3.846677955482648*^9}, {
   3.846678266914877*^9, 3.8466783138718147`*^9}, {3.846678423487372*^9, 
   3.8466785489015512`*^9}, {3.846678590086501*^9, 3.846678590240883*^9}, {
   3.846737994247161*^9, 3.846738004503858*^9}, {3.84673803926145*^9, 
   3.846738043581056*^9}, {3.846738075204897*^9, 3.8467380767987223`*^9}, {
   3.846738324485396*^9, 3.846738363902405*^9}, {3.846738549976481*^9, 
   3.8467386234799957`*^9}, {3.8467386620800943`*^9, 
   3.8467386667625303`*^9}, {3.846738707330525*^9, 3.846738709144993*^9}, {
   3.8467387719995604`*^9, 3.846738802416275*^9}, {3.846738865026211*^9, 
   3.8467388941297913`*^9}, {3.8467390345762873`*^9, 3.846739145036749*^9}, {
   3.846739185086565*^9, 3.8467393313401337`*^9}, {3.846739689354558*^9, 
   3.846739694756753*^9}, {3.8467400608109426`*^9, 3.846740223107369*^9}, {
   3.846740311305922*^9, 3.8467403137190647`*^9}, {3.84674042257513*^9, 
   3.8467404287644377`*^9}, {3.84674073988706*^9, 3.8467408609842367`*^9}, {
   3.846740898995308*^9, 3.846740902645625*^9}, {3.846741092330057*^9, 
   3.846741223363451*^9}, {3.846741273401784*^9, 3.8467413019477367`*^9}, {
   3.846741527121957*^9, 3.846741527308371*^9}, {3.8467415957943*^9, 
   3.846741645888163*^9}, {3.846741748890009*^9, 3.846741839195334*^9}, {
   3.846741884019949*^9, 3.846741998114798*^9}, {3.846742063810554*^9, 
   3.84674210675229*^9}, {3.846742137695187*^9, 3.846742187767593*^9}, {
   3.846742227202767*^9, 3.846742311862904*^9}, {3.846742434968604*^9, 
   3.8467426301567087`*^9}, {3.846742696026381*^9, 3.846742750778027*^9}, {
   3.846742802984507*^9, 3.8467428167728453`*^9}, {3.846742890066197*^9, 
   3.8467428911290913`*^9}, {3.846743039834488*^9, 3.846743042779208*^9}, {
   3.8467430826284523`*^9, 3.846743096066346*^9}, {3.846743232096546*^9, 
   3.846743308351609*^9}, {3.846743430005843*^9, 3.846743466618582*^9}, {
   3.846743674642068*^9, 3.8467439478485317`*^9}, {3.846757292491746*^9, 
   3.846757362945348*^9}, {3.8467574294782124`*^9, 3.846757433996887*^9}, {
   3.846757480935882*^9, 3.846757586611937*^9}, {3.846757629917018*^9, 
   3.84675769313622*^9}, {3.846757896979762*^9, 3.846757910077166*^9}, {
   3.846757965876402*^9, 3.846757967126268*^9}, {3.8467580074662857`*^9, 
   3.846758042493403*^9}, {3.8467580851447906`*^9, 3.8467581652888947`*^9}, {
   3.846758283695571*^9, 3.84675830859065*^9}, {3.846759052744413*^9, 
   3.846759201902575*^9}, {3.846759265432683*^9, 3.846759303972077*^9}, {
   3.8467594306671467`*^9, 3.84675944312948*^9}, {3.846759498593891*^9, 
   3.846759580771838*^9}, {3.8467599206609*^9, 3.8467599409392433`*^9}, {
   3.846760047365443*^9, 3.846760301481989*^9}, {3.846760368724524*^9, 
   3.8467603697920437`*^9}, {3.846760465752306*^9, 3.846760595583912*^9}, {
   3.8467606912704678`*^9, 3.846760722904125*^9}, 3.846760861779859*^9, {
   3.84676100367754*^9, 3.846761016091728*^9}, 3.846761054791007*^9, {
   3.8467610993331614`*^9, 3.846761204795373*^9}, {3.8467621585850983`*^9, 
   3.8467621739066877`*^9}, {3.8467622043042917`*^9, 3.846762231589814*^9}, {
   3.8467622809649477`*^9, 3.8467622811161346`*^9}, {3.846762324145405*^9, 
   3.846762333115369*^9}, {3.846762365576317*^9, 3.8467623868763437`*^9}, {
   3.846762459295772*^9, 3.8467624617875357`*^9}, {3.846762521784429*^9, 
   3.846762597208755*^9}, {3.8467626638329163`*^9, 3.846762668357471*^9}, {
   3.846762699030611*^9, 3.846762766300453*^9}, {3.8467628086148767`*^9, 
   3.846762915664832*^9}, {3.8467629542789803`*^9, 3.8467629716963253`*^9}, {
   3.8467636497787333`*^9, 3.846763747430653*^9}, {3.8467637844501762`*^9, 
   3.846763840813588*^9}, {3.8467640227083673`*^9, 3.846764034083832*^9}, {
   3.8467641150131683`*^9, 3.846764130892407*^9}, {3.846764170043755*^9, 
   3.846764210445216*^9}, {3.846764352256002*^9, 3.8467644553780937`*^9}, {
   3.84676448592337*^9, 3.8467645298310833`*^9}, {3.846764579838427*^9, 
   3.846764580306511*^9}, {3.84676461410935*^9, 3.846764713165456*^9}, {
   3.846764786233068*^9, 3.846764788258381*^9}},
 CellLabel->
  "In[270]:=",ExpressionUUID->"a02e73ac-140b-4e5c-872a-94d8143d2c7a"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"7", "*", "z", "*", 
   TemplateBox[{"1", "2"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"2", "3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "4"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "5"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   RowBox[{
    TemplateBox[{"5", "6"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "^", "3"}], 
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "/", 
    RowBox[{"(", 
     RowBox[{
      TemplateBox[{"p1", "p2"},
       "SpinorAngleBracket",
       DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
          RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
       InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
          RowBox[{#, ",", #2}], "]"}]& )], 
      RowBox[{
       TemplateBox[{"p2", "p3"},
        "SpinorSquareBracket",
        DisplayFunction->(RowBox[{"[", 
           RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}], "//", 
  RowBox[{
   RowBox[{"PreChain", "[", 
    RowBox[{"#", ",", 
     RowBox[{"ChainSelection", "->", "\"\<MostTraces\>\""}]}], "]"}], 
   "&"}]}]], "Input",
 CellChangeTimes->{{3.846242173509924*^9, 3.846242231112877*^9}, {
  3.846246116586875*^9, 3.846246150278006*^9}, {3.8462461817347727`*^9, 
  3.846246182158164*^9}, {3.846246578013474*^9, 3.846246578378786*^9}, {
  3.846247680110651*^9, 3.846247683789065*^9}, {3.8467594054913588`*^9, 
  3.846759412790703*^9}, {3.846763755846171*^9, 3.846763771621814*^9}, {
  3.846763900428853*^9, 3.8467639009081163`*^9}, {3.846764623539383*^9, 
  3.8467646252074957`*^9}, {3.846764797374366*^9, 3.846764799567657*^9}},
 CellLabel->
  "In[271]:=",ExpressionUUID->"68ac1932-0c81-4c3c-86e0-a3f493c530b1"],

Cell[BoxData[
 FractionBox[
  RowBox[{"7", " ", "z", " ", 
   TemplateBox[{"1", 
     RowBox[{"{", 
       RowBox[{"2", ",", "3"}], "}"}], "4"},
    "AngleAngleChain",
    DisplayFunction->(
     RowBox[{"\[LeftAngleBracket]", #, #2, #3, "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$angle", 
       "]"}]& )], " ", 
   TemplateBox[{"3", 
     RowBox[{"{", "5", "}"}], "6"},
    "AngleSquareChain",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], " ", 
   TemplateBox[{"7", 
     RowBox[{"{", "8", "}"}], "9"},
    "AngleSquareChain",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], " ", 
   SuperscriptBox[
    TemplateBox[{"5", "6"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "2"]}], 
  RowBox[{
   TemplateBox[{"p1", 
     RowBox[{"{", "p2", "}"}], "p3"},
    "AngleSquareChain",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
    InterpretationFunction->(
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], " ", 
   TemplateBox[{"p2", "p3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )]}]]], "Output",
 CellChangeTimes->{
  3.84624611997372*^9, 3.846246151308091*^9, 3.846246183552204*^9, 
   3.846246235365589*^9, 3.846246376832349*^9, {3.846246424554968*^9, 
   3.846246439031102*^9}, 3.846246471934087*^9, 3.846246579394256*^9, 
   3.846246688354754*^9, 3.8462470081212587`*^9, {3.8462470922578087`*^9, 
   3.846247121462365*^9}, {3.846247445871354*^9, 3.846247467791078*^9}, {
   3.846247668496654*^9, 3.846247685000882*^9}, {3.846248016852743*^9, 
   3.846248049962275*^9}, 3.8462484455387506`*^9, {3.846248476005752*^9, 
   3.8462484847031097`*^9}, 3.846248535328216*^9, 3.846249757710393*^9, 
   3.846667513813611*^9, 3.846673693242999*^9, 3.846674204087784*^9, {
   3.846674935957589*^9, 3.846674954745063*^9}, 3.846675030390892*^9, 
   3.846675206681568*^9, {3.8466752434827557`*^9, 3.846675291700943*^9}, 
   3.846678483068389*^9, {3.846678522601722*^9, 3.846678550403185*^9}, 
   3.8467380114278393`*^9, 3.8467380456997623`*^9, 3.846738078710441*^9, 
   3.84673862739706*^9, 3.846738669944131*^9, 3.846738940403521*^9, 
   3.846739053551709*^9, 3.8467393053039494`*^9, 3.846739336531863*^9, 
   3.846739696777441*^9, 3.846740190453413*^9, 3.8467402249021387`*^9, 
   3.846740869774839*^9, 3.8467409039996853`*^9, 3.846741537562234*^9, {
   3.8467418142038727`*^9, 3.8467418410786247`*^9}, 3.846742010400065*^9, 
   3.846742202063075*^9, 3.846742487301585*^9, 3.846742636959553*^9, {
   3.846742698989911*^9, 3.846742753065506*^9}, 3.846742821663252*^9, 
   3.8467428935453978`*^9, 3.846743044954796*^9, 3.846743099163868*^9, 
   3.8467432608507338`*^9, {3.846743291150421*^9, 3.846743310303846*^9}, 
   3.846743696569893*^9, {3.846743916768108*^9, 3.8467439498985567`*^9}, 
   3.846757593809761*^9, 3.846758312350493*^9, {3.846759384728903*^9, 
   3.8467594137807007`*^9}, 3.846759539418352*^9, 3.84676074165191*^9, 
   3.846760865426648*^9, 3.846761060071117*^9, {3.846761184868147*^9, 
   3.8467612065858727`*^9}, 3.846762175936771*^9, {3.846762206121325*^9, 
   3.846762232738701*^9}, 3.8467622830487137`*^9, 3.846762336509307*^9, 
   3.846762389967955*^9, 3.846762464782827*^9, 3.846762543120842*^9, 
   3.846762600048937*^9, {3.846762772304195*^9, 3.846762795060376*^9}, {
   3.846763772144313*^9, 3.846763842270924*^9}, 3.846763902706139*^9, 
   3.8467641383784246`*^9, {3.846764411590734*^9, 3.846764425546818*^9}, 
   3.846764459026843*^9, {3.846764500246171*^9, 3.8467645101433277`*^9}, {
   3.846764617963142*^9, 3.84676462631341*^9}, 3.8467648006477747`*^9},
 CellLabel->
  "Out[271]=",ExpressionUUID->"68c986cc-3e8b-4612-81ef-1f1c27fec809"]
}, Open  ]],

Cell[BoxData["`"], "Input",ExpressionUUID->"625859a5-044e-4e1a-ab83-a0152b3507d0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"test", "=", 
   RowBox[{"7", "*", "z", "*", 
    TemplateBox[{"1", "2"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    TemplateBox[{"2", "3"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    TemplateBox[{"3", "4"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    TemplateBox[{"3", "5"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], 
    RowBox[{
     TemplateBox[{"5", "6"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}], 
    RowBox[{
     TemplateBox[{"7", 
       RowBox[{"{", "8", "}"}], "9"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "/", 
     RowBox[{"(", 
      RowBox[{
       TemplateBox[{"p1", "p2"},
        "SpinorAngleBracket",
        DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
           RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], 
       RowBox[{
        TemplateBox[{"p2", "p3"},
         "SpinorSquareBracket",
         DisplayFunction->(RowBox[{"[", 
            RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
         InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.846743970308426*^9, 3.846743972693273*^9}},
 CellLabel->
  "In[203]:=",ExpressionUUID->"7e73e989-6490-4df5-905b-b391efd90356"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"test", "^", "3"}], "//", "ToChain"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "1000"}], "}"}]}], "]"}], "//", 
  "AbsoluteTiming"}]], "Input",
 CellChangeTimes->{{3.846743979401436*^9, 3.84674399624229*^9}, {
  3.8467440327908*^9, 3.8467440333816767`*^9}, {3.846760882878025*^9, 
  3.8467609251739388`*^9}},
 CellLabel->
  "In[208]:=",ExpressionUUID->"2c37cfaa-3563-4344-b309-b66a416750c9"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"1.578293`", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{
  3.84674399739345*^9, 3.846744035412333*^9, {3.846760886163323*^9, 
   3.846760927338073*^9}},
 CellLabel->
  "Out[208]=",ExpressionUUID->"33506d1e-6cb1-400a-a0b1-4d7de88dd436"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"test", "^", "3"}], "//", "PreChain"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "1000"}], "}"}]}], "]"}], "//", 
  "AbsoluteTiming"}]], "Input",
 CellChangeTimes->{{3.8467440064319487`*^9, 3.8467440081034946`*^9}, {
  3.846744039308696*^9, 3.846744040548047*^9}, {3.846744117268402*^9, 
  3.846744123980432*^9}, {3.8467608939367332`*^9, 3.846760930909863*^9}},
 CellLabel->
  "In[209]:=",ExpressionUUID->"049c0084-c987-4cb4-b91f-94d2978654d9"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"3.601811`", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{
  3.846744009235771*^9, {3.846744114703321*^9, 3.8467441488409843`*^9}, {
   3.846760895911515*^9, 3.846760935164515*^9}},
 CellLabel->
  "Out[209]=",ExpressionUUID->"646507d1-f20d-47e2-974b-7386916099fc"]
}, Open  ]],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
  "Combinatorics", " ", "of", " ", "terms", " ", "explodes", " ", "with", " ",
    "the", " ", "number", " ", "of", " ", "powers", " ", "in", " ", "each", 
   " ", "bracket"}], "*)"}]], "Input",
 CellChangeTimes->{{3.846744140018464*^9, 
  3.8467441639582148`*^9}},ExpressionUUID->"730923a7-7e32-43f8-b232-\
0f22fad87378"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"(", 
    RowBox[{"7", "*", "z", "*", 
     TemplateBox[{"1", "2"},
      "SpinorAngleBracket",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
         RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], 
     TemplateBox[{"2", "3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], 
     TemplateBox[{"3", "4"},
      "SpinorAngleBracket",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
         RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], 
     TemplateBox[{"3", "5"},
      "SpinorAngleBracket",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
         RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], 
     RowBox[{
      TemplateBox[{"5", "6"},
       "SpinorSquareBracket",
       DisplayFunction->(RowBox[{"[", 
          RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
       InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
          RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}], 
     RowBox[{
      TemplateBox[{"7", 
        RowBox[{"{", "8", "}"}], "9"},
       "AngleSquareChain",
       DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
       InterpretationFunction->(
        RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
          "$square", "]"}]& )], "/", 
      RowBox[{"(", 
       RowBox[{
        TemplateBox[{"p1", "p2"},
         "SpinorAngleBracket",
         DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
            RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
         InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
            RowBox[{#, ",", #2}], "]"}]& )], 
        RowBox[{
         TemplateBox[{"p2", "p3"},
          "SpinorSquareBracket",
          DisplayFunction->(RowBox[{"[", 
             RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
          InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
             RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}]}]}], ")"}], 
   "^", "3"}], "//", "PreChain"}]], "Input",
 CellChangeTimes->{{3.846760953438199*^9, 3.84676095793447*^9}},
 CellLabel->
  "In[210]:=",ExpressionUUID->"2446e460-e370-4a2e-bfb3-0fd53f148491"],

Cell[BoxData[
 FractionBox[
  RowBox[{"343", " ", 
   SuperscriptBox["z", "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"1", 
      RowBox[{"{", 
        RowBox[{"2", ",", "3"}], "}"}], "4"},
     "AngleAngleChain",
     DisplayFunction->(
      RowBox[{"\[LeftAngleBracket]", #, #2, #3, "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$angle",
         "]"}]& )], "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"3", 
      RowBox[{"{", "5", "}"}], "6"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"5", "6"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "3"]}], 
  RowBox[{
   SuperscriptBox[
    TemplateBox[{"p1", 
      RowBox[{"{", "p2", "}"}], "p3"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], "3"], " ", 
   SuperscriptBox[
    TemplateBox[{"p2", "p3"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]], "Output",
 CellChangeTimes->{3.8467609586193542`*^9},
 CellLabel->
  "Out[210]=",ExpressionUUID->"6841052b-9405-4ce6-98c1-76fffa98f50c"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"test2", "=", 
  RowBox[{
   TemplateBox[{"1", "2"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"2", "3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "4"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"4", "1"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"4", "5"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"5", "6"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"6", "7"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"7", "4"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"7", "8"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"8", "9"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   RowBox[{
    TemplateBox[{"4", "3"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "/", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       TemplateBox[{"p1", "p2"},
        "SpinorAngleBracket",
        DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
           RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], 
       RowBox[{
        TemplateBox[{"p2", "p3"},
         "SpinorSquareBracket",
         DisplayFunction->(RowBox[{"[", 
            RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
         InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}], "^", 
     "3"}]}]}]}]], "Input",
 CellChangeTimes->{{3.856520917287287*^9, 3.8565210638900003`*^9}, {
  3.8565213735255833`*^9, 3.8565213760118694`*^9}},
 CellLabel->"In[28]:=",ExpressionUUID->"0bc5ab8b-8ed6-4346-a248-c96e98fc9f0a"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"1", "2"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"4", "7"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"5", "6"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"7", "8"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"1", "4"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"2", "3"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"4", "5"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"6", "7"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"8", "9"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", "p2"},
      "SpinorAngleBracket",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
         RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "6"]}]]}]], "Output",
 CellChangeTimes->{{3.8565210566830053`*^9, 3.856521064131564*^9}, 
   3.856521377214649*^9},
 CellLabel->"Out[28]=",ExpressionUUID->"1fe43c5c-6e49-486f-879d-2164f2338b76"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"test2", "//", "ToChain"}]], "Input",
 CellChangeTimes->{{3.8565210742595363`*^9, 3.856521088246996*^9}},
 CellLabel->"In[29]:=",ExpressionUUID->"d2b69faa-7951-4c99-a555-6b7504cb8afd"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", 
      RowBox[{"{", 
        RowBox[{
         "2", ",", "1", ",", "4", ",", "7", ",", "6", ",", "5", ",", "4"}], 
        "}"}], "3"},
     "SquareAngleChain",
     DisplayFunction->(RowBox[{"[", #, #2, #3, "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$square", ",", #, ",", #2, ",", #3, ",", 
        "$angle", "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{{3.8565210797558823`*^9, 3.856521088828184*^9}, 
   3.856521379936812*^9},
 CellLabel->"Out[29]=",ExpressionUUID->"84d4c06c-f752-47a8-ae1e-12eea6254d68"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"test2", "//", "PreChain"}], "\[IndentingNewLine]", 
 RowBox[{"test2", "//", 
  RowBox[{
   RowBox[{"PreChain", "[", 
    RowBox[{"#", ",", 
     RowBox[{"ChainSelection", "->", "\"\<MostTraces\>\""}]}], "]"}], 
   "&"}]}], "\[IndentingNewLine]", 
 RowBox[{"test2", "//", 
  RowBox[{
   RowBox[{"PreChain", "[", 
    RowBox[{"#", ",", 
     RowBox[{"ChainSelection", "->", "\"\<ShortestChain\>\""}]}], "]"}], 
   "&"}]}], "\[IndentingNewLine]", 
 RowBox[{"test2", "//", 
  RowBox[{
   RowBox[{"PreChain", "[", 
    RowBox[{"#", ",", 
     RowBox[{"ChainSelection", "->", "\"\<LongestChain\>\""}]}], "]"}], 
   "&"}]}]}], "Input",
 CellChangeTimes->{{3.8565211106607094`*^9, 3.8565211181509137`*^9}, {
  3.856521161801671*^9, 3.8565212309612646`*^9}},
 CellLabel->"In[30]:=",ExpressionUUID->"5a0bec93-8cf9-4af2-881e-792eb4a92832"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", 
        RowBox[{
         "4", ",", "1", ",", "2", ",", "3", ",", "4", ",", "5", ",", "6", ",",
           "7", ",", "8"}], "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{
  3.8565211183988237`*^9, {3.856521180456885*^9, 3.8565211851045732`*^9}, {
   3.8565212180454817`*^9, 3.8565212320958824`*^9}, 3.8565213907582774`*^9},
 CellLabel->"Out[30]=",ExpressionUUID->"76942040-55f3-46b1-8cdc-670a0bf82eb3"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"1", 
      RowBox[{"{", 
        RowBox[{"2", ",", "3", ",", "4"}], "}"}], "1"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"5", 
      RowBox[{"{", 
        RowBox[{"6", ",", "7", ",", "4"}], "}"}], "5"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{
  3.8565211183988237`*^9, {3.856521180456885*^9, 3.8565211851045732`*^9}, {
   3.8565212180454817`*^9, 3.8565212320958824`*^9}, 3.8565213908570704`*^9},
 CellLabel->"Out[31]=",ExpressionUUID->"e5a34af9-f955-40fc-9a5f-c40b8d495b57"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"1", 
      RowBox[{"{", 
        RowBox[{"2", ",", "3", ",", "4"}], "}"}], "1"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", 
      RowBox[{"{", 
        RowBox[{"4", ",", "7", ",", "6", ",", "5"}], "}"}], "4"},
     "SquareSquareChain",
     DisplayFunction->(RowBox[{"[", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$square", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{
  3.8565211183988237`*^9, {3.856521180456885*^9, 3.8565211851045732`*^9}, {
   3.8565212180454817`*^9, 3.8565212320958824`*^9}, 3.856521390961044*^9},
 CellLabel->"Out[32]=",ExpressionUUID->"f91a8cd1-ebbb-4e58-94ce-d0d830f3e58f"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", 
        RowBox[{
         "4", ",", "1", ",", "2", ",", "3", ",", "4", ",", "5", ",", "6", ",",
           "7", ",", "8"}], "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{
  3.8565211183988237`*^9, {3.856521180456885*^9, 3.8565211851045732`*^9}, {
   3.8565212180454817`*^9, 3.8565212320958824`*^9}, 3.856521391070093*^9},
 CellLabel->"Out[33]=",ExpressionUUID->"353987f6-ae53-407d-b747-5e2d34480aa6"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"test2", "=", 
  RowBox[{
   TemplateBox[{"1", "2"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"2", "3"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"3", "4"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"4", "1"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"4", "5"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"5", "6"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"6", "7"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"7", "4"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"7", "8"},
    "SpinorAngleBracket",
    DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   TemplateBox[{"8", "9"},
    "SpinorSquareBracket",
    DisplayFunction->(RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
    InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], 
   RowBox[{
    TemplateBox[{"4", "3"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], "/", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       TemplateBox[{"p1", "p2"},
        "SpinorAngleBracket",
        DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
           RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
        InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
           RowBox[{#, ",", #2}], "]"}]& )], 
       RowBox[{
        TemplateBox[{"p2", "p3"},
         "SpinorSquareBracket",
         DisplayFunction->(RowBox[{"[", 
            RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
         InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
            RowBox[{#, ",", #2}], "]"}]& )], "^", "2"}]}], ")"}], "^", 
     "3"}]}]}]}]], "Input",
 CellChangeTimes->{{3.856520917287287*^9, 3.8565210638900003`*^9}, {
  3.8565213735255833`*^9, 3.8565213760118694`*^9}},
 CellLabel->"In[6]:=",ExpressionUUID->"252437e6-f759-48cb-929d-6a0882e9a085"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"1", "2"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"4", "7"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"5", "6"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"7", "8"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"1", "4"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"2", "3"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"4", "5"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"6", "7"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )], " ", 
    TemplateBox[{"8", "9"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", "p2"},
      "SpinorAngleBracket",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
         RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "6"]}]]}]], "Output",
 CellChangeTimes->{{3.8565210566830053`*^9, 3.856521064131564*^9}, 
   3.856521377214649*^9, 3.8565226183637033`*^9},
 CellLabel->"Out[6]=",ExpressionUUID->"447dd015-2322-437e-91cc-b45ef55321cb"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"test2", "//", "ToChain"}]], "Input",
 CellChangeTimes->{{3.8565210742595363`*^9, 3.856521088246996*^9}},
 CellLabel->"In[7]:=",ExpressionUUID->"47782f8d-712c-47ca-aa18-8fca0406a660"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", 
      RowBox[{"{", 
        RowBox[{
         "2", ",", "1", ",", "4", ",", "7", ",", "6", ",", "5", ",", "4"}], 
        "}"}], "3"},
     "SquareAngleChain",
     DisplayFunction->(RowBox[{"[", #, #2, #3, "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$square", ",", #, ",", #2, ",", #3, ",", 
        "$angle", "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{{3.8565210797558823`*^9, 3.856521088828184*^9}, 
   3.856521379936812*^9, 3.8565226196473*^9},
 CellLabel->"Out[7]=",ExpressionUUID->"af5cc210-5786-4ebe-b895-c3efff4943ec"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"test2", "//", "ToChain"}], "\[IndentingNewLine]", 
 RowBox[{"test2", "//", 
  RowBox[{
   RowBox[{"ToChain", "[", 
    RowBox[{"#", ",", 
     RowBox[{"ChainSelection", "->", "\"\<MostTraces\>\""}]}], "]"}], 
   "&"}]}], "\[IndentingNewLine]", 
 RowBox[{"test2", "//", 
  RowBox[{
   RowBox[{"ToChain", "[", 
    RowBox[{"#", ",", 
     RowBox[{"ChainSelection", "->", "\"\<ShortestChain\>\""}]}], "]"}], 
   "&"}]}], "\[IndentingNewLine]", 
 RowBox[{"test2", "//", 
  RowBox[{
   RowBox[{"ToChain", "[", 
    RowBox[{"#", ",", 
     RowBox[{"ChainSelection", "->", "\"\<LongestChain\>\""}]}], "]"}], 
   "&"}]}]}], "Input",
 CellChangeTimes->{{3.8565211106607094`*^9, 3.8565211181509137`*^9}, {
  3.856521161801671*^9, 3.8565212309612646`*^9}, {3.8565226252720003`*^9, 
  3.8565226282977133`*^9}},
 CellLabel->"In[8]:=",ExpressionUUID->"4d662cb4-936f-4e3c-b151-b4c89a3a221a"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", 
      RowBox[{"{", 
        RowBox[{
         "2", ",", "1", ",", "4", ",", "7", ",", "6", ",", "5", ",", "4"}], 
        "}"}], "3"},
     "SquareAngleChain",
     DisplayFunction->(RowBox[{"[", #, #2, #3, "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$square", ",", #, ",", #2, ",", #3, ",", 
        "$angle", "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorAngleBracket",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", 
        RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorAngleBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{
  3.8565211183988237`*^9, {3.856521180456885*^9, 3.8565211851045732`*^9}, {
   3.8565212180454817`*^9, 3.8565212320958824`*^9}, 3.8565213907582774`*^9, 
   3.8565226303290987`*^9},
 CellLabel->"Out[8]=",ExpressionUUID->"58148089-cc83-4c94-843c-333e0acfd1f5"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"1", 
      RowBox[{"{", 
        RowBox[{"2", ",", "3", ",", "4"}], "}"}], "1"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"5", 
      RowBox[{"{", 
        RowBox[{"6", ",", "7", ",", "4"}], "}"}], "5"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{
  3.8565211183988237`*^9, {3.856521180456885*^9, 3.8565211851045732`*^9}, {
   3.8565212180454817`*^9, 3.8565212320958824`*^9}, 3.8565213907582774`*^9, 
   3.8565226304359674`*^9},
 CellLabel->"Out[9]=",ExpressionUUID->"8b9c15f3-e06b-4907-92de-d8d720bf4783"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"1", 
      RowBox[{"{", 
        RowBox[{"2", ",", "3", ",", "4"}], "}"}], "1"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"7", 
      RowBox[{"{", "8", "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", 
      RowBox[{"{", 
        RowBox[{"4", ",", "7", ",", "6", ",", "5"}], "}"}], "4"},
     "SquareSquareChain",
     DisplayFunction->(RowBox[{"[", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$square", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{
  3.8565211183988237`*^9, {3.856521180456885*^9, 3.8565211851045732`*^9}, {
   3.8565212180454817`*^9, 3.8565212320958824`*^9}, 3.8565213907582774`*^9, 
   3.856522630549173*^9},
 CellLabel->"Out[10]=",ExpressionUUID->"6c50df05-94d9-45a2-9dd9-487020f52142"],

Cell[BoxData[
 RowBox[{"-", 
  FractionBox[
   RowBox[{
    TemplateBox[{"7", 
      RowBox[{"{", 
        RowBox[{
         "4", ",", "1", ",", "2", ",", "3", ",", "4", ",", "5", ",", "6", ",",
           "7", ",", "8"}], "}"}], "9"},
     "AngleSquareChain",
     DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
     InterpretationFunction->(
      RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
        "$square", "]"}]& )], " ", 
    TemplateBox[{"3", "4"},
     "SpinorSquareBracket",
     DisplayFunction->(RowBox[{"[", 
        RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
     InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
        RowBox[{#, ",", #2}], "]"}]& )]}], 
   RowBox[{
    SuperscriptBox[
     TemplateBox[{"p1", 
       RowBox[{"{", "p2", "}"}], "p3"},
      "AngleSquareChain",
      DisplayFunction->(RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ),
      InterpretationFunction->(
       RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", 
         "$square", "]"}]& )], "3"], " ", 
    SuperscriptBox[
     TemplateBox[{"p2", "p3"},
      "SpinorSquareBracket",
      DisplayFunction->(RowBox[{"[", 
         RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ),
      InterpretationFunction->(RowBox[{"SpinorSquareBracket", "[", 
         RowBox[{#, ",", #2}], "]"}]& )], "3"]}]]}]], "Output",
 CellChangeTimes->{
  3.8565211183988237`*^9, {3.856521180456885*^9, 3.8565211851045732`*^9}, {
   3.8565212180454817`*^9, 3.8565212320958824`*^9}, 3.8565213907582774`*^9, 
   3.8565226306666126`*^9},
 CellLabel->"Out[11]=",ExpressionUUID->"6545ed12-67e1-4a64-b3af-c4074bd50025"]
}, Open  ]]
}, Open  ]]
},
WindowSize->{759, 497},
WindowMargins->{{Automatic, 40.5}, {Automatic, 176.5}},
InputAliases-><|"intt" -> RowBox[{"\[Integral]", 
     RowBox[{"\[SelectionPlaceholder]", 
       RowBox[{"\[DifferentialD]", "\[Placeholder]"}]}]}], "dintt" -> RowBox[{
     SubsuperscriptBox[
     "\[Integral]", "\[SelectionPlaceholder]", "\[Placeholder]"], 
     RowBox[{"\[Placeholder]", 
       RowBox[{"\[DifferentialD]", "\[Placeholder]"}]}]}], "rintt" -> RowBox[{
     UnderscriptBox["\[Integral]", 
      RowBox[{"\[SelectionPlaceholder]", "\[Element]", "\[Placeholder]"}]], 
     "\[Placeholder]"}], "sumt" -> RowBox[{
     UnderoverscriptBox["\[Sum]", 
      RowBox[{"\[SelectionPlaceholder]", "=", "\[Placeholder]"}], 
      "\[Placeholder]"], "\[Placeholder]"}], "prodt" -> RowBox[{
     UnderoverscriptBox["\[Product]", 
      RowBox[{"\[SelectionPlaceholder]", "=", "\[Placeholder]"}], 
      "\[Placeholder]"], "\[Placeholder]"}], "dt" -> RowBox[{
     SubscriptBox["\[PartialD]", "\[SelectionPlaceholder]"], 
     "\[Placeholder]"}], "cbrt" -> 
  RadicalBox[
   "\[SelectionPlaceholder]", "3", SurdForm -> True, MultilineFunction -> 
    None], "surd" -> 
  RadicalBox[
   "\[SelectionPlaceholder]", "\[Placeholder]", SurdForm -> True, 
    MultilineFunction -> None], "ket" -> 
  TemplateBox[{"\[SelectionPlaceholder]"}, "Ket"], "bra" -> 
  TemplateBox[{"\[SelectionPlaceholder]"}, "Bra"], "braket" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[Placeholder]"}, "BraKet"], 
  "delay" -> TemplateBox[{"\[SelectionPlaceholder]"}, "SystemsModelDelay"], 
  "grad" -> RowBox[{
     SubscriptBox["\[Del]", "\[SelectionPlaceholder]"], "\[Placeholder]"}], 
  "del." -> RowBox[{
     SubscriptBox["\[Del]", "\[SelectionPlaceholder]"], ".", 
     "\[Placeholder]"}], "delx" -> RowBox[{
     SubscriptBox["\[Del]", "\[SelectionPlaceholder]"], "\[Cross]", 
     "\[Placeholder]"}], "del2" -> RowBox[{
     SubsuperscriptBox["\[Del]", "\[SelectionPlaceholder]", 2], 
     "\[Placeholder]"}], "kd" -> 
  TemplateBox[{"\[SelectionPlaceholder]"}, "KroneckerDeltaSeq"], "algs" -> 
  TemplateBox[{}, "Algebraics"], "bools" -> TemplateBox[{}, "Booleans"], 
  "comps" -> TemplateBox[{}, "Complexes"], "ints" -> 
  TemplateBox[{}, "Integers"], "pris" -> TemplateBox[{}, "Primes"], "rats" -> 
  TemplateBox[{}, "Rationals"], "reals" -> TemplateBox[{}, "Reals"], "pints" -> 
  TemplateBox[{}, "PositiveIntegers"], "npints" -> 
  TemplateBox[{}, "NonPositiveIntegers"], "nnints" -> 
  TemplateBox[{}, "NonNegativeIntegers"], "nints" -> 
  TemplateBox[{}, "NegativeIntegers"], "prats" -> 
  TemplateBox[{}, "PositiveRationals"], "nprats" -> 
  TemplateBox[{}, "NonPositiveRationals"], "nnrats" -> 
  TemplateBox[{}, "NonNegativeRationals"], "nrats" -> 
  TemplateBox[{}, "NegativeRationals"], "preals" -> 
  TemplateBox[{}, "PositiveReals"], "npreals" -> 
  TemplateBox[{}, "NonPositiveReals"], "nnreals" -> 
  TemplateBox[{}, "NonNegativeReals"], "nreals" -> 
  TemplateBox[{}, "NegativeReals"], "dlim" -> RowBox[{
     UnderscriptBox["\[Limit]", 
      RowBox[{"\[SelectionPlaceholder]", 
        UnderscriptBox["\[Rule]", 
         TemplateBox[{}, "Integers"]], "\[Infinity]"}]], "\[Placeholder]"}], 
  "dMlim" -> RowBox[{
     UnderscriptBox["\[MaxLimit]", 
      RowBox[{"\[SelectionPlaceholder]", 
        UnderscriptBox["\[Rule]", 
         TemplateBox[{}, "Integers"]], "\[Infinity]"}]], "\[Placeholder]"}], 
  "dmlim" -> RowBox[{
     UnderscriptBox["\[MinLimit]", 
      RowBox[{"\[SelectionPlaceholder]", 
        UnderscriptBox["\[Rule]", 
         TemplateBox[{}, "Integers"]], "\[Infinity]"}]], "\[Placeholder]"}], 
  "tue" -> OverscriptBox["\[UndirectedEdge]", "\[Placeholder]"], "tde" -> 
  OverscriptBox["\[DirectedEdge]", "\[Placeholder]"], "cB" -> 
  TemplateBox[{}, "CombinatorB"], "cC" -> TemplateBox[{}, "CombinatorC"], 
  "cI" -> TemplateBox[{}, "CombinatorI"], "cK" -> 
  TemplateBox[{}, "CombinatorK"], "cS" -> TemplateBox[{}, "CombinatorS"], 
  "cW" -> TemplateBox[{}, "CombinatorW"], "cY" -> 
  TemplateBox[{}, "CombinatorY"], "lu" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"}, 
    "SpinorLaUp", DisplayFunction -> (RowBox[{
       SuperscriptBox["\[Lambda]", #2], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorUndot", "[", #, "]", "[", "$lam", "]", "[", #2, "]", "[", 
       "Null", "]"}]& )], "ld" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"}, 
    "SpinorLaDown", DisplayFunction -> (RowBox[{
       SubscriptBox["\[Lambda]", #2], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorUndot", "[", #, "]", "[", "$lam", "]", "[", "Null", "]", 
       "[", #2, "]"}]& )], "muu" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"}, 
    "SpinorMuUp", DisplayFunction -> (RowBox[{
       SuperscriptBox["\[Mu]", #2], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorUndot", "[", #, "]", "[", "$mu", "]", "[", #2, "]", "[", 
       "Null", "]"}]& )], "mud" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"}, 
    "SpinorMuDown", DisplayFunction -> (RowBox[{
       SubscriptBox["\[Mu]", #2], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorUndot", "[", #, "]", "[", "$mu", "]", "[", "Null", "]", 
       "[", #2, "]"}]& )], "lp" -> 
  TemplateBox[{"\[SelectionPlaceholder]"}, "SpinorUndotBareL", 
    DisplayFunction -> (RowBox[{"\[Lambda]", "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorUndotBare", "[", #, "]", "[", "$lam", "]"}]& )], "mp" -> 
  TemplateBox[{"\[SelectionPlaceholder]"}, "SpinorUndotBareM", 
    DisplayFunction -> (RowBox[{"\[Mu]", "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorUndotBare", "[", #, "]", "[", "$mu", "]"}]& )], "ltu" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"}, 
    "SpinorLatUp", DisplayFunction -> (RowBox[{
       SuperscriptBox[
        OverscriptBox["\[Lambda]", "~"], #2], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorDot", "[", #, "]", "[", "$lam", "]", "[", #2, "]", "[", 
       "Null", "]"}]& )], "ltd" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"}, 
    "SpinorLatDown", DisplayFunction -> (RowBox[{
       SubscriptBox[
        OverscriptBox["\[Lambda]", "~"], #2], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorDot", "[", #, "]", "[", "$lam", "]", "[", "Null", "]", 
       "[", #2, "]"}]& )], "mtu" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"}, 
    "SpinorMutUp", DisplayFunction -> (RowBox[{
       SuperscriptBox[
        OverscriptBox["\[Mu]", "~"], #2], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorDot", "[", #, "]", "[", "$mu", "]", "[", #2, "]", "[", 
       "Null", "]"}]& )], "mtd" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"}, 
    "SpinorMutDown", DisplayFunction -> (RowBox[{
       SubscriptBox[
        OverscriptBox["\[Mu]", "~"], #2], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorDot", "[", #, "]", "[", "$mu", "]", "[", "Null", "]", 
       "[", #2, "]"}]& )], "ltp" -> 
  TemplateBox[{"\[SelectionPlaceholder]"}, "SpinorDotBareL", 
    DisplayFunction -> (RowBox[{
       OverscriptBox["\[Lambda]", "~"], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorDotBare", "[", #, "]", "[", "$lam", "]"}]& )], "mtp" -> 
  TemplateBox[{"\[SelectionPlaceholder]"}, "SpinorDotBareM", 
    DisplayFunction -> (RowBox[{
       OverscriptBox["\[Mu]", "~"], "[", #, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"SpinorDotBare", "[", #, "]", "[", "$mu", "]"}]& )], "ab" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[Placeholder]"}, 
    "SpinorAngleBracket", DisplayFunction -> (RowBox[{"\[LeftAngleBracket]", 
       RowBox[{#, "\[MediumSpace]", #2}], "\[RightAngleBracket]"}]& ), 
    InterpretationFunction -> (RowBox[{"SpinorAngleBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], "sb" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[Placeholder]"}, 
    "SpinorSquareBracket", DisplayFunction -> (RowBox[{"[", 
       RowBox[{#, "\[MediumSpace]", #2}], "]"}]& ), 
    InterpretationFunction -> (RowBox[{"SpinorSquareBracket", "[", 
       RowBox[{#, ",", #2}], "]"}]& )], "cas" -> 
  TemplateBox[{"\[SelectionPlaceholder]", 
     RowBox[{"{", "\[SelectionPlaceholder]", "}"}], 
     "\[SelectionPlaceholder]"}, "AngleSquareChain", 
    DisplayFunction -> (RowBox[{"\[LeftAngleBracket]", #, #2, #3, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$square",
        "]"}]& )], "csa" -> TemplateBox[{"\[SelectionPlaceholder]", 
     RowBox[{"{", "\[SelectionPlaceholder]", "}"}], 
     "\[SelectionPlaceholder]"}, "SquareAngleChain", 
    DisplayFunction -> (RowBox[{"[", #, #2, #3, "\[RightAngleBracket]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"Chain", "[", "$square", ",", #, ",", #2, ",", #3, ",", "$angle",
        "]"}]& )], "caa" -> TemplateBox[{"\[SelectionPlaceholder]", 
     RowBox[{"{", "\[SelectionPlaceholder]", "}"}], 
     "\[SelectionPlaceholder]"}, "AngleAngleChain", 
    DisplayFunction -> (
     RowBox[{"\[LeftAngleBracket]", #, #2, #3, "\[RightAngleBracket]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"Chain", "[", "$angle", ",", #, ",", #2, ",", #3, ",", "$angle", 
       "]"}]& )], "css" -> TemplateBox[{"\[SelectionPlaceholder]", 
     RowBox[{"{", "\[SelectionPlaceholder]", "}"}], 
     "\[SelectionPlaceholder]"}, "SquareSquareChain", 
    DisplayFunction -> (RowBox[{"[", #, #2, #3, "]"}]& ), 
    InterpretationFunction -> (
     RowBox[{"Chain", "[", "$square", ",", #, ",", #2, ",", #3, ",", 
       "$square", "]"}]& )], "lcup" -> 
  TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"}, 
    "LevicivitaSHUp", DisplayFunction -> (SuperscriptBox["\[Epsilon]", 
      RowBox[{#, #2}]]& ), 
    InterpretationFunction -> (
     RowBox[{"LeviCivitaSH", "[", #, ",", #2, "]", "[", "$up", "]"}]& )], 
  "lcd" -> TemplateBox[{"\[SelectionPlaceholder]", "\[SelectionPlaceholder]"},
     "LevicivitaSHDown", DisplayFunction -> (SubscriptBox["\[Epsilon]", 
      RowBox[{#, #2}]]& ), 
    InterpretationFunction -> (
     RowBox[{"LeviCivitaSH", "[", #, ",", #2, "]", "[", "$down", "]"}]& )]|>,
FrontEndVersion->"13.0 for Microsoft Windows (64-bit) (December 2, 2021)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"a1e96281-505b-4b40-b0ec-5da2e232b756"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 207, 3, 28, "Input",ExpressionUUID->"d6fe2690-3bb1-4185-bbe3-4aaa9884d5a0"],
Cell[CellGroupData[{
Cell[812, 29, 255, 5, 22, "Print",ExpressionUUID->"b051dbcd-5b56-46f7-85df-1c8aa6229f67"],
Cell[1070, 36, 241, 4, 22, "Print",ExpressionUUID->"1c148b9f-52be-4134-8adc-d6d4d634d1da"],
Cell[1314, 42, 231, 4, 22, "Print",ExpressionUUID->"e309b2f9-1fd1-4a78-a9a4-82369b7d1dd9"],
Cell[1548, 48, 232, 4, 22, "Print",ExpressionUUID->"170db4b4-8211-4507-89da-7de3a3fdb5ff"],
Cell[1783, 54, 240, 4, 22, "Print",ExpressionUUID->"831272e8-ac68-47f2-ada4-75bb42c3a29d"],
Cell[2026, 60, 313, 8, 26, "Print",ExpressionUUID->"9eb8dea0-c0eb-4338-948f-cf4562a610cd"],
Cell[2342, 70, 249, 4, 22, "Print",ExpressionUUID->"b5f45e9a-a006-4fb5-a6ea-eb2cc8c54c0b"]
}, Open  ]]
}, Open  ]],
Cell[2618, 78, 570, 11, 48, "Input",ExpressionUUID->"02c4f47a-3eb8-4cd8-b56e-c8533ab5fc1c"],
Cell[CellGroupData[{
Cell[3213, 93, 195, 3, 54, "Subsection",ExpressionUUID->"edf98337-ab27-47ed-b5f8-8f4cdbbd88f4"],
Cell[CellGroupData[{
Cell[3433, 100, 125, 0, 45, "Subsubsection",ExpressionUUID->"1671c2bc-3b8a-40cc-8ee2-4861c0d72a17"],
Cell[3561, 102, 32350, 753, 1957, "Code",ExpressionUUID->"97374bfc-e53b-4f4a-b255-9672d8b15c35"]
}, Closed]],
Cell[CellGroupData[{
Cell[35948, 860, 104, 0, 37, "Subsubsection",ExpressionUUID->"59329f6d-75d4-4f84-93c9-ac1a75c7a431"],
Cell[36055, 862, 269, 5, 35, "Code",ExpressionUUID->"e58a951a-3e30-482e-9134-44521eb7f750"],
Cell[36327, 869, 1285, 34, 150, "Code",ExpressionUUID->"c8b00316-3d52-4b53-a95e-d5d1ddf5a4a2"],
Cell[37615, 905, 6250, 180, 150, "Code",ExpressionUUID->"4f0cc8e6-0b1d-4541-837f-6f9548ca20be"],
Cell[43868, 1087, 15114, 411, 381, "Code",ExpressionUUID->"07712056-91ae-4555-9a62-30f79752c746"],
Cell[58985, 1500, 26588, 623, 1881, "Code",ExpressionUUID->"4cd78243-28f0-48c3-9354-bd9eb98b7a59"]
}, Closed]],
Cell[CellGroupData[{
Cell[85610, 2128, 90, 0, 37, "Subsubsection",ExpressionUUID->"c9e5a0c5-3410-4589-8250-77b3e73053e9"],
Cell[85703, 2130, 6528, 154, 568, "Code",ExpressionUUID->"550f8374-f490-49c9-890c-8210637f6f5f"]
}, Closed]],
Cell[CellGroupData[{
Cell[92268, 2289, 87, 0, 37, "Subsubsection",ExpressionUUID->"691d3b74-b5e8-4f5d-9df7-57064d7387fc"],
Cell[92358, 2291, 367, 10, 55, "Code",ExpressionUUID->"9f9b6008-030f-4b30-bc53-082e67570786"],
Cell[92728, 2303, 1569, 38, 264, "Code",ExpressionUUID->"88b719d3-07af-433f-8acb-a220f0a893a9"]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[94346, 2347, 161, 3, 38, "Subsection",ExpressionUUID->"5cb88fc9-3da6-4eb3-8874-9a48338fb3de"],
Cell[94510, 2352, 15964, 370, 1427, "Input",ExpressionUUID->"ba6287bc-50e6-419f-84d2-90f26483d92d"],
Cell[CellGroupData[{
Cell[110499, 2726, 2765, 62, 29, "Input",ExpressionUUID->"ba3f9ba6-bfbe-4ccd-9234-e701af655803"],
Cell[113267, 2790, 2181, 55, 74, "Output",ExpressionUUID->"d7a7aaa4-9e21-48e4-9ed1-18ef1e89ce23"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[115497, 2851, 220, 4, 38, "Subsection",ExpressionUUID->"6ce3182f-5b23-4073-9124-f454d656bbcb"],
Cell[115720, 2857, 34197, 781, 2541, "Input",ExpressionUUID->"a85f2d44-0fa4-45e2-b100-951bcc12a0cc"],
Cell[CellGroupData[{
Cell[149942, 3642, 2770, 63, 29, "Input",ExpressionUUID->"92931acd-c407-4adf-b3d5-357469dad063"],
Cell[152715, 3707, 2598, 55, 54, "Output",ExpressionUUID->"d6625037-8bbe-4fc5-8af8-79538087e9dc"]
}, Open  ]],
Cell[CellGroupData[{
Cell[155350, 3767, 355, 8, 29, "Input",ExpressionUUID->"a94ee9cf-19ce-4daf-8e1d-d879f660293a"],
Cell[155708, 3777, 220, 4, 33, "Output",ExpressionUUID->"d410ff37-5556-41ee-a545-713ea2c70da8"]
}, Open  ]],
Cell[CellGroupData[{
Cell[155965, 3786, 437, 11, 29, "Input",ExpressionUUID->"f8cb976b-03fb-4507-82b4-8406e83c1849"],
Cell[156405, 3799, 195, 3, 33, "Output",ExpressionUUID->"81a477e6-0c19-481d-b47b-8d2dc3ca918c"]
}, Open  ]],
Cell[CellGroupData[{
Cell[156637, 3807, 450, 12, 29, "Input",ExpressionUUID->"7b01f067-c0ac-4b49-85d7-377ea4976069"],
Cell[157090, 3821, 278, 6, 33, "Output",ExpressionUUID->"71fe96c1-3145-43df-b57d-328ea63575f1"]
}, Open  ]],
Cell[CellGroupData[{
Cell[157405, 3832, 491, 13, 29, "Input",ExpressionUUID->"2cb4e89e-20ec-4447-8380-90bd7c60b4bc"],
Cell[157899, 3847, 250, 5, 33, "Output",ExpressionUUID->"5fa58c5e-9741-4868-8064-5ae5a7d89397"]
}, Open  ]],
Cell[CellGroupData[{
Cell[158186, 3857, 332, 8, 29, "Input",ExpressionUUID->"f5c84b15-f36b-432f-a857-db008503701c"],
Cell[158521, 3867, 173, 2, 33, "Output",ExpressionUUID->"10b16e63-0701-4556-80cf-f5798bbc7930"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[158743, 3875, 371, 7, 38, "Subsection",ExpressionUUID->"e9d95bbe-a245-4546-ab91-3b551c64daa4"],
Cell[159117, 3884, 349, 9, 29, "Input",ExpressionUUID->"abe71767-4bd5-4acb-ad61-dfe1ec985742"],
Cell[159469, 3895, 36365, 827, 2784, "Input",ExpressionUUID->"d9c46fa1-22be-4264-9fda-3f0631cd3809"],
Cell[CellGroupData[{
Cell[195859, 4726, 2770, 63, 29, "Input",ExpressionUUID->"c71c2964-1f0e-459b-a3d5-2ae4ac4902d4"],
Cell[198632, 4791, 3564, 71, 51, "Output",ExpressionUUID->"eca2e6c6-ca74-4bb6-a078-203b3a2698bf"]
}, Open  ]],
Cell[202211, 4865, 2643, 61, 29, "Input",ExpressionUUID->"594a690f-3a09-4e5d-8e3f-6cb678b80b63"],
Cell[CellGroupData[{
Cell[204879, 4930, 431, 12, 29, "Input",ExpressionUUID->"757222ce-073f-4b86-8e34-60b0af19d556"],
Cell[205313, 4944, 230, 5, 33, "Output",ExpressionUUID->"7c5ba756-9c36-49da-937a-4f01786b113d"]
}, Open  ]],
Cell[CellGroupData[{
Cell[205580, 4954, 486, 13, 29, "Input",ExpressionUUID->"fdc01fda-42b3-4302-a3c2-fbe3b9063ba2"],
Cell[206069, 4969, 261, 6, 33, "Output",ExpressionUUID->"b3b442fd-6d5c-4b28-bfc5-d9a386733d8e"]
}, Open  ]],
Cell[206345, 4978, 363, 8, 50, "Input",ExpressionUUID->"fc6b4642-44e5-4721-99a5-aa7ffcccc7bb"]
}, Closed]],
Cell[CellGroupData[{
Cell[206745, 4991, 351, 5, 38, "Subsection",ExpressionUUID->"00bcdd66-eed0-4157-bed7-04ef14501218"],
Cell[207099, 4998, 390, 8, 29, "Input",ExpressionUUID->"84959906-c38f-4b6e-a23c-1015a0668f45"],
Cell[207492, 5008, 44299, 1012, 3168, "Input",ExpressionUUID->"d03a6935-ab96-4201-b6a0-67a4e93e08ce"],
Cell[CellGroupData[{
Cell[251816, 6024, 2821, 64, 29, "Input",ExpressionUUID->"59659eae-029e-498c-bd5d-ae5fc0efbef5"],
Cell[254640, 6090, 4021, 78, 74, "Output",ExpressionUUID->"ae64e6b0-b362-41a1-bdff-894b9b7fdfe1"]
}, Open  ]],
Cell[258676, 6171, 2643, 61, 29, "Input",ExpressionUUID->"8e855dc2-fa4c-4d99-a710-f6027d1532a6"],
Cell[CellGroupData[{
Cell[261344, 6236, 482, 13, 29, "Input",ExpressionUUID->"95553f6b-bcbf-41f0-adbc-b73f11d7c5b5"],
Cell[261829, 6251, 283, 7, 33, "Output",ExpressionUUID->"a2df510e-138d-4cf1-ac04-43896001a7fc"]
}, Open  ]],
Cell[CellGroupData[{
Cell[262149, 6263, 534, 13, 29, "Input",ExpressionUUID->"448e777a-ebee-4dcf-8a58-03286bb7d0e6"],
Cell[262686, 6278, 310, 7, 33, "Output",ExpressionUUID->"104c8358-9c87-4a16-b5aa-78df5a3537d4"]
}, Open  ]],
Cell[263011, 6288, 363, 8, 50, "Input",ExpressionUUID->"24aa8053-3b2a-43ba-b63c-49ec63419239"],
Cell[CellGroupData[{
Cell[263399, 6300, 2732, 62, 50, "Input",ExpressionUUID->"1eabf1d2-1c36-476b-abc9-e25d6be5db48"],
Cell[266134, 6364, 2144, 55, 54, "Output",ExpressionUUID->"760e189e-7d3e-4a6b-ae42-d3e0ced93e75"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[268327, 6425, 359, 6, 38, "Subsection",ExpressionUUID->"cc73b313-c20a-40ca-a8f5-6a296e03e20b"],
Cell[268689, 6433, 219, 4, 28, "Input",ExpressionUUID->"0f31a181-1666-4060-8076-553724c12f1b"],
Cell[CellGroupData[{
Cell[268933, 6441, 416, 9, 28, "Input",ExpressionUUID->"ce725442-8380-448d-87b9-b5c2e12f8cfe"],
Cell[269352, 6452, 238, 6, 32, "Output",ExpressionUUID->"96e5a456-6c3b-407d-9088-f9be861f9394"]
}, Open  ]],
Cell[269605, 6461, 51825, 1154, 3436, "Input",ExpressionUUID->"a02e73ac-140b-4e5c-872a-94d8143d2c7a"],
Cell[CellGroupData[{
Cell[321455, 7619, 3145, 70, 48, "Input",ExpressionUUID->"68ac1932-0c81-4c3c-86e0-a3f493c530b1"],
Cell[324603, 7691, 4391, 83, 53, "Output",ExpressionUUID->"68c986cc-3e8b-4612-81ef-1f1c27fec809"]
}, Open  ]],
Cell[329009, 7777, 82, 0, 28, "Input",ExpressionUUID->"625859a5-044e-4e1a-ab83-a0152b3507d0"],
Cell[329094, 7779, 2643, 61, 28, "Input",ExpressionUUID->"7e73e989-6490-4df5-905b-b391efd90356"],
Cell[CellGroupData[{
Cell[331762, 7844, 482, 13, 28, "Input",ExpressionUUID->"2c37cfaa-3563-4344-b309-b66a416750c9"],
Cell[332247, 7859, 283, 7, 32, "Output",ExpressionUUID->"33506d1e-6cb1-400a-a0b1-4d7de88dd436"]
}, Open  ]],
Cell[CellGroupData[{
Cell[332567, 7871, 534, 13, 28, "Input",ExpressionUUID->"049c0084-c987-4cb4-b91f-94d2978654d9"],
Cell[333104, 7886, 310, 7, 32, "Output",ExpressionUUID->"646507d1-f20d-47e2-974b-7386916099fc"]
}, Open  ]],
Cell[333429, 7896, 363, 8, 28, "Input",ExpressionUUID->"730923a7-7e32-43f8-b232-0f22fad87378"],
Cell[CellGroupData[{
Cell[333817, 7908, 2732, 62, 28, "Input",ExpressionUUID->"2446e460-e370-4a2e-bfb3-0fd53f148491"],
Cell[336552, 7972, 2144, 55, 54, "Output",ExpressionUUID->"6841052b-9405-4ce6-98c1-76fffa98f50c"]
}, Open  ]],
Cell[CellGroupData[{
Cell[338733, 8032, 3893, 89, 48, "Input",ExpressionUUID->"0bc5ab8b-8ed6-4346-a248-c96e98fc9f0a"],
Cell[342629, 8123, 3905, 87, 52, "Output",ExpressionUUID->"1fe43c5c-6e49-486f-879d-2164f2338b76"]
}, Open  ]],
Cell[CellGroupData[{
Cell[346571, 8215, 207, 3, 28, "Input",ExpressionUUID->"d2b69faa-7951-4c99-a555-6b7504cb8afd"],
Cell[346781, 8220, 1862, 45, 52, "Output",ExpressionUUID->"84d4c06c-f752-47a8-ae1e-12eea6254d68"]
}, Open  ]],
Cell[CellGroupData[{
Cell[348680, 8270, 853, 22, 86, "Input",ExpressionUUID->"5a0bec93-8cf9-4af2-881e-792eb4a92832"],
Cell[349536, 8294, 1630, 39, 52, "Output",ExpressionUUID->"76942040-55f3-46b1-8cdc-670a0bf82eb3"],
Cell[351169, 8335, 2182, 52, 52, "Output",ExpressionUUID->"e5a34af9-f955-40fc-9a5f-c40b8d495b57"],
Cell[353354, 8389, 1914, 46, 52, "Output",ExpressionUUID->"f91a8cd1-ebbb-4e58-94ce-d0d830f3e58f"],
Cell[355271, 8437, 1628, 39, 52, "Output",ExpressionUUID->"353987f6-ae53-407d-b747-5e2d34480aa6"]
}, Open  ]],
Cell[CellGroupData[{
Cell[356936, 8481, 3892, 89, 48, "Input",ExpressionUUID->"252437e6-f759-48cb-929d-6a0882e9a085"],
Cell[360831, 8572, 3928, 87, 52, "Output",ExpressionUUID->"447dd015-2322-437e-91cc-b45ef55321cb"]
}, Open  ]],
Cell[CellGroupData[{
Cell[364796, 8664, 206, 3, 28, "Input",ExpressionUUID->"47782f8d-712c-47ca-aa18-8fca0406a660"],
Cell[365005, 8669, 1881, 45, 52, "Output",ExpressionUUID->"af5cc210-5786-4ebe-b895-c3efff4943ec"]
}, Open  ]],
Cell[CellGroupData[{
Cell[366923, 8719, 901, 23, 86, "Input",ExpressionUUID->"4d662cb4-936f-4e3c-b151-b4c89a3a221a"],
Cell[367827, 8744, 1968, 47, 52, "Output",ExpressionUUID->"58148089-cc83-4c94-843c-333e0acfd1f5"],
Cell[369798, 8793, 2209, 53, 52, "Output",ExpressionUUID->"8b9c15f3-e06b-4907-92de-d8d720bf4783"],
Cell[372010, 8848, 1942, 47, 52, "Output",ExpressionUUID->"6c50df05-94d9-45a2-9dd9-487020f52142"],
Cell[373955, 8897, 1658, 40, 52, "Output",ExpressionUUID->"6545ed12-67e1-4a64-b3af-c4074bd50025"]
}, Open  ]]
}, Open  ]]
}
]
*)

